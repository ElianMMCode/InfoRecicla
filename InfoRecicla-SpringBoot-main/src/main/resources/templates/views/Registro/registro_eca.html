<!doctype html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Registrar Punto ECA - InfoRecicla</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-light bg-light">
    <div class="container">
        <a class="navbar-brand" href="/static">InfoRecicla</a>
    </div>
</nav>

<div class="bg-success d-flex flex-column justify-content-center flex-grow-1 py-5">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-12 col-xl-10">
                <div class="card shadow">
                    <div class="card-header bg-success text-white text-center">
                        <h5 class="mb-0">Registrar Punto ECA</h5>
                    </div>
                    <div class="card-body">
                        <form method="POST" action="/registro/eca" id="ecaForm" novalidate enctype="multipart/form-data" class="vstack gap-4">
                            <input type="hidden" name="tipo" value="GestorECA">
                            <input type="hidden" name="account_type" value="eca">

                            <p class="small text-success fw-bold mb-1">Datos de cuenta</p>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label for="correo" class="form-label small fw-semibold">Correo electrónico (acceso)</label>
                                    <input type="email" class="form-control form-control-sm" id="correo" name="correo" required>
                                </div>
                                <div class="col-md-3">
                                    <label for="password" class="form-label small fw-semibold">Contraseña</label>
                                    <input type="password" class="form-control form-control-sm" id="password" name="password" minlength="8" maxlength="64" required>
                                </div>
                                <div class="col-md-3">
                                    <label for="password_confirmation" class="form-label small fw-semibold">Confirmar</label>
                                    <input type="password" class="form-control form-control-sm" id="password_confirmation" name="password_confirmation" required>
                                </div>
                            </div>

                            <p class="small text-success fw-bold mb-1 mt-2">Datos del gestor (propietario del punto)</p>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label for="nombre" class="form-label small fw-semibold">Nombres</label>
                                    <input type="text" class="form-control form-control-sm" id="nombre" name="nombre" required>
                                </div>
                                <div class="col-md-6">
                                    <label for="apellido" class="form-label small fw-semibold">Apellidos</label>
                                    <input type="text" class="form-control form-control-sm" id="apellido" name="apellido" required>
                                </div>
                                <div class="col-md-4">
                                    <label for="tipoDocumento" class="form-label small fw-semibold">Tipo de documento</label>
                                    <select id="tipoDocumento" name="tipoDocumento" class="form-select form-select-sm" required>
                                        <option value="" disabled selected>Selecciona...</option>
                                        <option value="Cédula de Ciudadanía">Cédula de Ciudadanía</option>
                                        <option value="Cédula de Extranjería">Cédula de Extranjería</option>
                                        <option value="Tarjeta de Identidad">Tarjeta de Identidad</option>
                                        <option value="Pasaporte">Pasaporte</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label for="numeroDocumento" class="form-label small fw-semibold">Número de documento</label>
                                    <input type="text" class="form-control form-control-sm" id="numeroDocumento" name="numeroDocumento" minlength="5" maxlength="20" required>
                                </div>
                            </div>

                            <p class="small text-success fw-bold mb-1 mt-2">Información de la estación</p>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label for="nombrePunto" class="form-label small fw-semibold">Nombre del Punto ECA</label>
                                    <input type="text" class="form-control form-control-sm" id="nombrePunto" name="nombrePunto" required>
                                </div>
                                <div class="col-md-3">
                                    <label for="nit" class="form-label small fw-semibold">NIT (opcional)</label>
                                    <input type="text" class="form-control form-control-sm" id="nit" name="nit" maxlength="20" placeholder="Si aplica">
                                </div>
                            </div>

                            <div class="row g-3 mt-1">
                                <div class="col-md-6">
                                    <label for="horarioAtencion" class="form-label small fw-semibold">Horario de atención (opcional)</label>
                                    <input type="text" class="form-control form-control-sm" id="horarioAtencion" name="horarioAtencion" placeholder="Lun-Vie 8:00–17:00, Sáb 9:00–13:00">
                                </div>
                            </div>

                            <div class="row g-3 mt-1">
                                <div class="col-md-6">
                                    <label for="correoPunto" class="form-label small fw-semibold">Correo de contacto del punto</label>
                                    <input type="email" class="form-control form-control-sm" id="correoPunto" name="correoPunto" placeholder="Puede ser distinto al de acceso" required>
                                </div>
                                <div class="col-md-6">
                                    <label for="telefonoPunto" class="form-label small fw-semibold">Teléfono de contacto del punto</label>
                                    <input type="tel" class="form-control form-control-sm" id="telefonoPunto" name="telefonoPunto" inputmode="tel" pattern="^\d{10}$" maxlength="10" placeholder="Ej: 3XXXXXXXXX" required>
                                </div>
                            </div>

                            <div class="row g-3 mt-1">
                                <div class="col-md-6">
                                    <label for="direccionPunto" class="form-label small fw-semibold">Dirección del punto</label>
                                    <input type="text" class="form-control form-control-sm" id="direccionPunto" name="direccionPunto" required>
                                </div>
                                <div class="col-md-3">
                                    <label for="ciudad" class="form-label small fw-semibold">Ciudad</label>
                                    <select id="ciudad" name="ciudad" class="form-select form-select-sm" required>
                                        <option value="" disabled selected>Selecciona...</option>
                                        <option value="Bogotá">Bogotá</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label for="localidadPunto" class="form-label small fw-semibold">Localidad</label>
                                    <select id="localidadPunto" name="localidadPunto" class="form-select form-select-sm" required>
                                        <option value="" disabled selected>Selecciona localidad...</option>
                                        <option>Usaquén</option>
                                        <option>Chapinero</option>
                                        <option>Santa Fe</option>
                                        <option>San Cristóbal</option>
                                        <option>Usme</option>
                                        <option>Tunjuelito</option>
                                        <option>Bosa</option>
                                        <option>Kennedy</option>
                                        <option>Fontibón</option>
                                        <option>Engativá</option>
                                        <option>Suba</option>
                                        <option>Barrios Unidos</option>
                                        <option>Teusaquillo</option>
                                        <option>Los Mártires</option>
                                        <option>Antonio Nariño</option>
                                        <option>Puente Aranda</option>
                                        <option>La Candelaria</option>
                                        <option>Rafael Uribe</option>
                                        <option>Ciudad Bolívar</option>
                                        <option>Sumapaz</option>
                                    </select>
                                </div>
                            </div>

                            <div class="mt-2">
                                <label class="form-label small fw-semibold mb-1">Ubicación (opcional)</label>
                                <div class="row g-2 align-items-start">
                                    <div class="col-12 col-md-4">
                                        <div class="input-group input-group-sm">
                                            <span class="input-group-text">Lat</span>
                                            <input type="text" class="form-control" id="latitudVisible" placeholder="Ej: 4.609710">
                                        </div>
                                    </div>
                                    <div class="col-12 col-md-4">
                                        <div class="input-group input-group-sm">
                                            <span class="input-group-text">Lng</span>
                                            <input type="text" class="form-control" id="longitudVisible" placeholder="Ej: -74.081749">
                                        </div>
                                    </div>
                                    <div class="col-12 col-md-4 d-grid d-md-block">
                                        <button type="button" id="geoBtn" class="btn btn-outline-success btn-sm w-100">GPS</button>
                                    </div>
                                </div>
                                <div id="locationDisplay" class="form-text mt-1">Pulsa GPS para solicitar permiso al navegador y capturar tu ubicación precisa.</div>
                                <input type="hidden" id="latitud" name="latitud">
                                <input type="hidden" id="longitud" name="longitud">
                            </div>

                            <div class="row g-3 mt-1">
                                <div class="col-md-6">
                                    <label for="logo" class="form-label small fw-semibold">Logo del punto (opcional)</label>
                                    <input type="file" class="form-control form-control-sm" id="logo" name="logo" accept="image/*">
                                </div>
                                <div class="col-md-6">
                                    <label for="foto" class="form-label small fw-semibold">Foto del punto (opcional)</label>
                                    <input type="file" class="form-control form-control-sm" id="foto" name="foto" accept="image/*">
                                </div>
                                <div class="col-md-6">
                                    <label for="sitioWeb" class="form-label small fw-semibold">Sitio web (opcional)</label>
                                    <input type="url" class="form-control form-control-sm" id="sitioWeb" name="sitioWeb" placeholder="https://">
                                </div>
                            </div>

                            <div class="form-check mt-3">
                                <input class="form-check-input" type="checkbox" value="1" id="mostrarMapa" name="mostrarMapa" required>
                                <label class="form-check-label small" for="mostrarMapa">Mostrar el punto en el mapa público cuando sea aprobado.</label>
                            </div>
                            <div class="form-check mt-2">
                                <input class="form-check-input" type="checkbox" value="1" id="recibeNotificaciones" name="recibeNotificaciones" required>
                                <label class="form-check-label small" for="recibeNotificaciones">Deseo recibir notificaciones (aprobaciones, comentarios, etc.).</label>
                            </div>
                            <div class="form-check mt-2">
                                <input class="form-check-input" type="checkbox" value="1" id="terms" required>
                                <label class="form-check-label small" for="terms">Acepto los términos y condiciones y el tratamiento de datos.</label>
                                <div class="invalid-feedback">Debes aceptar los términos para continuar.</div>
                            </div>
                            <div class="d-grid mt-3">
                                <button type="submit" class="btn btn-success">Registrar Punto ECA</button>
                            </div>
                            <p class="text-center mt-3 mb-0 small">¿Ya tienes cuenta? <a href="/login">Inicia sesión</a></p>
                        </form>
                    </div>
                    <div class="card-footer text-center small text-muted">InfoRecicla · Registro Punto ECA</div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Se incluyen funciones JS para la geolocalización y validación (extraídas y adaptadas del Blade)
(function() {
    const btn = document.getElementById('geoBtn');
    if (!btn) return;
    const latH = document.getElementById('latitud');
    const lngH = document.getElementById('longitud');
    const latV = document.getElementById('latitudVisible');
    const lngV = document.getElementById('longitudVisible');
    const display = document.getElementById('locationDisplay');
    let busy = false;
    let watchId = null;

    function feedback(msg, type = 'muted') {
        display.className = `form-text mt-1 text-${type}`;
        display.textContent = msg;
    }

    function setBusy(s) {
        busy = s;
        btn.disabled = s;
        btn.textContent = s ? 'Obteniendo…' : 'GPS';
    }

    function write(lat, lng) {
        if (lat == null || lng == null) return;
        lat = Number(lat);
        lng = Number(lng);
        if (isNaN(lat) || isNaN(lng)) return;
        latH.value = lat.toFixed(6);
        lngH.value = lng.toFixed(6);
        latV.value = latH.value;
        lngV.value = lngH.value;
    }

    function secureCheck() {
        if (isSecureContext) return true;
        const host = location.hostname;
        if (host === 'localhost' || host === '127.0.0.1') return true;
        feedback('El navegador exige HTTPS para geolocalización. Usa https:// o localhost.', 'danger');
        return false;
    }

    function clearWatch() {
        if (watchId != null) {
            navigator.geolocation.clearWatch(watchId);
            watchId = null;
        }
    }

    function startWatchFallback() {
        if (!('geolocation' in navigator)) return;
        feedback('Intentando actualización continua (watchPosition)…', 'warning');
        let gotFirst = false;
        watchId = navigator.geolocation.watchPosition(
            pos => {
                const { latitude, longitude, accuracy } = pos.coords;
                if (!gotFirst) {
                    gotFirst = true;
                    write(latitude, longitude);
                    feedback('Ubicación obtenida (watch). Precisión ~' + Math.round(accuracy) + 'm.', 'success');
                    setBusy(false);
                    setTimeout(() => clearWatch(), 5000);
                } else if (accuracy < 25) {
                    write(latitude, longitude);
                    feedback('Precisión refinada (' + Math.round(accuracy) + 'm).', 'success');
                }
            },
            err => {
                feedback('No fue posible obtener ubicación con watch (' + err.code + ').', 'danger');
                setBusy(false);
                clearWatch();
            }, { enableHighAccuracy: true, maximumAge: 0, timeout: 15000 }
        );
    }

    function attemptPrecise() {
        if (!('geolocation' in navigator)) {
            feedback('Este navegador no soporta geolocalización.', 'danger');
            return;
        }
        if (!secureCheck()) return;
        setBusy(true);
        feedback('Solicitando permiso al navegador…');
        let finished = false;
        const timer = setTimeout(() => {
            if (finished) return;
            feedback('Sin respuesta rápida, escalando a modo continuo…', 'warning');
            startWatchFallback();
        }, 4000);
        navigator.geolocation.getCurrentPosition(
            pos => {
                if (finished) return;
                finished = true;
                clearTimeout(timer);
                const { latitude, longitude, accuracy } = pos.coords;
                write(latitude, longitude);
                feedback('Ubicación capturada (±' + Math.round(accuracy) + 'm).', 'success');
                setBusy(false);
            },
            err => {
                if (finished) return;
                finished = true;
                clearTimeout(timer);
                const map = { 1: 'Permiso denegado por el usuario', 2: 'Posición no disponible', 3: 'Tiempo de espera agotado' };
                feedback((map[err.code] || 'Error desconocido') + (err.code === 1 ? ' (ajusta permisos del sitio y reintenta)' : ''), 'danger');
                if (err.code !== 1) { startWatchFallback(); } else { setBusy(false); }
            }, { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
        );
    }

    btn.addEventListener('click', async () => {
        if (busy) return;
        attemptPrecise();
    });

    [latV, lngV].forEach(inp => inp.addEventListener('blur', () => {
        const v = inp.value.trim();
        if (/^[-]?\d{1,3}\.\d+$/.test(v)) {
            if (inp === latV) latH.value = v; else lngH.value = v;
            feedback('Coordenadas manuales establecidas.', 'info');
        }
    }));
})();

(function() {
    const form = document.getElementById('ecaForm');
    if (!form) return;
    const correo = document.getElementById('correo');
    const pwd = document.getElementById('password');
    const pwd2 = document.getElementById('password_confirmation');
    const terms = document.getElementById('terms');
    const tel = document.getElementById('telefonoPunto');

    function invalidate(field, msg) {
        field.classList.add('is-invalid');
        let fb = field.parentElement.querySelector('.invalid-feedback');
        if (!fb) { fb = document.createElement('div'); fb.className = 'invalid-feedback'; field.parentElement.appendChild(fb); }
        if (msg) fb.textContent = msg;
    }

    function clear(field) { field.classList.remove('is-invalid'); }

    function validEmail() { clear(correo); if (!/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(correo.value)) { invalidate(correo, 'Correo no válido.'); return false; } return true; }

    function validPwd() { clear(pwd); clear(pwd2); if (pwd.value.length < 8) { invalidate(pwd, 'Mínimo 8 caracteres.'); return false; } if (pwd.value !== pwd2.value) { invalidate(pwd2, 'No coincide.'); return false; } return true; }

    function validTel() { if (!tel.value) return true; clear(tel); if (!/^[0-9\s()+-]{7,20}$/.test(tel.value)) { invalidate(tel, 'Teléfono inválido.'); return false; } return true; }

    function validTerms() { terms.classList.remove('is-invalid'); if (!terms.checked) { terms.classList.add('is-invalid'); return false; } return true; }

    correo.addEventListener('blur', validEmail);
    pwd.addEventListener('input', validPwd);
    pwd2.addEventListener('input', validPwd);
    tel.addEventListener('blur', validTel);
    terms.addEventListener('change', validTerms);

    form.addEventListener('submit', e => {
        let ok = form.checkValidity();
        if (!validEmail()) ok = false;
        if (!validPwd()) ok = false;
        if (!validTel()) ok = false;
        if (!validTerms()) ok = false;
        if (!ok) { e.preventDefault(); e.stopPropagation(); }
        form.classList.add('was-validated');
    });
})();
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
