<!-- Fragment: Materiales -->
<section th:fragment="materiales" class="py-4"
         th:data-gestor="${gestor}"
         th:data-usuario-id="${usuario.usuarioId}">
    <!-- T√≠tulo principal -->
    <div class="mb-4">
        <h2 class="h4 fw-bold text-dark mb-1">
            <i class="bi bi-box-seam me-2"></i>Gesti√≥n de Materiales
        </h2>
        <p class="text-muted small mb-0">Registra, visualiza y gestiona los materiales en el inventario del centro de acopio</p>
    </div>

    <!-- ACORDE√ìN PRINCIPAL CON TODO -->
    <div class="accordion accordion-flush shadow-sm" id="acordeonMateriales">

        <!--/*@thymesVar id="inventario" type="org.sena.inforecicla.dto.puntoEca.inventario.InventarioResponseDTO"*/-->
        <!-- Item 1: AGREGAR MATERIAL AL INVENTARIO -->
        <div class="accordion-item border-start border-5 border-success">
            <h2 class="accordion-header" id="headingAgregar">
                <button class="accordion-button fw-bold collapsed" type="button"
                        data-bs-toggle="collapse" data-bs-target="#collapseAgregar" aria-expanded="false"
                        aria-controls="collapseAgregar">
                    <span class="bg-success p-2 rounded-circle me-3" style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">
                        <i class="bi bi-plus-circle text-white"></i>
                    </span>
                    <span>
                        <span class="fw-bold text-dark d-block">Agregar Material al Inventario</span>
                        <small class="text-muted fw-normal">Registra nuevos materiales en tu inventario</small>
                    </span>
                </button>
            </h2>
            <div id="collapseAgregar" class="accordion-collapse collapse" aria-labelledby="headingAgregar"
                 data-bs-parent="#acordeonMateriales">
                <div class="accordion-body p-4 bg-light">
                    <!-- Barra de b√∫squeda principal -->
                    <div class="row g-3 mb-4">
                        <div class="col-12">
                            <label class="form-label fw-semibold text-muted mb-1" for="buscarMaterialInput">Buscar Material</label>
                            <div class="input-group input-group-lg flex-nowrap">
                                <span class="input-group-text bg-light border-2 border-success">
                                    <i class="bi bi-search text-success"></i>
                                </span>
                                <input id="buscarMaterialInput" type="text" class="form-control form-control-lg border-2 border-success"
                                       placeholder="Nombre, c√≥digo, categor√≠a..." aria-label="Buscar material">
                            </div>
                        </div>
                    </div>

                    <!-- Radios de categor√≠a -->
                    <div class="row g-3 mb-3">
                        <div class="col-12">
                            <span class="form-label fw-semibold text-muted d-block mb-2">Categor√≠a</span>
                            <div class="btn-group flex-wrap gap-2" role="group" aria-label="Filtro categor√≠a">
                                <input type="radio" class="btn-check" name="radioCategoriaBusqueda" id="radioCategoriaNone" value="" autocomplete="off" checked>
                                <label class="btn btn-outline-success" for="radioCategoriaNone">Ninguno</label>
                                <th:block th:if="${not #lists.isEmpty(categoriaMateriales)}">
                                    <th:block th:each="cat, iter : ${categoriaMateriales}">
                                        <input type="radio" class="btn-check" name="radioCategoriaBusqueda"
                                               th:id="${'radioCategoria_' + iter.index}" th:value="${cat.nmbCategoria}" autocomplete="off">
                                        <label class="btn btn-outline-success"
                                               th:for="${'radioCategoria_' + iter.index}" th:text="${cat.nmbCategoria}"
                                               data-bs-toggle="tooltip" data-bs-placement="top"
                                               th:attr="title=${cat.dscCategoria}">
                                            Categor√≠a
                                        </label>
                                    </th:block>
                                </th:block>
                                <th:block th:if="${#lists.isEmpty(categoriaMateriales)}">
                                    <span class="text-muted small">No hay categor√≠as registradas</span>
                                </th:block>
                            </div>
                        </div>
                    </div>

                    <!-- Radios de tipo -->
                    <div class="row g-3 mb-3">
                        <div class="col-12">
                            <span class="form-label fw-semibold text-muted d-block mb-2">Tipo</span>
                            <div class="btn-group flex-wrap gap-2" role="group" aria-label="Filtro tipo">
                                <input type="radio" class="btn-check" name="radioTipoBusqueda" id="radioTipoNone" value="" autocomplete="off" checked>
                                <label class="btn btn-outline-success" for="radioTipoNone">Ninguno</label>
                                <th:block th:if="${not #lists.isEmpty(tiposMateriales)}">
                                    <th:block th:each="tipo, iter : ${tiposMateriales}">
                                        <input type="radio" class="btn-check" name="radioTipoBusqueda"
                                               th:id="${'radioTipo_' + iter.index}" th:value="${tipo.nmbCategoria}" autocomplete="off">
                                        <label class="btn btn-outline-success"
                                               th:for="${'radioTipo_' + iter.index}" th:text="${tipo.nmbCategoria}"
                                               data-bs-toggle="tooltip" data-bs-placement="top"
                                               th:attr="title=${tipo.dscCategoria}">
                                            Tipo
                                        </label>
                                    </th:block>
                                </th:block>
                                <th:block th:if="${#lists.isEmpty(tiposMateriales)}">
                                    <span class="text-muted small">No hay tipos registrados</span>
                                </th:block>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-auto">
                            <small class="text-muted">Selecciona opcionalmente categor√≠a y tipo o deja "Ninguno" para no filtrar.</small>
                        </div>
                    </div>

                    <!-- Botones de acci√≥n -->
                    <div class="row mt-4">
                        <div class="col-12 d-flex flex-wrap gap-3 justify-content-end">
                            <button id="btnAbrirBuscar" class="btn btn-success" type="button" data-endpoint="/punto-eca/catalogo/materiales/buscar">
                                <i class="bi bi-plus-circle me-1"></i>Agregar
                            </button>
                            <button id="btnLimpiarBusquedaAgregar" class="btn btn-outline-secondary" type="button">
                                <i class="bi bi-eraser me-1"></i>Limpiar
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- MODAL: RESULTADOS DE B√öSQUEDA DE MATERIALES -->
        <div class="modal fade" id="buscarMaterialModal" tabindex="-1" aria-labelledby="buscarMaterialModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-scrollable">
                <div class="modal-content">
                    <div class="modal-header bg-success text-white">
                        <h5 class="modal-title" id="buscarMaterialModalLabel">
                            <i class="bi bi-search me-2"></i>Resultados de B√∫squeda
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                    </div>
                    <div class="modal-body">
                        <!-- Resumen de filtros aplicados -->
                        <div class="alert alert-info mb-3" role="alert">
                            <strong>Filtros aplicados:</strong>
                            <div class="mt-2">
                                <span class="badge bg-info-subtle text-info">Texto: <strong id="resumenBusquedaTexto">Sin filtro</strong></span>
                                <span class="badge bg-info-subtle text-info ms-2">Categor√≠a: <strong id="resumenBusquedaCategoria">Sin filtro</strong></span>
                                <span class="badge bg-info-subtle text-info ms-2">Tipo: <strong id="resumenBusquedaTipo">Sin filtro</strong></span>
                            </div>
                        </div>

                        <!-- Estado de b√∫squeda (loading, ready, etc) -->
                        <div id="estadoBusquedaMateriales" class="text-center text-muted py-4 mb-3">
                            <i class="bi bi-search display-6 d-block mb-2"></i>
                            <p class="mb-0">Buscando materiales...</p>
                        </div>

                        <!-- Lista de resultados -->
                        <div id="resultadosBusqueda" class="list-group">
                            <!-- Los resultados se renderizar√°n aqu√≠ -->
                        </div>
                    </div>
                    <div class="modal-footer border-top bg-light">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="bi bi-x-circle me-1"></i>Cerrar
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- MODAL: AGREGAR MATERIAL AL INVENTARIO -->
        <div class="modal fade" id="agregarInventarioModal" tabindex="-1" aria-labelledby="agregarInventarioModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-scrollable">
                <div class="modal-content">
                    <div class="modal-header bg-success text-white">
                        <h5 class="modal-title" id="agregarInventarioModalLabel">
                            <i class="bi bi-plus-circle me-2"></i>Agregar Material al Inventario
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                    </div>
                    <div class="modal-body">
                        <form id="formAgregarInventario">
                            <!-- Input hidden para guardar el ID del material (no visible) -->
                            <input type="hidden" id="agregarMaterialId">
                            <!-- Input hidden para guardar el ID del punto (no visible) -->
                            <input type="hidden" id="agregarPuntoId" th:value="${usuario.puntoEcaId()}">
                            <div class="row g-3 mb-4">
                                <div class="col-12">
                                    <label for="agregarMaterialNombre" class="form-label fw-semibold">Material Seleccionado</label>
                                    <input type="text" class="form-control" id="agregarMaterialNombre" readonly style="background-color: #f5f5f5;">
                                </div>
                            </div>

                            <!-- Divisor -->
                            <hr class="my-4">

                            <!-- Fila 2: Datos de Inventario -->
                            <h6 class="fw-semibold text-success mb-3">Datos de Inventario</h6>

                            <div class="row g-3 mb-3">
                                <div class="col-md-6">
                                    <label for="stockInicial" class="form-label fw-semibold">Stock Inicial</label>
                                    <input type="number" class="form-control border-2 border-success" id="stockInicial" placeholder="0" min="0" required>
                                    <small class="text-muted">Cantidad inicial a agregar</small>
                                </div>
                                <div class="col-md-6">
                                    <label for="capacidadMaxima" class="form-label fw-semibold">Capacidad M√°xima</label>
                                    <input type="number" class="form-control border-2 border-success" id="capacidadMaxima" placeholder="1000" min="0" required>
                                    <small class="text-muted">M√°ximo que puede almacenar</small>
                                </div>
                            </div>

                            <!-- Fila 2.5: Unidad de Medida -->
                            <div class="row g-3 mb-3">
                                <div class="col-md-6">
                                    <label for="unidadMedida" class="form-label fw-semibold">Unidad de Medida</label>
                                    <select class="form-select border-2 border-success" id="unidadMedida" required>
                                        <option value="" selected disabled>Selecciona una unidad</option>
                                        <th:block th:if="${not #lists.isEmpty(unidadesMedida)}">
                                            <option th:each="unidad : ${unidadesMedida}"
                                                    th:value="${unidad.clave}"
                                                    th:text="${unidad.nombre}">
                                                Unidad
                                            </option>
                                        </th:block>
                                        <th:block th:if="${#lists.isEmpty(unidadesMedida)}">
                                            <option disabled>No hay unidades disponibles</option>
                                        </th:block>
                                    </select>
                                    <small class="text-muted">Selecciona la unidad de medida para el stock</small>
                                </div>
                            </div>

                            <!-- Fila 3: Precios -->
                            <h6 class="fw-semibold text-success mb-3 mt-4">Precios</h6>

                            <div class="row g-3 mb-3">
                                <div class="col-md-6">
                                    <label for="precioCompra" class="form-label fw-semibold">Precio de Compra</label>
                                    <div class="input-group">
                                        <span class="input-group-text">$</span>
                                        <input type="number" class="form-control border-2 border-success" id="precioCompra" placeholder="0.00" min="0" step="0.01" required>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label for="precioVenta" class="form-label fw-semibold">Precio de Venta</label>
                                    <div class="input-group">
                                        <span class="input-group-text">$</span>
                                        <input type="number" class="form-control border-2 border-success" id="precioVenta" placeholder="0.00" min="0" step="0.01" required>
                                    </div>
                                </div>
                            </div>

                            <!-- Fila 4: Umbrales -->
                            <h6 class="fw-semibold text-success mb-3 mt-4">Umbrales de Alerta</h6>

                            <div class="row g-3 mb-3">
                                <div class="col-md-6">
                                    <label for="umbralAlerta" class="form-label fw-semibold">Umbral de Alerta (%)</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control border-2 border-success" id="umbralAlerta" placeholder="25" min="0" max="100" step="1" required>
                                        <span class="input-group-text">%</span>
                                    </div>
                                    <small class="text-muted">Porcentaje m√≠nimo antes de alertar</small>
                                </div>
                                <div class="col-md-6">
                                    <label for="umbralCritico" class="form-label fw-semibold">Umbral Cr√≠tico (%)</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control border-2 border-success" id="umbralCritico" placeholder="10" min="0" max="100" step="1" required>
                                        <span class="input-group-text">%</span>
                                    </div>
                                    <small class="text-muted">Porcentaje cr√≠tico de stock</small>
                                </div>
                            </div>

                            <!-- Mensaje de estado -->
                            <div id="mensajeEstado" class="alert alert-info mt-4" style="display: none;" role="alert">
                                <i class="bi bi-info-circle me-2"></i>
                                <span id="textoMensaje"></span>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer border-top bg-light">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="bi bi-x-circle me-1"></i>Cancelar
                        </button>
                        <button type="button" class="btn btn-success" id="btnGuardarInventario">
                            <i class="bi bi-check-circle me-1"></i>Guardar en Inventario
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- SCRIPT INLINE PARA VINCULACI√ìN DIRECTA DE BOTONES Y B√öSQUEDA -->
        <script>
        (function() {
            console.log('üìå Script inline de b√∫squeda ejecut√°ndose...');

            // ============================================================
            // ELEMENTOS DEL DOM
            // ============================================================
            const btnAbrirBuscar = document.getElementById('btnAbrirBuscar');
            const btnLimpiarAgregar = document.getElementById('btnLimpiarBusquedaAgregar');
            const inputBusquedaAgregar = document.getElementById('buscarMaterialInput');
            const modalBuscarMaterial = document.getElementById('buscarMaterialModal');
            const resumenTextoEl = document.getElementById('resumenBusquedaTexto');
            const resumenCategoriaEl = document.getElementById('resumenBusquedaCategoria');
            const resumenTipoEl = document.getElementById('resumenBusquedaTipo');
            const estadoBusquedaEl = document.getElementById('estadoBusquedaMateriales');
            const listaResultadosEl = document.getElementById('resultadosBusqueda');

            console.log('‚úì Elementos encontrados:', {btnAbrirBuscar: !!btnAbrirBuscar, btnLimpiarAgregar: !!btnLimpiarAgregar, modalBuscarMaterial: !!modalBuscarMaterial});

            // ============================================================
            // FUNCIONES DE UTILIDAD
            // ============================================================
            function obtenerFiltrosAgregarMaterial() {
                const categoriaSeleccionada = document.querySelector('input[name="radioCategoriaBusqueda"]:checked');
                const tipoSeleccionado = document.querySelector('input[name="radioTipoBusqueda"]:checked');

                return {
                    texto: (inputBusquedaAgregar?.value || '').trim(),
                    categoria: categoriaSeleccionada ? categoriaSeleccionada.value : '',
                    tipo: tipoSeleccionado ? tipoSeleccionado.value : ''
                };
            }

            function actualizarResumenBusqueda(filtros) {
                if (resumenTextoEl) resumenTextoEl.textContent = filtros.texto || 'Sin filtro';
                if (resumenCategoriaEl) resumenCategoriaEl.textContent = filtros.categoria || 'Sin filtro';
                if (resumenTipoEl) resumenTipoEl.textContent = filtros.tipo || 'Sin filtro';
            }

            function mostrarEstadoBusqueda(estado) {
                if (!estadoBusquedaEl) return;
                const estados = {
                    idle: '<i class="bi bi-search display-6 d-block mb-2"></i><p class="mb-0">Marca tus filtros y haz clic en <strong>Agregar</strong> para consultar el cat√°logo.</p>',
                    loading: '<div class="d-flex flex-column align-items-center"><div class="spinner-border text-success mb-3" role="status"></div><p class="mb-0">Buscando materiales disponibles...</p></div>',
                    ready: '<i class="bi bi-check-circle text-success display-6 d-block mb-2"></i><p class="mb-0">Selecciona un material para continuar.</p>'
                };
                estadoBusquedaEl.innerHTML = estados[estado] || estados.idle;
            }

            function renderResultadosBusqueda(materiales, opciones = {}) {
                if (!listaResultadosEl) return;

                listaResultadosEl.innerHTML = '';

                if (opciones.modoCarga) {
                    const skeleton = document.createElement('div');
                    skeleton.className = 'list-group-item py-3 text-muted d-flex align-items-center gap-3';
                    skeleton.innerHTML = '<span class="placeholder col-2"></span><span class="placeholder col-5"></span><span class="placeholder col-3 ms-auto"></span>';
                    listaResultadosEl.appendChild(skeleton);
                    return;
                }

                if (!materiales || materiales.length === 0) {
                    const emptyItem = document.createElement('div');
                    emptyItem.className = 'list-group-item text-muted text-center py-4';
                    emptyItem.textContent = 'Sin resultados disponibles. Ejecuta una b√∫squeda para comenzar.';
                    listaResultadosEl.appendChild(emptyItem);
                    mostrarEstadoBusqueda('idle');
                    return;
                }

                materiales.forEach(material => {
                    const item = document.createElement('button');
                    item.type = 'button';
                    item.className = 'list-group-item list-group-item-action resultado-material-item d-flex align-items-start gap-3';
                    // Usar los nombres correctos del DTO
                    item.dataset.materialId = material.materialId || '';
                    item.dataset.nombre = material.nmbMaterial || '';
                    item.dataset.descripcion = material.dscMaterial || '';
                    item.dataset.tipo = material.nmbTipo || '';
                    item.dataset.categoria = material.nmbCategoria || '';
                    item.dataset.unidad = material.unidad || '';

                    // Crear imagen
                    const img = document.createElement('img');
                    img.src = material.imagenUrl || '/imagenes/materiales.png';
                    img.alt = material.nmbMaterial || 'Imagen material';
                    img.className = 'rounded';
                    img.style.width = '64px';
                    img.style.height = '64px';
                    img.style.objectFit = 'cover';
                    img.style.flexShrink = '0';

                    // Contenido textual
                    const content = document.createElement('div');
                    content.className = 'flex-grow-1 text-start';

                    const title = document.createElement('div');
                    title.className = 'fw-semibold';
                    title.textContent = material.nmbMaterial || 'Material sin nombre';

                    const desc = document.createElement('small');
                    desc.className = 'text-muted d-block mb-2';
                    desc.textContent = material.dscMaterial || 'Sin descripci√≥n';

                    const badges = document.createElement('div');
                    const tipoBadge = document.createElement('span');
                    tipoBadge.className = 'badge bg-primary me-1';
                    tipoBadge.textContent = material.nmbTipo || 'Tipo';
                    const catBadge = document.createElement('span');
                    catBadge.className = 'badge bg-secondary';
                    catBadge.textContent = material.nmbCategoria || 'Categor√≠a';

                    badges.appendChild(tipoBadge);
                    badges.appendChild(catBadge);

                    content.appendChild(title);
                    content.appendChild(desc);
                    content.appendChild(badges);

                    const actionBadge = document.createElement('span');
                    actionBadge.className = 'badge bg-success rounded-pill align-self-start';
                    actionBadge.textContent = 'Seleccionar';

                    item.appendChild(img);
                    item.appendChild(content);
                    item.appendChild(actionBadge);

                    listaResultadosEl.appendChild(item);
                });

                mostrarEstadoBusqueda('ready');

                // ‚ú® Agregar manejadores de clic a cada material
                document.querySelectorAll('.resultado-material-item').forEach(item => {
                    item.addEventListener('click', function(e) {
                        e.preventDefault();

                        const materialId = this.dataset.materialId;
                        const materialNombre = this.dataset.nombre;

                        console.log('üì¶ Material seleccionado:', materialId, '-', materialNombre);

                        // Llenar los campos del formulario
                        document.getElementById('agregarMaterialId').value = materialId;
                        document.getElementById('agregarMaterialNombre').value = materialNombre;

                        // Limpiar campos de entrada
                        document.getElementById('stockInicial').value = '';
                        document.getElementById('capacidadMaxima').value = '';
                        document.getElementById('precioCompra').value = '';
                        document.getElementById('precioVenta').value = '';
                        document.getElementById('umbralAlerta').value = '';
                        document.getElementById('umbralCritico').value = '';
                        document.getElementById('unidadMedida').value = '';

                        // Limpiar mensaje de estado
                        const mensajeEstado = document.getElementById('mensajeEstado');
                        if (mensajeEstado) {
                            mensajeEstado.style.display = 'none';
                        }

                        // Cerrar modal de b√∫squeda
                        const modalBusquedaInstance = bootstrap.Modal.getInstance(document.getElementById('buscarMaterialModal'));
                        if (modalBusquedaInstance) {
                            modalBusquedaInstance.hide();
                        }

                        // Abrir modal de agregar inventario
                        const modalAgregar = document.getElementById('agregarInventarioModal');
                        if (modalAgregar) {
                            const modal = new bootstrap.Modal(modalAgregar);
                            modal.show();
                            console.log('‚úì Modal de agregar inventario abierto');
                        }
                    });
                });
            }

            // ============================================================
            // HANDLER: BOT√ìN AGREGAR
            // ============================================================
            if (btnAbrirBuscar) {
                btnAbrirBuscar.addEventListener('click', function() {
                    console.log('üîç Click en AGREGAR');
                    const filtros = obtenerFiltrosAgregarMaterial();
                    console.log('Filtros:', filtros);

                    actualizarResumenBusqueda(filtros);
                    mostrarEstadoBusqueda('loading');

                    // Abrir modal
                    if (modalBuscarMaterial) {
                        const modal = new bootstrap.Modal(modalBuscarMaterial);
                        modal.show();
                    }

                    // Disparar b√∫squeda al backend
                    const endpoint = btnAbrirBuscar.dataset.endpoint || '/punto-eca/catalogo/materiales/buscar';
                    const params = new URLSearchParams();

                    // Obtener el puntoId del input hidden
                    const puntoId = document.getElementById('agregarPuntoId').value;
                    console.log('PuntoId obtenido:', puntoId);

                    // Agregar puntoId como par√°metro obligatorio
                    if (puntoId) {
                        params.append('puntoId', puntoId);
                    } else {
                        console.error('‚ùå Error: puntoId no disponible');
                        alert('Error: ID del punto ECA no disponible');
                        return;
                    }

                    if (filtros.texto) params.append('texto', filtros.texto);
                    if (filtros.categoria) params.append('categoria', filtros.categoria);
                    if (filtros.tipo) params.append('tipo', filtros.tipo);

                    const url = endpoint + (params.toString() ? ('?' + params.toString()) : '');
                    console.log('Buscando en:', url);

                    fetch(url, { method: 'GET', headers: { 'Accept': 'application/json' } })
                        .then(res => {
                            console.log('Respuesta status:', res.status);
                            return res.json().then(data => ({
                                status: res.status,
                                ok: res.ok,
                                data: data
                            }));
                        })
                        .then(({ status, ok, data }) => {
                            console.log('Datos recibidos:', data);
                            console.log('Response OK:', ok, 'Status:', status);

                            // Si hay error en la respuesta (status 400, 500, etc.)
                            if (!ok) {
                                const mensajeError = data?.mensaje || data?.message || 'Error desconocido';
                                console.warn('‚ö†Ô∏è Error del servidor (status ' + status + '):', mensajeError);
                                mostrarEstadoBusqueda('idle');
                                const listaResultadosEl = document.getElementById('resultadosBusqueda');
                                if (listaResultadosEl) {
                                    listaResultadosEl.innerHTML = `
                                        <div class="list-group-item text-muted py-4">
                                            <div class="alert alert-warning mb-0" role="alert">
                                                <i class="bi bi-exclamation-triangle me-2"></i>
                                                <strong>${mensajeError}</strong>
                                            </div>
                                        </div>
                                    `;
                                }
                                return;
                            }

                            if (!Array.isArray(data)) data = [];

                            // Normalizar datos seg√∫n el DTO
                            const materiales = data.map(m => ({
                                id: m.materialId ?? '',
                                nombre: m.nmbMaterial ?? '',
                                descripcion: m.dscMaterial ?? '',
                                imagen: m.imagenUrl ?? '',
                                categoria: m.nmbCategoria ?? '',
                                descCategoria: m.dscCategoria ?? '',
                                tipo: m.nmbTipo ?? '',
                                descTipo: m.dscTipo ?? ''
                            }));

                            renderResultadosBusqueda(materiales);
                        })
                        .catch(err => {
                            console.error('‚ùå Error en b√∫squeda:', err);
                            mostrarEstadoBusqueda('idle');
                            const listaResultadosEl = document.getElementById('resultadosBusqueda');
                            if (listaResultadosEl) {
                                listaResultadosEl.innerHTML = `
                                    <div class="list-group-item text-muted py-4">
                                        <div class="alert alert-danger mb-0" role="alert">
                                            <i class="bi bi-exclamation-octagon me-2"></i>
                                            <strong>Error de conexi√≥n</strong><br>
                                            <small>No se pudo conectar con el servidor. Intenta de nuevo.</small>
                                        </div>
                                    </div>
                                `;
                            }
                        });
                });
                console.log('‚úì Handler AGREGAR vinculado');
            }

            // ============================================================
            // HANDLER: BOT√ìN LIMPIAR
            // ============================================================
            if (btnLimpiarAgregar) {
                btnLimpiarAgregar.addEventListener('click', function() {
                    console.log('üßπ Click en LIMPIAR');

                    if (inputBusquedaAgregar) inputBusquedaAgregar.value = '';

                    document.querySelectorAll('input[name="radioCategoriaBusqueda"]').forEach(r => {
                        if (r.id === 'radioCategoriaNone') r.checked = true;
                    });

                    document.querySelectorAll('input[name="radioTipoBusqueda"]').forEach(r => {
                        if (r.id === 'radioTipoNone') r.checked = true;
                    });

                    actualizarResumenBusqueda({ texto: '', categoria: '', tipo: '' });
                    renderResultadosBusqueda([]);
                    mostrarEstadoBusqueda('idle');

                    console.log('‚úì Campos limpiados');
                });
                console.log('‚úì Handler LIMPIAR vinculado');
            }

            // ============================================================
            // HANDLER: BOT√ìN GUARDAR INVENTARIO
            // ============================================================
            const btnGuardarInventario = document.getElementById('btnGuardarInventario');
            if (btnGuardarInventario) {
                btnGuardarInventario.addEventListener('click', function() {
                    console.log('üíæ Click en GUARDAR INVENTARIO');

                    // Recolectar datos del formulario
                    const materialId = document.getElementById('agregarMaterialId').value;
                    const nombreMaterial = document.getElementById('agregarMaterialNombre').value;
                    const stockInicial = document.getElementById('stockInicial').value;
                    const capacidadMaxima = document.getElementById('capacidadMaxima').value;
                    const precioCompra = document.getElementById('precioCompra').value;
                    const precioVenta = document.getElementById('precioVenta').value;
                    const umbralAlerta = document.getElementById('umbralAlerta').value;
                    const umbralCritico = document.getElementById('umbralCritico').value;
                    const unidadMedida = document.getElementById('unidadMedida').value;

                    // Validar campos obligatorios
                    const puntoId = document.getElementById('agregarPuntoId').value;
                    if (!materialId || !stockInicial || !capacidadMaxima || !precioCompra || !precioVenta || !umbralAlerta || !umbralCritico || !unidadMedida || !puntoId) {
                        alert('Por favor completa todos los campos obligatorios');
                        return;
                    }

                    // Preparar datos para enviar
                    const datosInventario = {
                        materialId: materialId,
                        puntoEcaId: puntoId,
                        stockActual: parseFloat(stockInicial) || 0,
                        capacidadMaxima: parseFloat(capacidadMaxima) || 0,
                        precioCompra: parseFloat(precioCompra) || 0,
                        precioVenta: parseFloat(precioVenta) || 0,
                        umbralAlerta: parseInt(umbralAlerta) || 25,
                        umbralCritico: parseInt(umbralCritico) || 10,
                        unidadMedida: unidadMedida
                    };

                    console.log('Datos a enviar:', datosInventario);

                    // Enviar al backend
                    fetch('/punto-eca/inventario/agregar', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        body: JSON.stringify(datosInventario)
                    })
                    .then(res => {
                        console.log('Respuesta del servidor:', res.status);
                        return res.json().then(data => ({
                            status: res.status,
                            ok: res.ok,
                            data: data
                        }));
                    })
                    .then(({ status, ok, data }) => {
                        console.log('Datos recibidos:', data);

                        // Cerrar modal de agregar
                        const modalAgregar = bootstrap.Modal.getInstance(document.getElementById('agregarInventarioModal'));
                        if (modalAgregar) modalAgregar.hide();

                        if (!ok) {
                            // Error del servidor
                            const mensajeError = data?.mensaje || 'Error desconocido';
                            console.warn('‚ö†Ô∏è Error del servidor (status ' + status + '):', mensajeError);
                            mostrarModalResultado(false, 'Error al guardar', mensajeError);
                            return;
                        }

                        // √âxito (status 201)
                        console.log('‚úì Material guardado exitosamente');
                        mostrarModalResultado(true, '¬°Material Guardado!', 'El material se ha agregado exitosamente al inventario.');

                        // Limpiar formulario despu√©s de cerrar el modal
                        setTimeout(() => {
                            document.getElementById('formAgregarInventario').reset();
                        }, 500);
                    })
                    .catch(err => {
                        console.error('‚ùå Error en la solicitud:', err);
                        // Cerrar modal de agregar
                        const modalAgregar = bootstrap.Modal.getInstance(document.getElementById('agregarInventarioModal'));
                        if (modalAgregar) modalAgregar.hide();
                        mostrarModalResultado(false, 'Error de conexi√≥n', 'No se pudo conectar con el servidor. Intenta de nuevo.');
                    });
                });
                console.log('‚úì Handler GUARDAR INVENTARIO vinculado');
            }

            // ============================================================
            // HANDLER: BOT√ìN APLICAR FILTROS (RECARGAR P√ÅGINA CON FILTROS)
            // Usando event delegation para que funcione incluso si el elemento se carga despu√©s
            // ============================================================
            document.addEventListener('click', function(e) {
                if (e.target.id === 'btnAplicarFiltros' || e.target.closest('#btnAplicarFiltros')) {
                    console.log('üîé Click en APLICAR filtros (Inventario)');

                    // Recolectar filtros desde el formulario de inventario
                    const texto = (document.getElementById('busquedaMaterial')?.value || '').trim();
                    const categoria = (document.querySelector('input[name="filtroCategoria"]:checked')?.value || '').trim();
                    const tipo = (document.querySelector('input[name="filtroTipo"]:checked')?.value || '').trim();
                    const alerta = (document.getElementById('filtroAlerta')?.value || '').trim();
                    const unidad = (document.getElementById('filtroUnidad')?.value || '').trim();
                    const ocupacion = (document.getElementById('filtroOcupacion')?.value || '').trim();

                    const filtros = { texto, categoria, tipo, alerta, unidad, ocupacion };
                    console.log('Filtros aplicados:', filtros);

                    // Construir query parameters
                    const params = new URLSearchParams();
                    if (texto) params.append('texto', texto);
                    if (categoria) params.append('categoria', categoria);
                    if (tipo) params.append('tipo', tipo);
                    if (alerta) params.append('alerta', alerta);
                    if (unidad) params.append('unidad', unidad);
                    if (ocupacion) params.append('ocupacion', ocupacion);

                    // Obtener nombrePunto y gestorId de la URL actual
                    const pathSegments = window.location.pathname.split('/').filter(s => s);
                    // Formato esperado: /punto-eca/{nombrePunto}/{gestorId}/Materiales
                    const nombrePunto = pathSegments[1];
                    const gestorId = pathSegments[2];

                    console.log('nombrePunto:', nombrePunto, 'gestorId:', gestorId);

                    if (!nombrePunto || !gestorId) {
                        console.error('‚ùå No se pudieron obtener nombrePunto o gestorId de la URL');
                        alert('Error: No se pudo obtener la informaci√≥n del punto ECA');
                        return;
                    }

                    // Construir URL: /punto-eca/{nombrePunto}/{gestorId}/Materiales?filtros
                    const url = `/punto-eca/${nombrePunto}/${gestorId}/Materiales${params.toString() ? ('?' + params.toString()) : ''}`;
                    console.log('üöÄ Recargando p√°gina con URL:', url);

                    // Recargar p√°gina con los filtros como par√°metros de URL
                    window.location.href = url;
                }
            }, true); // Usar captura para asegurar que se dispare antes
            console.log('‚úì Handler APLICAR FILTROS vinculado (recarga p√°gina con filtros)');

            // ============================================================
            // HANDLER: BOT√ìN RESTABLECER FILTROS
            // ============================================================
            document.addEventListener('click', function(e) {
                if (e.target.id === 'btnRestablecerFiltros' || e.target.closest('#btnRestablecerFiltros')) {
                    // Limpiar b√∫squeda de texto
                    document.getElementById('busquedaMaterial').value = '';

                    // Limpiar radio buttons de categor√≠a (seleccionar "Ninguno")
                    document.getElementById('filtroCategoriaNone').checked = true;

                    // Limpiar radio buttons de tipo (seleccionar "Ninguno")
                    document.getElementById('filtroTipoNone').checked = true;

                    // Limpiar selects
                    document.getElementById('filtroAlerta').value = '';
                    document.getElementById('filtroUnidad').value = '';
                    document.getElementById('filtroOcupacion').value = '';

                    // Recargar la p√°gina sin filtros
                    const pathSegments = window.location.pathname.split('/').filter(s => s);
                    const nombrePunto = pathSegments[1];
                    const gestorId = pathSegments[2];
                    const url = `/punto-eca/${nombrePunto}/${gestorId}/Materiales`;
                    window.location.href = url;
                }
            }, true);
            console.log('‚úì Handler RESTABLECER FILTROS vinculado');

            console.log('üìå Script inline completado ‚úì');
        })();
        </script>

        <!-- Item 2: OCUPACI√ìN DE INVENTARIO -->
        <div class="accordion-item border-start border-5 border-info">
            <h2 class="accordion-header" id="headingOcupacion">
                <button class="accordion-button fw-bold collapsed" type="button"
                        data-bs-toggle="collapse" data-bs-target="#collapseOcupacion" aria-expanded="false"
                        aria-controls="collapseOcupacion">
                    <span class="bg-info p-2 rounded-circle me-3" style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">
                        <i class="bi bi-graph-up text-white"></i>
                    </span>
                    <span>
                        <span class="fw-bold text-dark d-block">Ocupaci√≥n de Inventario</span>
                        <small class="text-muted fw-normal"><span th:text="${inventario != null ? inventario.size() : 0}">0</span> materiales registrados</small>
                    </span>
                </button>
            </h2>
            <div id="collapseOcupacion" class="accordion-collapse collapse" aria-labelledby="headingOcupacion"
                 data-bs-parent="#acordeonMateriales">
                <div class="accordion-body p-4 bg-light">
                    <div th:if="${#lists.isEmpty(inventario)}" class="text-muted text-center py-3">
                        No hay datos de inventario disponibles
                    </div>
                    <div class="table-responsive" th:if="${not #lists.isEmpty(inventario)}">
                        <table class="table table-sm align-middle mb-0">
                            <thead class="bg-success text-white">
                                <tr>
                                    <th>Material</th>
                                    <th class="text-end" style="width:140px;">Stock</th>
                                    <th class="text-end" style="width:140px;">Capacidad</th>
                                    <th style="min-width:240px;">% Ocupaci√≥n</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr th:each="inventario : ${inventario}">
                                    <td class="fw-semibold" th:text="${inventario.nombreMaterial()}">Material</td>
                                    <td class="text-end"
                                        th:text="${#numbers.formatDecimal(inventario.stockActual(), 1, 'COMMA', 2, 'POINT')}">0.00</td>
                                    <td class="text-end"
                                        th:text="${#numbers.formatDecimal(inventario.capacidadMaxima(), 1, 'COMMA', 2, 'POINT')}">0.00</td>
                                    <td>
                                        <th:block th:with="ocupacion = ${(inventario.stockActual() / inventario.capacidadMaxima() * 100).intValue()}">
                                            <div class="progress" style="height:18px;">
                                                <div class="progress-bar"
                                                     th:classappend="${ocupacion >= inventario.umbralCritico() ? 'bg-danger' : (ocupacion >= inventario.umbralAlerta() ? 'bg-warning' : 'bg-success')}"
                                                     role="progressbar"
                                                     th:attr="aria-valuenow=${ocupacion}, aria-valuemin='0', aria-valuemax='100'"
                                                     th:style="'width: ' + ${ocupacion} + '%'">
                                                    <span class="small" th:text="${ocupacion} + '%'">0%</span>
                                                </div>
                                            </div>
                                        </th:block>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="small text-muted mt-2">
                        Colores: <span class="badge bg-success">OK</span> <span class="badge bg-warning">Alerta</span>
                        <span class="badge bg-danger">Cr√≠tico</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Item 3: MATERIALES EN INVENTARIO -->
        <div class="accordion-item border-start border-5 border-primary">
            <h2 class="accordion-header" id="headingTarjetas">
                <button class="accordion-button fw-bold" type="button"
                        data-bs-toggle="collapse" data-bs-target="#collapseTarjetas"
                        aria-expanded="true" aria-controls="collapseTarjetas">
                    <span class="bg-primary p-2 rounded-circle me-3" style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">
                        <i class="bi bi-collection text-white"></i>
                    </span>
                    <span>
                        <span class="fw-bold text-dark d-block">Materiales en Inventario</span>
                        <small class="text-muted fw-normal"><span th:text="${inventario != null ? inventario.size() : 0}">0</span> items disponibles</small>
                    </span>
                </button>
            </h2>
            <div id="collapseTarjetas" class="accordion-collapse collapse show"
                 aria-labelledby="headingTarjetas" data-bs-parent="#acordeonMateriales">
                <div class="accordion-body p-4 bg-light">
                    <div class="accordion mb-4" id="acordeonFiltrosTarjetas">
                        <div class="accordion-item border-0 shadow-sm">
                            <h2 class="accordion-header" id="headingBusquedaTarjetas">
                                <button class="accordion-button bg-light text-dark fw-semibold collapsed" type="button"
                                        data-bs-toggle="collapse" data-bs-target="#collapseBusquedaTarjetas"
                                        aria-expanded="false" aria-controls="collapseBusquedaTarjetas">
                                    <i class="bi bi-search text-success me-2"></i>B√∫squeda y Filtros
                                </button>
                            </h2>
                            <div id="collapseBusquedaTarjetas" class="accordion-collapse collapse"
                                 aria-labelledby="headingBusquedaTarjetas" data-bs-parent="#acordeonFiltrosTarjetas">
                                <div class="accordion-body p-4">
                                    <div class="row g-3 mb-4">
                                        <div class="col-12">
                                            <label for="busquedaMaterial" class="form-label fw-semibold text-muted mb-2">
                                                <i class="bi bi-search me-1"></i>Buscar Material
                                            </label>
                                            <div class="input-group input-group-lg">
                                                <span class="input-group-text bg-light border-2 border-success">
                                                    <i class="bi bi-search text-success"></i>
                                                </span>
                                                <input type="text"
                                                       class="form-control form-control-lg border-2 border-success"
                                                       id="busquedaMaterial"
                                                       placeholder="Buscar por nombre de material..."
                                                       style="transition: all 0.3s ease;">
                                                <button class="btn btn-outline-success border-2"
                                                        type="button"
                                                        id="btnLimpiarBusqueda"
                                                        title="Limpiar b√∫squeda">
                                                    <i class="bi bi-x-circle"></i> Limpiar
                                                </button>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="row g-3 mb-3">
                                        <div class="col-md-6 col-lg-4">
                                            <label for="filtroAlerta" class="form-label fw-semibold text-muted mb-2">
                                                <i class="bi bi-exclamation-triangle me-1"></i>Alerta
                                            </label>
                                            <select class="form-select form-select-sm border-2 border-success filtro-select"
                                                    id="filtroAlerta"
                                                    data-tipo="alerta">
                                                <option value="">Todas las alertas</option>
                                                <th:block th:if="${not #lists.isEmpty(alerta)}">
                                                    <option th:each="alert : ${alerta}"
                                                            th:value="${alert.clave}"
                                                            th:text="${alert.tipo}">
                                                        Alerta
                                                    </option>
                                                </th:block>
                                            </select>
                                        </div>

                                        <div class="col-md-6 col-lg-4">
                                            <label for="filtroUnidad" class="form-label fw-semibold text-muted mb-2">
                                                <i class="bi bi-ruler me-1"></i>Unidad de Medida
                                            </label>
                                            <select class="form-select form-select-sm border-2 border-success filtro-select"
                                                    id="filtroUnidad"
                                                    data-tipo="unidad">
                                                <option value="">Todas las unidades</option>
                                                <option value="kg">Kilogramos (kg)</option>
                                                <option value="l">Litros (l)</option>
                                                <option value="m">Metros (m)</option>
                                                <option value="m2">Metros cuadrados (m¬≤)</option>
                                                <option value="unidad">Unidades</option>
                                            </select>
                                        </div>

                                        <div class="col-md-6 col-lg-4">
                                            <label for="filtroOcupacion" class="form-label fw-semibold text-muted mb-2">
                                                <i class="bi bi-percent me-1"></i>Ocupaci√≥n
                                            </label>
                                            <select class="form-select form-select-sm border-2 border-success filtro-select"
                                                    id="filtroOcupacion"
                                                    data-tipo="ocupacion">
                                                <option value="">Cualquier ocupaci√≥n</option>
                                                <option value="0-25">0% - 25%</option>
                                                <option value="25-50">25% - 50%</option>
                                                <option value="50-75">50% - 75%</option>
                                                <option value="75-100">75% - 100%</option>
                                            </select>
                                        </div>
                                    </div>

                                        <!-- Filtro de Categor√≠a con radio buttons -->
                                    <div class="row g-3 mb-3">
                                        <div class="col-12">
                                            <span class="form-label fw-semibold text-muted d-block mb-2">
                                                <i class="bi bi-tags me-1"></i>Categor√≠a
                                            </span>
                                            <div class="btn-group flex-wrap gap-2" role="group" aria-label="Filtro categor√≠a">
                                                <input type="radio" class="btn-check" name="filtroCategoria" id="filtroCategoriaNone" value="" autocomplete="off" checked>
                                                <label class="btn btn-outline-success" for="filtroCategoriaNone">Ninguno</label>
                                                <th:block th:if="${not #lists.isEmpty(categoriaMateriales)}">
                                                    <th:block th:each="cat, iter : ${categoriaMateriales}">
                                                        <input type="radio" class="btn-check" name="filtroCategoria"
                                                               th:id="${'filtroCategoria_' + iter.index}" th:value="${cat.nmbCategoria}" autocomplete="off">
                                                        <label class="btn btn-outline-success"
                                                               th:for="${'filtroCategoria_' + iter.index}" th:text="${cat.nmbCategoria}">
                                                            Categor√≠a
                                                        </label>
                                                    </th:block>
                                                </th:block>
                                                <th:block th:if="${#lists.isEmpty(categoriaMateriales)}">
                                                    <span class="text-muted small">No hay categor√≠as registradas</span>
                                                </th:block>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Filtro de Tipo con radio buttons -->
                                    <div class="row g-3 mb-3">
                                        <div class="col-12">
                                            <span class="form-label fw-semibold text-muted d-block mb-2">
                                                <i class="bi bi-shuffle me-1"></i>Tipo
                                            </span>
                                            <div class="btn-group flex-wrap gap-2" role="group" aria-label="Filtro tipo">
                                                <input type="radio" class="btn-check" name="filtroTipo" id="filtroTipoNone" value="" autocomplete="off" checked>
                                                <label class="btn btn-outline-success" for="filtroTipoNone">Ninguno</label>
                                                <th:block th:if="${not #lists.isEmpty(tiposMateriales)}">
                                                    <th:block th:each="tipo, iter : ${tiposMateriales}">
                                                        <input type="radio" class="btn-check" name="filtroTipo"
                                                               th:id="${'filtroTipo_' + iter.index}" th:value="${tipo.nmbCategoria}" autocomplete="off">
                                                        <label class="btn btn-outline-success"
                                                               th:for="${'filtroTipo_' + iter.index}" th:text="${tipo.nmbCategoria}">
                                                            Tipo
                                                        </label>
                                                    </th:block>
                                                </th:block>
                                                <th:block th:if="${#lists.isEmpty(tiposMateriales)}">
                                                    <span class="text-muted small">No hay tipos registrados</span>
                                                </th:block>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="row">
                                        <div class="col-12">
                                            <small class="text-muted">Selecciona los filtros que desees aplicar o deja en "Ninguno" para no filtrar por esa opci√≥n.</small>
                                        </div>
                                    </div>

                                    <div class="row mt-4">
                                        <div class="col-12 d-flex flex-wrap gap-3 justify-content-between align-items-center">
                                            <div>
                                                <span class="badge bg-info text-dark" id="resultadosInfo" style="display:none;">
                                                    <i class="bi bi-funnel me-1"></i>Filtros Activos: <span id="contadorFiltros">0</span>
                                                </span>
                                                <span class="badge bg-success" id="resultadosCount" style="display:none;">
                                                    Mostrando <span id="resultadosCountNum">0</span> de <span id="totalCount">0</span>
                                                </span>
                                            </div>
                                            <div class="d-flex gap-2">
                                                <button class="btn btn-success"
                                                        type="button"
                                                        id="btnAplicarFiltros">
                                                    <i class="bi bi-check-circle me-1"></i>Aplicar Filtros
                                                </button>
                                                <button class="btn btn-outline-secondary"
                                                        type="button"
                                                        id="btnRestablecerFiltros">
                                                    <i class="bi bi-arrow-clockwise me-1"></i>Restablecer
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                    <div th:if="${mensajeAlerta != null and !#strings.isEmpty(mensajeAlerta)}" class="alert alert-warning" role="alert">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        <strong th:text="${mensajeAlerta}">Mensaje de alerta</strong>
                    </div>

                    <div th:if="${#lists.isEmpty(inventario) and (mensajeAlerta == null or #strings.isEmpty(mensajeAlerta))}" class="alert alert-info" role="alert">
                        <i class="bi bi-info-circle me-2"></i>
                        <strong>Sin materiales</strong> - No hay materiales registrados en el inventario.
                    </div>

                    <div class="row g-4" th:if="${not #lists.isEmpty(inventario)}" id="contenedorMateriales">
                        <div class="col-12 col-md-6 col-lg-4 tarjeta-material"
                             th:each="inventario : ${inventario}"
                             th:data-nombre-material="${inventario.nombreMaterial()}"
                             th:data-unidad-medida="${inventario.unidadMedida()}"
                             th:with="ocupacion = ${(inventario.stockActual() / inventario.capacidadMaxima() * 100).intValue()}">
                            <!-- Tarjeta de Material -->
                            <div class="card h-100 shadow-sm border-0 transition"
                                 style="transition: all 0.3s ease;"
                                 th:classappend="${ocupacion >= inventario.umbralCritico() ? 'estado-critico' : (ocupacion >= inventario.umbralAlerta() ? 'estado-alerta' : 'estado-ok')}"
                                 th:data-ocupacion="${ocupacion}"
                                 th:data-estado="${ocupacion >= inventario.umbralCritico() ? 'critico' : (ocupacion >= inventario.umbralAlerta() ? 'alerta' : 'ok')}"
                                 th:data-stock-actual="${inventario.stockActual()}"
                                 th:data-capacidad-maxima="${inventario.capacidadMaxima()}">
                                <div class="card-header bg-success text-white d-flex justify-content-between align-items-start">
                                    <div>
                                        <h5 class="card-title mb-1" th:text="${inventario.nombreMaterial()}">Material</h5>
                                        <small class="text-light" th:text="${inventario.unidadMedida()}">Unidad</small>
                                    </div>
                                    <span class="badge bg-info" th:text="${inventario.unidadMedida()}">Unidad</span>
                                </div>

                                <div class="card-body">
                                    <!-- Datos principales -->
                                    <div class="row mb-3">
                                        <div class="col-6">
                                            <small class="text-muted">Stock Actual</small>
                                            <p class="fw-bold text-success" th:text="${#numbers.formatDecimal(inventario.stockActual(), 1, 'COMMA', 2, 'POINT')}">0.00</p>
                                        </div>
                                        <div class="col-6">
                                            <small class="text-muted">Capacidad M√°xima</small>
                                            <p class="fw-bold text-primary" th:text="${#numbers.formatDecimal(inventario.capacidadMaxima(), 1, 'COMMA', 2, 'POINT')}">0.00</p>
                                        </div>
                                    </div>

                                    <!-- Indicador de ocupaci√≥n con c√≥digo de color -->
                                    <div class="mb-3">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <small class="text-muted">% Ocupaci√≥n</small>
                                            <th:block th:with="ocupacion = ${(inventario.stockActual() / inventario.capacidadMaxima() * 100).intValue()}">
                                                <small class="fw-bold"
                                                       th:classappend="${ocupacion >= inventario.umbralCritico() ? 'text-danger' : (ocupacion >= inventario.umbralAlerta() ? 'text-warning' : 'text-success')}"
                                                       th:text="${ocupacion} + '%'">
                                                    0%
                                                </small>
                                            </th:block>
                                        </div>
                                        <th:block th:with="ocupacion = ${(inventario.stockActual() / inventario.capacidadMaxima() * 100).intValue()}">
                                            <div class="progress" style="height: 20px;">
                                                <div class="progress-bar"
                                                     th:classappend="${ocupacion >= inventario.umbralCritico() ? 'bg-danger' : (ocupacion >= inventario.umbralAlerta() ? 'bg-warning' : 'bg-success')}"
                                                     role="progressbar"
                                                     th:attr="aria-valuenow=${ocupacion}, aria-valuemin='0', aria-valuemax='100'"
                                                     th:style="'width: ' + ${ocupacion} + '%'">
                                                    <small class="d-flex align-items-center justify-content-center h-100 text-dark fw-bold" th:text="${ocupacion} + '%'">0%</small>
                                                </div>
                                            </div>
                                        </th:block>
                                    </div>

                                    <!-- Informaci√≥n de precios -->
                                    <hr class="my-2">
                                    <div class="row small mb-3">
                                        <div class="col-6">
                                            <small class="text-muted">Precio Compra</small>
                                            <p class="text-dark mb-0" th:text="${inventario.precioCompra() != null ? '$ ' + #numbers.formatDecimal(inventario.precioCompra(), 1, 'COMMA', 2, 'POINT') : 'N/A'}">$ 0.00</p>
                                        </div>
                                        <div class="col-6">
                                            <small class="text-muted">Precio Venta</small>
                                            <p class="text-dark mb-0" th:text="${inventario.precioVenta() != null ? '$ ' + #numbers.formatDecimal(inventario.precioVenta(), 1, 'COMMA', 2, 'POINT') : 'N/A'}">$ 0.00</p>
                                        </div>
                                    </div>

                                    <!-- Umbral de alerta -->
                                    <div class="alert alert-light border border-warning p-2 mb-0" role="alert">
                                        <small class="text-muted">Umbrales:</small>
                                        <div class="d-flex justify-content-between mt-1">
                                            <small>
                                                <span class="badge bg-warning">Alerta: <span th:text="${inventario.umbralAlerta()}">0</span>%</span>
                                            </small>
                                            <small>
                                                <span class="badge bg-danger">Cr√≠tico: <span th:text="${inventario.umbralCritico()}">0</span>%</span>
                                            </small>
                                        </div>
                                    </div>
                                </div>

                                <!-- Bot√≥n de detalles -->
                                <div class="card-footer bg-light border-top d-grid gap-2">
                                    <button type="button" class="btn btn-success btn-sm detallesBtn"
                                            th:data-inventario-id="${inventario.inventarioId() != null ? inventario.inventarioId() : ''}"
                                            th:data-material-id="${inventario.materialId() != null ? inventario.materialId() : ''}"
                                            th:data-nombre-material="${inventario.nombreMaterial()}"
                                            th:data-stock-actual="${inventario.stockActual()}"
                                            th:data-capacidad-maxima="${inventario.capacidadMaxima()}"
                                            th:data-precio-compra="${inventario.precioCompra() != null ? inventario.precioCompra() : 0}"
                                            th:data-precio-venta="${inventario.precioVenta() != null ? inventario.precioVenta() : 0}"
                                            th:data-umbral-alerta="${inventario.umbralAlerta()}"
                                            th:data-umbral-critico="${inventario.umbralCritico()}"
                                            th:data-unidad-medida="${inventario.unidadMedida()}">
                                        <i class="bi bi-eye me-1"></i> Ver Detalles
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    </div>

    <!-- MODALS: reemplazo por la versi√≥n global solicitada -->

    <!-- MODAL GLOBAL - DISPONIBLE EN TODAS LAS P√ÅGINAS -->
    <div class="modal fade" id="detallesModal" tabindex="-1" aria-labelledby="detallesModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content border-0 shadow-lg rounded-3">
                <!-- Header con fondo verde -->
                <div class="modal-header border-0 bg-success text-white p-4 rounded-top-3">
                    <div>
                        <h5 class="modal-title fw-bold fs-5" id="detallesModalLabel">
                            <i class="bi bi-box-seam me-2"></i><span id="modalHeaderNombre">Detalles del Material</span>
                        </h5>
                        <small class="text-white-50"><i class="bi bi-info-circle me-1"></i>Informaci√≥n completa del inventario</small>
                    </div>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <div class="modal-body p-0">
                    <!-- Secci√≥n 1: Informaci√≥n B√°sica -->
                    <div class="p-4 border-bottom bg-light">
                        <h6 class="text-success mb-3 fw-bold"><i class="bi bi-info-circle me-2"></i>Informaci√≥n B√°sica</h6>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="p-3 rounded-2 bg-light border-start border-4 border-success">
                                    <small class="text-muted d-block mb-1"><i class="bi bi-tag me-1"></i>Nombre del Material</small>
                                    <p class="h6 text-success fw-bold mb-0" id="modalNombreMaterial">-</p>
                                </div>
                            </div>
                            <div class="col-md-6 d-none">
                                <div class="p-3 rounded-2 bg-light border-start border-4 border-primary">
                                    <small class="text-muted d-block mb-1"><i class="bi bi-code-square me-1"></i>ID del Material</small>
                                    <p class="h6 font-monospace text-primary fw-bold mb-0" id="modalMaterialId">-</p>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="p-3 rounded-2 bg-warning bg-opacity-10 border-start border-4 border-warning">
                                    <small class="text-muted d-block mb-1"><i class="bi bi-rulers me-1"></i>Unidad de Medida</small>
                                    <p class="h6 fw-bold mb-0" id="modalUnidadMedida">-</p>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="p-3 rounded-2 bg-danger bg-opacity-10 border-start border-4 border-danger">
                                    <small class="text-muted d-block mb-1"><i class="bi bi-circle-fill me-1" id="modalEstadoIcon"></i>Estado Actual</small>
                                    <p class="h6 fw-bold mb-0" id="modalEstadoText">-</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Secci√≥n 2: Ocupaci√≥n -->
                    <div class="p-4 border-bottom">
                        <h6 class="text-success mb-3 fw-bold"><i class="bi bi-pie-chart me-2"></i>Ocupaci√≥n del Inventario <span class="badge bg-success" id="modalOcupacionPorcentaje">0%</span></h6>
                        <div class="progress rounded-pill" style="height: 40px;">
                            <div id="modalOcupacionBar" class="progress-bar d-flex align-items-center justify-content-center fw-bold text-white fs-6">
                                <small id="modalOcupacionText">0%</small>
                            </div>
                        </div>
                    </div>

                    <!-- Secci√≥n 3: Stock e Inventario -->
                    <div class="p-4 border-bottom bg-light">
                        <h6 class="text-success mb-3 fw-bold"><i class="bi bi-inbox me-2"></i>Inventario</h6>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="p-3 rounded-2 bg-white border border-success border-opacity-25 border-start border-4 border-success">
                                    <small class="text-muted d-block mb-1"><i class="bi bi-inbox me-1"></i>Stock Actual</small>
                                    <p class="h5 text-success fw-bold mb-1" id="modalStockActual">0.00</p>
                                    <small class="text-muted" id="modalStockUnidad">unidades</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="p-3 rounded-2 bg-white border border-primary border-opacity-25 border-start border-4 border-primary">
                                    <small class="text-muted d-block mb-1"><i class="bi bi-archive me-1"></i>Capacidad M√°xima</small>
                                    <p class="h5 text-primary fw-bold mb-1" id="modalCapacidadMaxima">0.00</p>
                                    <small class="text-muted" id="modalCapacidadUnidad">unidades</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="p-3 rounded-2 bg-white border border-info border-opacity-25 border-start border-4 border-info">
                                    <small class="text-muted d-block mb-1"><i class="bi bi-diagram-3 me-1"></i>Espacio Usado</small>
                                    <p class="h5 text-info fw-bold mb-0" id="modalEspacioUsado">0.00</p>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="p-3 rounded-2 bg-white border border-warning border-opacity-25 border-start border-4 border-warning">
                                    <small class="text-muted d-block mb-1"><i class="bi bi-diagram-3 me-1"></i>Espacio Disponible</small>
                                    <p class="h5 text-warning fw-bold mb-0" id="modalEspacioDisponible">0.00</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Secci√≥n 4: Precios y M√°rgenes -->
                    <div class="p-4 border-bottom">
                        <h6 class="text-success mb-3 fw-bold"><i class="bi bi-tag-fill me-2"></i>An√°lisis de Precios</h6>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="p-3 rounded-2 bg-primary bg-opacity-10 border-start border-4 border-primary">
                                    <small class="text-muted d-block mb-1"><i class="bi bi-cart-plus me-1"></i>Precio de Compra</small>
                                    <p class="h5 text-primary fw-bold mb-0" id="modalPrecioCompra">$ 0.00</p>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="p-3 rounded-2 bg-warning bg-opacity-10 border-start border-4 border-warning">
                                    <small class="text-muted d-block mb-1"><i class="bi bi-cart-check me-1"></i>Precio de Venta</small>
                                    <p class="h5 text-warning fw-bold mb-0" id="modalPrecioVenta">$ 0.00</p>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="p-3 rounded-2 bg-danger bg-opacity-10 border-start border-4 border-danger">
                                    <small class="text-muted d-block mb-1"><i class="bi bi-percent me-1"></i>Margen de Ganancia</small>
                                    <p class="h5 text-danger fw-bold mb-0" id="modalMargenGanancia">$ 0.00</p>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="p-3 rounded-2 bg-success bg-opacity-10 border-start border-4 border-success">
                                    <small class="text-muted d-block mb-1"><i class="bi bi-percent me-1"></i>% Margen</small>
                                    <p class="h5 text-success fw-bold mb-0" id="modalPorcentajeMargen">0%</p>
                                </div>
                            </div>
                            <div class="col-12">
                                <div class="p-3 rounded-2 bg-white border-3 border-success">
                                    <small class="text-muted d-block mb-1"><i class="bi bi-calculator me-1 text-success"></i>Valor Total en Inventario</small>
                                    <p class="h4 text-success fw-bold mb-0" id="modalValorTotal">$ 0.00</p>
                                    <small class="text-muted">(Stock Actual √ó Precio Compra)</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Secci√≥n 5: Umbrales y Alertas -->
                    <div class="p-4 border-bottom bg-light">
                        <h6 class="text-success mb-3 fw-bold"><i class="bi bi-exclamation-triangle me-2"></i>Umbrales y Alertas</h6>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="p-3 rounded-2 bg-warning bg-opacity-10 border-start border-4 border-warning">
                                    <small class="text-muted d-block mb-1"><i class="bi bi-exclamation-triangle me-1"></i>Umbral de Alerta</small>
                                    <p class="h5 text-warning fw-bold mb-0" id="modalUmbralAlerta">0%</p>
                                    <small class="text-muted">Se activa al superar este %</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="p-3 rounded-2 bg-danger bg-opacity-10 border-start border-4 border-danger">
                                    <small class="text-muted d-block mb-1"><i class="bi bi-exclamation-octagon me-1"></i>Umbral Cr√≠tico</small>
                                    <p class="h5 text-danger fw-bold mb-0" id="modalUmbralCritico">0%</p>
                                    <small class="text-muted">Requiere atenci√≥n inmediata</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Indicador de Estado -->
                    <div class="p-4 border-bottom" id="modalEstadoIndicador"></div>

                    <!-- Resumen de Alertas -->
                    <div class="p-4" id="modalResumenAlertas"></div>
                </div>

                <div class="modal-footer bg-light border-top">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle me-1"></i>Cerrar
                    </button>
                    <button type="button" class="btn btn-warning" id="btnEditarMaterial">
                        <i class="bi bi-pencil me-1"></i>Editar
                    </button>
                    <button type="button" class="btn btn-danger" id="btnBorrarMaterial">
                        <i class="bi bi-trash me-1"></i>Borrar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL EDITAR - PARA EDITAR DATOS DEL INVENTARIO -->
    <div class="modal fade" id="editarModal" tabindex="-1" aria-labelledby="editarModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content border-0 shadow-lg rounded-3">
                <!-- Header -->
                <div class="modal-header border-0 bg-warning text-dark p-4 rounded-top-3">
                    <div>
                        <h5 class="modal-title fw-bold fs-5" id="editarModalLabel">
                            <i class="bi bi-pencil-square me-2"></i>Editar Inventario
                        </h5>
                        <small class="text-secondary"><i class="bi bi-info-circle me-1"></i>Actualiza los datos del material</small>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <div class="modal-body p-4">
                    <form id="formularioEditarInventario">
                        <!-- Material ID (oculto) -->
                        <input type="hidden" id="editarMaterialId" value="">

                        <!-- Row 1: Stock y Capacidad -->
                        <div class="row g-3 mb-4">
                            <div class="col-md-6">
                                <label for="editarStockActual" class="form-label fw-bold">
                                    <i class="bi bi-inbox text-success me-2"></i>Stock Actual
                                </label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="editarStockActual" step="0.01" required>
                                    <span class="input-group-text" id="editarStockUnidad">un.</span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label for="editarCapacidadMaxima" class="form-label fw-bold">
                                    <i class="bi bi-archive text-primary me-2"></i>Capacidad M√°xima
                                </label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="editarCapacidadMaxima" step="0.01" required>
                                    <span class="input-group-text" id="editarCapacidadUnidad">un.</span>
                                </div>
                            </div>
                        </div>

                        <!-- Row 1.5: Unidad de Medida -->
                        <div class="row g-3 mb-4">
                            <div class="col-md-6">
                                <label for="editarUnidadMedida" class="form-label fw-bold">
                                    <i class="bi bi-rulers text-warning me-2"></i>Unidad de Medida
                                </label>
                                <select class="form-select" id="editarUnidadMedida" required>
                                    <option value="">-- Seleccionar unidad --</option>
                                    <th:block th:if="${not #lists.isEmpty(unidadesMedida)}">
                                        <option th:each="unidad : ${unidadesMedida}"
                                                th:value="${unidad.clave}"
                                                th:text="${unidad.nombre}">Unidad</option>
                                    </th:block>
                                </select>
                                <small class="text-muted d-block mt-2">Selecciona la unidad de medida del material</small>
                            </div>
                        </div>

                        <!-- Row 2: Precios -->
                        <div class="row g-3 mb-4">
                            <div class="col-md-6">
                                <label for="editarPrecioCompra" class="form-label fw-bold">
                                    <i class="bi bi-cart-plus text-info me-2"></i>Precio de Compra
                                </label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input type="number" class="form-control" id="editarPrecioCompra" step="0.01" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label for="editarPrecioVenta" class="form-label fw-bold">
                                    <i class="bi bi-cart-check text-warning me-2"></i>Precio de Venta
                                </label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input type="number" class="form-control" id="editarPrecioVenta" step="0.01" required>
                                </div>
                            </div>
                        </div>

                        <!-- Row 3: Umbrales -->
                        <div class="row g-3 mb-4">
                            <div class="col-md-6">
                                <label for="editarUmbralAlerta" class="form-label fw-bold">
                                    <i class="bi bi-exclamation-triangle text-warning me-2"></i>Umbral de Alerta (%)
                                </label>
                                <input type="number" class="form-control" id="editarUmbralAlerta" min="0" max="100" required>
                            </div>
                            <div class="col-md-6">
                                <label for="editarUmbralCritico" class="form-label fw-bold">
                                    <i class="bi bi-exclamation-octagon text-danger me-2"></i>Umbral Cr√≠tico (%)
                                </label>
                                <input type="number" class="form-control" id="editarUmbralCritico" min="0" max="100" required>
                            </div>
                        </div>

                        <!-- Resumen de cambios -->
                        <div class="alert alert-info rounded-2" role="alert">
                            <i class="bi bi-info-circle me-2"></i>
                            <strong>Nota:</strong> Los cambios se guardar√°n en la base de datos. Aseg√∫rate de verificar los datos antes de guardar.
                        </div>
                    </form>
                </div>

                <div class="modal-footer bg-light border-top">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle me-1"></i>Cancelar
                    </button>
                    <button type="button" class="btn btn-warning" id="btnGuardarCambios">
                        <i class="bi bi-check-circle me-1"></i>Guardar Cambios
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Resultado del Guardado (√âxito o Error) -->
    <div class="modal fade" id="modalResultadoGuardado" tabindex="-1" aria-labelledby="modalResultadoLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-body p-5 text-center">
                    <!-- Icono din√°mico -->
                    <div class="mb-4">
                        <i id="iconoResultado" class="bi bi-check-circle text-success" style="font-size: 4rem;"></i>
                    </div>
                    <!-- T√≠tulo din√°mico -->
                    <h5 id="tituloResultado" class="fw-bold mb-3 text-success" style="font-size: 1.5rem;">
                        ¬°Operaci√≥n Exitosa!
                    </h5>
                    <!-- Mensaje din√°mico -->
                    <p id="mensajeResultado" class="text-muted mb-0" style="font-size: 1rem;">
                        Los cambios se han guardado correctamente en la base de datos.
                    </p>
                </div>
                <div class="modal-footer bg-light border-top">
                    <button type="button" class="btn btn-success" id="btnOkResultado">
                        <i class="bi bi-check-circle me-1"></i>OK
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de √âxito en Actualizaci√≥n -->
    <div class="modal fade" id="modalExitoActualizacion" tabindex="-1" aria-labelledby="modalExitoLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-body p-4 text-center">
                    <div class="mb-3">
                        <i class="bi bi-check-circle text-success" style="font-size: 3rem;"></i>
                    </div>
                    <h5 class="modal-title fw-bold text-success mb-2" id="modalExitoLabel">¬°Operaci√≥n Exitosa!</h5>
                    <p class="text-muted mb-0">Los cambios se han guardado correctamente en la base de datos.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Resumen de Actualizaci√≥n -->
    <div class="modal fade" id="modalResumenActualizacion" tabindex="-1" aria-labelledby="modalResumenLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-header bg-success text-white border-0">
                    <h5 class="modal-title fw-bold" id="modalResumenLabel">
                        <i class="bi bi-info-circle me-2"></i>Datos Actualizados
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <div class="modal-body p-4">
                    <!-- Informaci√≥n del Material -->
                    <div class="mb-4">
                        <h6 class="text-success fw-bold mb-3">
                            <i class="bi bi-tag me-2"></i>Informaci√≥n del Material
                        </h6>
                        <div class="alert alert-light border-start border-4 border-success">
                            <p class="mb-1">
                                <strong>Nombre:</strong>
                                <span id="resumenNombreMaterial">-</span>
                            </p>
                            <p class="mb-0">
                                <strong>Ubicaci√≥n:</strong>
                                <span id="resumenNombrePunto">-</span>
                            </p>
                        </div>
                    </div>

                    <!-- Stock e Inventario -->
                    <div class="mb-4">
                        <h6 class="text-info fw-bold mb-3">
                            <i class="bi bi-boxes me-2"></i>Stock e Inventario
                        </h6>
                        <div class="row g-2">
                            <div class="col-md-6">
                                <div class="p-3 rounded-2 bg-info bg-opacity-10 border-start border-4 border-info">
                                    <small class="text-muted">Stock Actual</small>
                                    <p class="h6 fw-bold mb-0" id="resumenStockActual">-</p>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="p-3 rounded-2 bg-warning bg-opacity-10 border-start border-4 border-warning">
                                    <small class="text-muted">Capacidad M√°xima</small>
                                    <p class="h6 fw-bold mb-0" id="resumenCapacidadMaxima">-</p>
                                </div>
                            </div>
                        </div>
                        <div class="mt-2">
                            <div class="p-3 rounded-2 bg-secondary bg-opacity-10 border-start border-4 border-secondary">
                                <small class="text-muted">Unidad de Medida</small>
                                <p class="h6 fw-bold mb-0" id="resumenUnidadMedida">-</p>
                            </div>
                        </div>
                    </div>

                    <!-- Precios -->
                    <div class="mb-4">
                        <h6 class="text-danger fw-bold mb-3">
                            <i class="bi bi-currency-dollar me-2"></i>Precios
                        </h6>
                        <div class="row g-2">
                            <div class="col-md-6">
                                <div class="p-3 rounded-2 bg-danger bg-opacity-10 border-start border-4 border-danger">
                                    <small class="text-muted">Precio de Compra</small>
                                    <p class="h6 fw-bold mb-0" id="resumenPrecioCompra">-</p>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="p-3 rounded-2 bg-success bg-opacity-10 border-start border-4 border-success">
                                    <small class="text-muted">Precio de Venta</small>
                                    <p class="h6 fw-bold mb-0" id="resumenPrecioVenta">-</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Umbrales -->
                    <div>
                        <h6 class="text-warning fw-bold mb-3">
                            <i class="bi bi-exclamation-triangle me-2"></i>Umbrales de Alerta
                        </h6>
                        <div class="row g-2">
                            <div class="col-md-6">
                                <div class="p-3 rounded-2 bg-warning bg-opacity-10 border-start border-4 border-warning">
                                    <small class="text-muted">Umbral Alerta</small>
                                    <p class="h6 fw-bold mb-0" id="resumenUmbralAlerta">-</p>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="p-3 rounded-2 bg-danger bg-opacity-10 border-start border-4 border-danger">
                                    <small class="text-muted">Umbral Cr√≠tico</small>
                                    <p class="h6 fw-bold mb-0" id="resumenUmbralCritico">-</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="modal-footer bg-light border-top">
                    <button type="button" class="btn btn-success" data-bs-dismiss="modal" id="btnCerrarResumen">
                        <i class="bi bi-check-circle me-1"></i>Cerrar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- SCRIPT PARA MANEJO DE MODALES -->
    <script>
        // ====================================================================
        // FUNCI√ìN GLOBAL: Mostrar Modal de Resultado
        // ====================================================================
        function mostrarModalResultado(esExito, titulo, mensaje) {
            console.log('üîî Mostrando modal de resultado:', { esExito, titulo, mensaje });

            const modalEl = document.getElementById('modalResultadoGuardado');
            if (!modalEl) {
                console.error('‚ùå Modal de resultado no encontrado');
                alert(titulo + '\n' + mensaje);
                return;
            }

            // Actualizar contenido
            const icono = document.getElementById('iconoResultado');
            const tituloEl = document.getElementById('tituloResultado');
            const mensajeEl = document.getElementById('mensajeResultado');

            if (icono) {
                if (esExito) {
                    icono.className = 'bi bi-check-circle text-success';
                } else {
                    icono.className = 'bi bi-exclamation-circle text-danger';
                }
                icono.style.fontSize = '4rem';
            }

            if (tituloEl) {
                tituloEl.textContent = titulo;
                tituloEl.style.fontSize = '1.5rem';
                tituloEl.className = esExito ? 'fw-bold mb-3 text-success' : 'fw-bold mb-3 text-danger';
            }

            if (mensajeEl) {
                mensajeEl.textContent = mensaje;
            }

            // Configurar bot√≥n OK
            const btnOkResultado = document.getElementById('btnOkResultado');
            if (btnOkResultado) {
                // Limpiar eventos previos
                btnOkResultado.onclick = null;
                btnOkResultado.onclick = function() {
                    console.log('‚úì Bot√≥n OK presionado. Recargando p√°gina...');
                    // Cerrar modal usando Bootstrap
                    const bsModal = bootstrap.Modal.getInstance(modalEl);
                    if (bsModal) {
                        bsModal.hide();
                    } else {
                        modalEl.classList.remove('show');
                        const backdrop = document.querySelector('.modal-backdrop');
                        if (backdrop) backdrop.remove();
                    }
                    // Recargar p√°gina
                    setTimeout(() => {
                        window.location.reload(true);
                    }, 300);
                };
            }

            // Mostrar modal
            try {
                const modal = new bootstrap.Modal(modalEl, {
                    backdrop: 'static',
                    keyboard: false
                });
                console.log('‚úì Modal creado, mostrando...');
                modal.show();
                console.log('‚úì Modal mostrado exitosamente');
            } catch (err) {
                console.error('‚ùå Error mostrando modal:', err);
                alert(titulo + '\n' + mensaje);
            }
        }

        // ====================================================================
        // IIFE: Sistema de Modales
        // ====================================================================
        (function() {
            let detallesModalInstance = null;
            let editarModalInstance = null;
            let isInitialized = false;

            function inicializarModales() {
                // Esperar a que bootstrap est√© disponible
                if (typeof bootstrap === 'undefined') {
                    console.warn('‚ö† Bootstrap no est√° disponible a√∫n, reintentando...');
                    setTimeout(inicializarModales, 100);
                    return;
                }

                const detallesModalEl = document.getElementById('detallesModal');
                const editarModalEl = document.getElementById('editarModal');

                if (detallesModalEl) {
                    detallesModalInstance = new bootstrap.Modal(detallesModalEl, { backdrop: 'static' });
                    console.log('‚úì Modal de detalles inicializado');
                }
                if (editarModalEl) {
                    editarModalInstance = new bootstrap.Modal(editarModalEl, { backdrop: 'static' });
                    console.log('‚úì Modal de editar inicializado');
                }
            }

            function configurarEventListeners() {
                // Usar delegaci√≥n de eventos a nivel de documento para mayor robustez
                document.removeEventListener('click', manejarClickGlobal);
                document.addEventListener('click', manejarClickGlobal);
                console.log('‚úì Event listeners configurados globalmente');
            }

            function manejarClickGlobal(e) {
                const btn = e.target.closest('.detallesBtn');
                if (!btn) return;

                console.log('‚úì Clic en bot√≥n de detalles detectado');
                manejarClickTarjeta(btn);
            }

            function manejarClickTarjeta(btn) {
                const nombre = btn.dataset.nombreMaterial || '-';
                const materialId = btn.dataset.materialId || '';
                const stock = parseFloat(btn.dataset.stockActual || 0) || 0;
                const capacidad = parseFloat(btn.dataset.capacidadMaxima || 0) || 0;
                const precioCompra = btn.dataset.precioCompra || '0';
                const precioVenta = btn.dataset.precioVenta || '0';
                const umbralAlerta = parseInt(btn.dataset.umbralAlerta || 0) || 0;
                const umbralCritico = parseInt(btn.dataset.umbralCritico || 0) || 0;
                const unidad = btn.dataset.unidadMedida || '';
                const inventarioId = btn.dataset.inventarioId || '';

                console.log('Material:', { nombre, stock, capacidad, inventarioId });

                // Rellenar campos del modal detalles
                const setText = (id, text) => {
                    const el = document.getElementById(id);
                    if (el) {
                        el.textContent = text;
                    }
                };

                setText('modalHeaderNombre', 'Detalles del Material');
                setText('modalNombreMaterial', nombre);
                setText('modalMaterialId', materialId);
                setText('modalUnidadMedida', unidad || '-');
                setText('modalStockActual', Number(stock).toFixed(2));
                setText('modalStockUnidad', unidad || 'unidades');
                setText('modalCapacidadMaxima', Number(capacidad).toFixed(2));
                setText('modalCapacidadUnidad', unidad || 'unidades');
                const espacioUsado = (capacidad > 0) ? (stock).toFixed(2) : '0.00';
                const espacioDisp = (capacidad > 0) ? (Math.max(capacidad - stock, 0)).toFixed(2) : '0.00';
                setText('modalEspacioUsado', espacioUsado);
                setText('modalEspacioDisponible', espacioDisp);
                setText('modalPrecioCompra', '$ ' + Number(precioCompra).toFixed(2));
                setText('modalPrecioVenta', '$ ' + Number(precioVenta).toFixed(2));
                const margen = (Number(precioVenta) - Number(precioCompra)) || 0;
                setText('modalMargenGanancia', '$ ' + margen.toFixed(2));
                const pctMargen = (Number(precioCompra) > 0) ? Math.round((margen / Number(precioCompra)) * 100) + '%' : '0%';
                setText('modalPorcentajeMargen', pctMargen);
                const valorTotal = (Number(stock) * Number(precioCompra)) || 0;
                setText('modalValorTotal', '$ ' + Number(valorTotal).toFixed(2));
                setText('modalUmbralAlerta', umbralAlerta + '%');
                setText('modalUmbralCritico', umbralCritico + '%');

                // Ocupaci√≥n
                const porcentaje = ponerEstadoOcupacion(stock, capacidad);
                setText('modalOcupacionPorcentaje', porcentaje + '%');
                const barra = document.getElementById('modalOcupacionBar');
                const textoBar = document.getElementById('modalOcupacionText');
                if (barra && textoBar) {
                    const estado = aplicarColorBarra(barra, porcentaje, umbralAlerta, umbralCritico);
                    textoBar.textContent = porcentaje + '%';
                    const estadoTextEl = document.getElementById('modalEstadoText');
                    const estadoIconEl = document.getElementById('modalEstadoIcon');
                    if (estadoTextEl) estadoTextEl.textContent = estado;
                    if (estadoIconEl) {
                        estadoIconEl.className = 'bi bi-circle-fill me-1';
                        if (estado === 'Cr√≠tico') estadoIconEl.classList.add('text-danger');
                        else if (estado === 'Alerta') estadoIconEl.classList.add('text-warning');
                        else estadoIconEl.classList.add('text-success');
                    }
                }

                // Guardar id en botones del modal
                const btnEditar = document.getElementById('btnEditarMaterial');
                const btnBorrar = document.getElementById('btnBorrarMaterial');
                if (btnEditar) {
                    btnEditar.dataset.inventarioId = inventarioId;
                    btnEditar.dataset.materialId = materialId;
                    btnEditar.dataset.stock = stock;
                    btnEditar.dataset.capacidad = capacidad;
                    btnEditar.dataset.unidad = unidad;
                    btnEditar.dataset.precioCompra = precioCompra;
                    btnEditar.dataset.precioVenta = precioVenta;
                    btnEditar.dataset.umbralAlerta = umbralAlerta;
                    btnEditar.dataset.umbralCritico = umbralCritico;
                }
                if (btnBorrar) {
                    btnBorrar.dataset.inventarioId = inventarioId;
                    btnBorrar.dataset.nombreMaterial = nombre;
                }

                // Mostrar modal detalles
                if (detallesModalInstance) {
                    console.log('‚úì Abriendo modal de detalles');
                    detallesModalInstance.show();
                } else {
                    console.error('‚úó detallesModalInstance no est√° inicializado');
                }
            }

            function ponerEstadoOcupacion(stock, capacidad) {
                const pct = (capacidad && capacidad > 0) ? Math.round((stock / capacidad) * 100) : 0;
                return Math.min(Math.max(pct, 0), 100);
            }

            function aplicarColorBarra(barEl, porcentaje, umbralAlerta, umbralCritico) {
                barEl.style.width = porcentaje + '%';
                barEl.className = 'progress-bar d-flex align-items-center justify-content-center fw-bold text-white fs-6';
                if (porcentaje >= (umbralCritico || 100)) {
                    barEl.classList.add('bg-danger');
                    return 'Cr√≠tico';
                }
                if (porcentaje >= (umbralAlerta || 50)) {
                    barEl.classList.add('bg-warning');
                    return 'Alerta';
                }
                barEl.classList.add('bg-success');
                return 'OK';
            }

            // Abrir modal editar y rellenar campos
            function configurarBtnEditar() {
                const btnEditarModal = document.getElementById('btnEditarMaterial');
                if (btnEditarModal) {
                    btnEditarModal.removeEventListener('click', abrirModalEditar);
                    btnEditarModal.addEventListener('click', abrirModalEditar);
                }
            }

            function abrirModalEditar() {
                const inventarioId = this.dataset.inventarioid || this.dataset.inventarioId || '';
                const materialId = this.dataset.materialid || this.dataset.materialId || '';
                const stock = this.dataset.stock || '';
                const capacidad = this.dataset.capacidad || '';
                const unidad = this.dataset.unidad || '';
                const precioCompra = this.dataset.preciocompra || this.dataset.precioCompra || '0';
                const precioVenta = this.dataset.precioventa || this.dataset.precioVenta || '0';
                const umbralAlerta = this.dataset.umbralalerta || this.dataset.umbralAlerta || '0';
                const umbralCritico = this.dataset.umbralcritico || this.dataset.umbralCritico || '0';

                console.log('Abriendo modal editar con inventarioId:', inventarioId);

                const inputHidden = document.getElementById('editarMaterialId');
                if (inputHidden) inputHidden.value = inventarioId || materialId || '';

                const inputStock = document.getElementById('editarStockActual');
                if (inputStock) inputStock.value = stock;

                const inputCapacidad = document.getElementById('editarCapacidadMaxima');
                if (inputCapacidad) inputCapacidad.value = capacidad;

                const selectUnidad = document.getElementById('editarUnidadMedida');
                if (selectUnidad && unidad) {
                    const opt = Array.from(selectUnidad.options).find(o => o.value === unidad || o.text === unidad);
                    if (opt) selectUnidad.value = opt.value;
                }

                const inputPrecioCompra = document.getElementById('editarPrecioCompra');
                if (inputPrecioCompra) inputPrecioCompra.value = precioCompra;

                const inputPrecioVenta = document.getElementById('editarPrecioVenta');
                if (inputPrecioVenta) inputPrecioVenta.value = precioVenta;

                const inputUmbralAlerta = document.getElementById('editarUmbralAlerta');
                if (inputUmbralAlerta) inputUmbralAlerta.value = umbralAlerta;

                const inputUmbralCritico = document.getElementById('editarUmbralCritico');
                if (inputUmbralCritico) inputUmbralCritico.value = umbralCritico;

                if (detallesModalInstance) detallesModalInstance.hide();
                if (editarModalInstance) {
                    console.log('‚úì Abriendo modal de editar');
                    editarModalInstance.show();
                }
            }

            // Configurar bot√≥n de guardar cambios
            function configurarBtnGuardar() {
                const btnGuardarModal = document.getElementById('btnGuardarCambios');
                if (btnGuardarModal) {
                    btnGuardarModal.removeEventListener('click', manejarClickGuardar);
                    btnGuardarModal.addEventListener('click', manejarClickGuardar);
                }
            }

            function manejarClickGuardar(e) {
                e.preventDefault();
                guardarCambios(this);
            }

            function guardarCambios(btnGuardar) {
                if (!btnGuardar) {
                    btnGuardar = document.getElementById('btnGuardarCambios');
                }

                const inventarioId = document.getElementById('editarMaterialId').value;
                const stockActual = parseFloat(document.getElementById('editarStockActual').value) || 0;
                const capacidadMaxima = parseFloat(document.getElementById('editarCapacidadMaxima').value) || 0;
                const unidadMedida = document.getElementById('editarUnidadMedida').value;
                const precioCompra = parseFloat(document.getElementById('editarPrecioCompra').value) || 0;
                const precioVenta = parseFloat(document.getElementById('editarPrecioVenta').value) || 0;
                const umbralAlerta = parseInt(document.getElementById('editarUmbralAlerta').value) || 0;
                const umbralCritico = parseInt(document.getElementById('editarUmbralCritico').value) || 0;

                // ‚úÖ Obtener datos del usuario correctamente
                const section = document.querySelector('section[data-gestor]');
                let gestor = section?.getAttribute('data-gestor') || '';
                let usuarioId = section?.getAttribute('data-usuario-id') || '';

                console.log('üíæ Guardando cambios de inventario:', { inventarioId, stockActual, capacidadMaxima, unidadMedida, precioCompra, precioVenta, umbralAlerta, umbralCritico });
                console.log('üìç Datos de usuario:', { gestor, usuarioId });

                if (!inventarioId) {
                    mostrarModalResultado(false, 'Error', 'No se encontr√≥ el ID del inventario');
                    return;
                }

                if (!gestor || !usuarioId) {
                    console.error('‚ùå Datos de usuario no encontrados. Verificar atributos data-*');
                    mostrarModalResultado(false, 'Error', 'No se encontraron los datos de usuario. Por favor recarga la p√°gina.');
                    return;
                }

                if (!stockActual || !capacidadMaxima || !unidadMedida || !precioCompra || !precioVenta) {
                    mostrarModalResultado(false, 'Error', 'Por favor completa todos los campos requeridos');
                    return;
                }

                const datosActualizacion = {
                    stockActual: stockActual,
                    capacidadMaxima: capacidadMaxima,
                    unidadMedida: unidadMedida,
                    precioCompra: precioCompra,
                    precioVenta: precioVenta,
                    umbralAlerta: umbralAlerta,
                    umbralCritico: umbralCritico
                };

                // ‚úÖ Usar la referencia al bot√≥n
                const textoOriginal = btnGuardar?.innerHTML || 'Guardar Cambios';
                if (btnGuardar) {
                    btnGuardar.disabled = true;
                    btnGuardar.innerHTML = '<i class="bi bi-hourglass-split me-1"></i>Guardando...';
                }

                // ‚úÖ Construir URL correcta: /punto-eca/{nombrePunto}/{usuarioId}/actualizar-inventario/{inventarioId}
                const url = `/punto-eca/${gestor}/${usuarioId}/actualizar-inventario/${inventarioId}`;
                console.log('üîó URL de actualizaci√≥n:', url);

                fetch(url, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(datosActualizacion)
                })
                    .then(res => res.json().then(data => ({ status: res.status, ok: res.ok, data })))
                    .then(({ status, ok, data }) => {
                        console.log('üì¶ Respuesta del servidor:', { status, ok, data });

                        // Cerrar modales previos
                        if (editarModalInstance) editarModalInstance.hide();

                        if (!ok) {
                            // Mostrar error
                            const mensajeError = data?.mensaje || data?.message || 'Hubo un error al guardar los cambios';
                            console.error('‚ùå Error en respuesta:', mensajeError);
                            mostrarModalResultado(false, 'Error al guardar', mensajeError);
                            if (btnGuardar) {
                                btnGuardar.disabled = false;
                                btnGuardar.innerHTML = textoOriginal;
                            }
                        } else {
                            console.log('‚úÖ Actualizaci√≥n exitosa:', data);
                            // Mostrar √©xito
                            mostrarModalResultado(true, '¬°Operaci√≥n Exitosa!', 'Los cambios se han guardado correctamente en la base de datos.');
                            if (btnGuardar) {
                                btnGuardar.disabled = false;
                                btnGuardar.innerHTML = textoOriginal;
                            }
                        }
                    })
                    .catch(err => {
                        console.error('‚ùå Error en fetch:', err);
                        if (editarModalInstance) editarModalInstance.hide();
                        mostrarModalResultado(false, 'Error', 'Error al guardar cambios: ' + err.message);
                        if (btnGuardar) {
                            btnGuardar.disabled = false;
                            btnGuardar.innerHTML = textoOriginal;
                        }
                    });
            }

            // Funci√≥n para mostrar el modal de resultado
            // YA DEFINIDA GLOBALMENTE ARRIBA

            // Borrar: confirmaci√≥n simple
            function configurarBtnBorrar() {
                const btnBorrarModal = document.getElementById('btnBorrarMaterial');
                if (btnBorrarModal) {
                    btnBorrarModal.removeEventListener('click', manejarClickBorrar);
                    btnBorrarModal.addEventListener('click', manejarClickBorrar);
                }
            }

            function manejarClickBorrar(e) {
                e.preventDefault();
                confirmarBorrado(this);
            }

            function confirmarBorrado(btnBorrar) {
                if (!btnBorrar) {
                    btnBorrar = document.getElementById('btnBorrarMaterial');
                }

                const inventarioId = btnBorrar?.dataset.inventarioid || btnBorrar?.dataset.inventarioId || '';
                const nombreMaterial = btnBorrar?.dataset.nombreMaterial || 'el material';

                // ‚úÖ Obtener datos del usuario correctamente
                const section = document.querySelector('section[data-gestor]');
                let gestor = section?.getAttribute('data-gestor') || '';
                let usuarioId = section?.getAttribute('data-usuario-id') || '';

                console.log('üóëÔ∏è Preparando eliminaci√≥n:', { inventarioId, nombreMaterial, gestor, usuarioId });

                if (!gestor || !usuarioId) {
                    console.error('‚ùå Datos de usuario no encontrados');
                    alert('Error: No se encontraron los datos de usuario. Por favor recarga la p√°gina.');
                    return;
                }

                if (!inventarioId) {
                    if (!confirm('¬øDeseas borrar este material del inventario?')) return;
                } else {
                    if (!confirm('¬øConfirma eliminar "' + nombreMaterial + '" del inventario?')) return;
                }

                // ‚úÖ Construir URL correcta: /punto-eca/{nombrePunto}/{usuarioId}/eliminar-inventario/{inventarioId}
                const url = `/punto-eca/${gestor}/${usuarioId}/eliminar-inventario/${inventarioId}`;
                console.log('üóëÔ∏è URL de eliminaci√≥n:', url);

                fetch(url, { method: 'DELETE' })
                    .then(res => {
                        console.log('üì¶ Respuesta del DELETE:', { status: res.status, ok: res.ok });
                        if (res.ok) {
                            console.log('‚úÖ Eliminaci√≥n exitosa');
                            mostrarModalResultado(true, '¬°Eliminado!', 'El material ha sido eliminado del inventario correctamente.');
                            if (detallesModalInstance) detallesModalInstance.hide();
                            // Recargar despu√©s de cerrar modal
                            setTimeout(() => {
                                window.location.reload();
                            }, 1500);
                        } else {
                            return res.json().then(j => { throw new Error(j?.mensaje || j?.message || 'Error al borrar'); });
                        }
                    })
                    .catch(err => {
                        console.error('‚ùå Error borrando:', err);
                        mostrarModalResultado(false, 'Error al eliminar', 'No fue posible borrar: ' + (err.message || err));
                    });
            }

            function inicializar() {
                if (isInitialized) return;
                console.log('üìå Inicializando sistema de modales de materiales');
                inicializarModales();
                configurarEventListeners();
                configurarBtnEditar();
                configurarBtnGuardar();
                configurarBtnBorrar();
                isInitialized = true;
            }

            // Inicializar cuando el DOM est√° listo
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', inicializar);
            } else {
                inicializar();
            }

            // Re-inicializar si el contenedor cambia (para actualizaciones din√°micas)
            window.addEventListener('reinicializarModales', inicializar);

            console.log('‚úì Script de modales cargado');
        })();
    </script>

</section>
