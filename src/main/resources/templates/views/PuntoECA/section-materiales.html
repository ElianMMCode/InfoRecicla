<!-- Fragment: Materiales -->
<section th:fragment="materiales" class="container py-4">
    <h2 class="h5 mb-3">Materiales</h2>

    <!-- ACORDEÓN PRINCIPAL CON TODO -->
    <div class="accordion" id="acordeonMateriales">

        <!-- Item 1: BÚSQUEDA Y FILTROS -->
        <div class="accordion-item border-0 shadow-sm mb-3">
            <h2 class="accordion-header" id="headingBusqueda">
                <button class="accordion-button bg-light text-dark fw-semibold" type="button" data-bs-toggle="collapse" data-bs-target="#collapseBusqueda" aria-expanded="true" aria-controls="collapseBusqueda">
                    <i class="bi bi-search text-success me-2"></i>Búsqueda y Filtros
                </button>
            </h2>
            <div id="collapseBusqueda" class="accordion-collapse collapse show" aria-labelledby="headingBusqueda" data-bs-parent="#acordeonMateriales">
                <div class="accordion-body p-4">
                    <!-- Búsqueda principal -->
                    <div class="row g-3 mb-4">
                        <div class="col-12">
                            <label for="busquedaMaterial" class="form-label fw-semibold text-muted mb-2">
                                <i class="bi bi-search me-1"></i>Buscar Material
                            </label>
                            <div class="input-group input-group-lg">
                                <span class="input-group-text bg-light border-2 border-success">
                                    <i class="bi bi-search text-success"></i>
                                </span>
                                <input type="text"
                                       class="form-control form-control-lg border-2 border-success"
                                       id="busquedaMaterial"
                                       placeholder="Buscar por nombre de material..."
                                       style="transition: all 0.3s ease;">
                                <button class="btn btn-outline-success border-2"
                                        type="button"
                                        id="btnLimpiarBusqueda"
                                        title="Limpiar búsqueda">
                                    <i class="bi bi-x-circle"></i> Limpiar
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Filtros en grid -->
                    <div class="row g-3 mb-4">
                        <!-- Filtro por Estado -->
                        <div class="col-md-6 col-lg-3">
                            <label for="filtroEstado" class="form-label fw-semibold text-muted mb-2">
                                <i class="bi bi-exclamation-triangle me-1"></i>Estado
                            </label>
                            <select class="form-select form-select-sm filtro-select"
                                    id="filtroEstado"
                                    data-tipo="estado">
                                <option value="">Todos los estados</option>
                                <option value="ok">✓ OK</option>
                                <option value="alerta">⚠ Alerta</option>
                                <option value="critico">✕ Crítico</option>
                            </select>
                        </div>

                        <!-- Filtro por Unidad de Medida -->
                        <div class="col-md-6 col-lg-3">
                            <label for="filtroUnidad" class="form-label fw-semibold text-muted mb-2">
                                <i class="bi bi-ruler me-1"></i>Unidad de Medida
                            </label>
                            <select class="form-select form-select-sm filtro-select"
                                    id="filtroUnidad"
                                    data-tipo="unidad">
                                <option value="">Todas las unidades</option>
                                <option value="kg">Kilogramos (kg)</option>
                                <option value="l">Litros (l)</option>
                                <option value="m">Metros (m)</option>
                                <option value="m2">Metros cuadrados (m²)</option>
                                <option value="unidad">Unidades</option>
                            </select>
                        </div>

                        <!-- Filtro por Rango de Ocupación -->
                        <div class="col-md-6 col-lg-3">
                            <label for="filtroOcupacion" class="form-label fw-semibold text-muted mb-2">
                                <i class="bi bi-percent me-1"></i>Ocupación
                            </label>
                            <select class="form-select form-select-sm filtro-select"
                                    id="filtroOcupacion"
                                    data-tipo="ocupacion">
                                <option value="">Cualquier ocupación</option>
                                <option value="0-25">0% - 25%</option>
                                <option value="25-50">25% - 50%</option>
                                <option value="50-75">50% - 75%</option>
                                <option value="75-100">75% - 100%</option>
                            </select>
                        </div>

                        <!-- Filtro por Stock -->
                        <div class="col-md-6 col-lg-3">
                            <label for="filtroStock" class="form-label fw-semibold text-muted mb-2">
                                <i class="bi bi-box2 me-1"></i>Stock
                            </label>
                            <select class="form-select form-select-sm filtro-select"
                                    id="filtroStock"
                                    data-tipo="stock">
                                <option value="">Cualquier stock</option>
                                <option value="vacio">Vacío</option>
                                <option value="bajo">Bajo</option>
                                <option value="medio">Medio</option>
                                <option value="alto">Alto</option>
                            </select>
                        </div>
                    </div>

                    <!-- Botones de acción -->
                    <div class="row g-2">
                        <div class="col-auto">
                            <button class="btn btn-sm btn-success"
                                    type="button"
                                    id="btnAplicarFiltros">
                                <i class="bi bi-check-circle me-1"></i>Aplicar
                            </button>
                        </div>
                        <div class="col-auto">
                            <button class="btn btn-sm btn-outline-secondary"
                                    type="button"
                                    id="btnRestablecerFiltros">
                                <i class="bi bi-arrow-clockwise me-1"></i>Restablecer
                            </button>
                        </div>
                        <div class="col-auto">
                            <span class="badge bg-info text-dark" id="resultadosInfo" style="display:none;">
                                <i class="bi bi-funnel me-1"></i>Filtros Activos: <span id="contadorFiltros">0</span>
                            </span>
                        </div>
                        <div class="col-auto ms-auto">
                            <span class="badge bg-success" id="resultadosCount" style="display:none;">
                                Mostrando <span id="resultadosCountNum">0</span> de <span id="totalCount">0</span>
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Item 2: OCUPACIÓN DE INVENTARIO (TABLA) -->
        <div class="accordion-item border-0 shadow-sm mb-3">
            <h2 class="accordion-header" id="headingOcupacion">
                <button class="accordion-button bg-light text-dark fw-semibold collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOcupacion" aria-expanded="false" aria-controls="collapseOcupacion">
                    <i class="bi bi-graph-up text-success me-2"></i>Ocupación de Inventario
                    <span class="badge bg-success ms-2" th:text="${#lists.size(inventarios)} + ' materiales'">0 materiales</span>
                </button>
            </h2>
            <div id="collapseOcupacion" class="accordion-collapse collapse" aria-labelledby="headingOcupacion" data-bs-parent="#acordeonMateriales">
                <div class="accordion-body p-4">
                    <div th:if="${#lists.isEmpty(inventarios)}" class="text-muted text-center py-3">
                        No hay datos de inventario disponibles
                    </div>
                    <div class="table-responsive" th:if="${not #lists.isEmpty(inventarios)}">
                        <table class="table table-sm align-middle mb-0">
                            <thead class="bg-success text-white">
                                <tr>
                                    <th>Material</th>
                                    <th class="text-end" style="width:140px;">Stock</th>
                                    <th class="text-end" style="width:140px;">Capacidad</th>
                                    <th style="min-width:240px;">% Ocupación</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr th:each="inventario : ${inventarios}">
                                    <!--/*@thymesVar id="inventario" type="org.sena.inforecicla.dto.puntoEca.InventarioResponseDTO"*/-->
                                    <td class="fw-semibold" th:text="${inventario.nombreMaterial()}">Material</td>
                                    <td class="text-end" th:text="${#numbers.formatDecimal(inventario.stockActual(), 1, 'COMMA', 2, 'POINT')}">0.00</td>
                                    <td class="text-end" th:text="${#numbers.formatDecimal(inventario.capacidadMaxima(), 1, 'COMMA', 2, 'POINT')}">0.00</td>
                                    <td>
                                        <th:block th:with="ocupacion = ${(inventario.stockActual() / inventario.capacidadMaxima() * 100).intValue()}">
                                            <div class="progress" style="height:18px;">
                                                <div class="progress-bar"
                                                     th:classappend="${ocupacion >= inventario.umbralCritico() ? 'bg-danger' : ocupacion >= inventario.umbralAlerta() ? 'bg-warning' : 'bg-success'}"
                                                     role="progressbar"
                                                     th:attr="aria-valuenow=${ocupacion}, aria-valuemin='0', aria-valuemax='100'"
                                                     th:style="'width: ' + ${ocupacion} + '%'">
                                                    <span class="small" th:text="${ocupacion} + '%'">0%</span>
                                                </div>
                                            </div>
                                        </th:block>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="small text-muted mt-2">Colores: <span class="badge bg-success">OK</span> <span class="badge bg-warning">Alerta</span> <span class="badge bg-danger">Crítico</span></div>
                </div>
            </div>
        </div>

        <!-- Item 3: TARJETAS DE MATERIALES -->
        <div class="accordion-item border-0 shadow-sm">
            <h2 class="accordion-header" id="headingTarjetas">
                <button class="accordion-button bg-light text-dark fw-semibold collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTarjetas" aria-expanded="false" aria-controls="collapseTarjetas">
                    <i class="bi bi-collection text-success me-2"></i>Tarjetas de Materiales
                    <span class="badge bg-success ms-2" th:text="${#lists.size(inventarios)} + ' items'">0 items</span>
                </button>
            </h2>
            <div id="collapseTarjetas" class="accordion-collapse collapse" aria-labelledby="headingTarjetas" data-bs-parent="#acordeonMateriales">
                <div class="accordion-body p-4">
                    <div th:if="${#lists.isEmpty(inventarios)}" class="alert alert-info" role="alert">
                        <strong>Sin materiales</strong> - No hay materiales registrados en el inventario.
                    </div>

                    <div class="row g-4" th:if="${not #lists.isEmpty(inventarios)}" id="contenedorMateriales">
            <div class="col-12 col-md-6 col-lg-4 tarjeta-material"
                 th:each="inventario : ${inventarios}"
                 th:data-nombre-material="${inventario.nombreMaterial()}"
                 th:data-unidad-medida="${inventario.unidadMedida()}"
                 th:with="ocupacion = ${(inventario.stockActual() / inventario.capacidadMaxima() * 100).intValue()}">
                <!-- Tarjeta de Material -->
                <div class="card h-100 shadow-sm border-0 transition"
                     style="transition: all 0.3s ease;"
                     th:classappend="${ocupacion >= inventario.umbralCritico() ? 'estado-critico' : ocupacion >= inventario.umbralAlerta() ? 'estado-alerta' : 'estado-ok'}"
                     th:data-ocupacion="${ocupacion}"
                     th:data-estado="${ocupacion >= inventario.umbralCritico() ? 'critico' : ocupacion >= inventario.umbralAlerta() ? 'alerta' : 'ok'}"
                     th:data-stock-actual="${inventario.stockActual()}"
                     th:data-capacidad-maxima="${inventario.capacidadMaxima()}">
                    <div class="card-header bg-success text-white d-flex justify-content-between align-items-start">
                        <div>
                            <h5 class="card-title mb-1" th:text="${inventario.nombreMaterial()}">Material</h5>
                            <small class="text-light" th:text="${inventario.unidadMedida()}">Unidad</small>
                        </div>
                        <span class="badge bg-info" th:text="${inventario.unidadMedida()}">Unidad</span>
                    </div>

                    <div class="card-body">
                        <!-- Datos principales -->
                        <div class="row mb-3">
                            <div class="col-6">
                                <small class="text-muted">Stock Actual</small>
                                <p class="fw-bold text-success" th:text="${#numbers.formatDecimal(inventario.stockActual(), 1, 'COMMA', 2, 'POINT')}">0.00</p>
                            </div>
                            <div class="col-6">
                                <small class="text-muted">Capacidad Máxima</small>
                                <p class="fw-bold text-primary" th:text="${#numbers.formatDecimal(inventario.capacidadMaxima(), 1, 'COMMA', 2, 'POINT')}">0.00</p>
                            </div>
                        </div>

                        <!-- Indicador de ocupación con código de color -->
                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <small class="text-muted">% Ocupación</small>
                                <th:block th:with="ocupacion = ${(inventario.stockActual() / inventario.capacidadMaxima() * 100).intValue()}">
                                    <small class="fw-bold"
                                           th:classappend="${ocupacion >= inventario.umbralCritico() ? 'text-danger' : ocupacion >= inventario.umbralAlerta() ? 'text-warning' : 'text-success'}"
                                           th:text="${ocupacion} + '%'">
                                        0%
                                    </small>
                                </th:block>
                            </div>
                            <th:block th:with="ocupacion = ${(inventario.stockActual() / inventario.capacidadMaxima() * 100).intValue()}">
                                <div class="progress" style="height: 20px;">
                                    <div class="progress-bar"
                                         th:classappend="${ocupacion >= inventario.umbralCritico() ? 'bg-danger' : ocupacion >= inventario.umbralAlerta() ? 'bg-warning' : 'bg-success'}"
                                         role="progressbar"
                                         th:attr="aria-valuenow=${ocupacion}, aria-valuemin='0', aria-valuemax='100'"
                                         th:style="'width: ' + ${ocupacion} + '%'">
                                        <small class="d-flex align-items-center justify-content-center h-100 text-dark fw-bold" th:text="${ocupacion} + '%'">0%</small>
                                    </div>
                                </div>
                            </th:block>
                        </div>

                        <!-- Información de precios -->
                        <hr class="my-2">
                        <div class="row small mb-3">
                            <div class="col-6">
                                <small class="text-muted">Precio Compra</small>
                                <p class="text-dark mb-0" th:text="${inventario.precioCompra() != null ? '$ ' + #numbers.formatDecimal(inventario.precioCompra(), 1, 'COMMA', 2, 'POINT') : 'N/A'}">$ 0.00</p>
                            </div>
                            <div class="col-6">
                                <small class="text-muted">Precio Venta</small>
                                <p class="text-dark mb-0" th:text="${inventario.precioVenta() != null ? '$ ' + #numbers.formatDecimal(inventario.precioVenta(), 1, 'COMMA', 2, 'POINT') : 'N/A'}">$ 0.00</p>
                            </div>
                        </div>

                        <!-- Umbral de alerta -->
                        <div class="alert alert-light border border-warning p-2 mb-0" role="alert">
                            <small class="text-muted">Umbrales:</small>
                            <div class="d-flex justify-content-between mt-1">
                                <small>
                                    <span class="badge bg-warning">Alerta: <span th:text="${inventario.umbralAlerta()}">0</span>%</span>
                                </small>
                                <small>
                                    <span class="badge bg-danger">Crítico: <span th:text="${inventario.umbralCritico()}">0</span>%</span>
                                </small>
                            </div>
                        </div>
                    </div>

                    <!-- Botón de detalles -->
                    <div class="card-footer bg-light border-top d-grid gap-2">
                        <!-- DEBUG: inventarioId = [[${inventario.inventarioId()}]] -->
                        <button type="button" class="btn btn-success btn-sm detallesBtn"
                                th:data-inventario-id="${inventario.inventarioId() != null ? inventario.inventarioId() : ''}"
                                th:data-material-id="${inventario.materialId() != null ? inventario.materialId() : ''}"
                                th:data-nombre-material="${inventario.nombreMaterial()}"
                                th:data-stock-actual="${inventario.stockActual()}"
                                th:data-capacidad-maxima="${inventario.capacidadMaxima()}"
                                th:data-precio-compra="${inventario.precioCompra() != null ? inventario.precioCompra() : 0}"
                                th:data-precio-venta="${inventario.precioVenta() != null ? inventario.precioVenta() : 0}"
                                th:data-umbral-alerta="${inventario.umbralAlerta()}"
                                th:data-umbral-critico="${inventario.umbralCritico()}"
                                th:data-unidad-medida="${inventario.unidadMedida()}">
                            <i class="bi bi-eye me-1"></i> Ver Detalles
                        </button>
                    </div>
                </div>
            </div>
        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</section>

<!-- Modal MEJORADO para ver detalles completos del material -->
<div class="modal fade" id="detallesModal" tabindex="-1" aria-labelledby="detallesModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content border-0">
            <!-- Header con color según estado -->
            <div class="modal-header bg-success text-white border-0">
                <div>
                    <h5 class="modal-title" id="detallesModalLabel">Detalles del Material</h5>
                    <small class="text-white-50" id="modalDetalleSubtitulo">Información completa del inventario</small>
                </div>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <!-- Body con contenido organizado en tabs internos -->
            <div class="modal-body p-0">
                <!-- Nav Tabs internas -->
                <ul class="nav nav-tabs" role="tablist" style="border-bottom: 2px solid #e9ecef;">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="tab-info" data-bs-toggle="tab" data-bs-target="#info-content" type="button" role="tab" aria-controls="info-content" aria-selected="true">
                            <i class="bi bi-info-circle me-2 text-success"></i>Información
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="tab-inventario" data-bs-toggle="tab" data-bs-target="#inventario-content" type="button" role="tab" aria-controls="inventario-content" aria-selected="false">
                            <i class="bi bi-box-seam me-2 text-success"></i>Inventario
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="tab-precios" data-bs-toggle="tab" data-bs-target="#precios-content" type="button" role="tab" aria-controls="precios-content" aria-selected="false">
                            <i class="bi bi-tag me-2 text-success"></i>Precios
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="tab-alertas" data-bs-toggle="tab" data-bs-target="#alertas-content" type="button" role="tab" aria-controls="alertas-content" aria-selected="false">
                            <i class="bi bi-exclamation-triangle me-2 text-success"></i>Umbrales
                        </button>
                    </li>
                </ul>

                <!-- Tab Content -->
                <div class="tab-content p-4">
                    <!-- TAB 1: INFORMACIÓN GENERAL -->
                    <div class="tab-pane fade show active" id="info-content" role="tabpanel" aria-labelledby="tab-info">
                        <div class="row">
                            <div class="col-md-6 mb-4">
                                <div class="card border-0 bg-light">
                                    <div class="card-body">
                                        <small class="text-muted d-block mb-2">
                                            <i class="bi bi-tag me-1"></i>Nombre del Material
                                        </small>
                                        <h5 class="text-success mb-0" id="modalNombreMaterial">-</h5>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-4">
                                <div class="card border-0 bg-light">
                                    <div class="card-body">
                                        <small class="text-muted d-block mb-2">
                                            <i class="bi bi-code-square me-1"></i>ID del Material
                                        </small>
                                        <p class="font-monospace text-dark mb-0" id="modalMaterialId">-</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-4">
                                <div class="card border-0 bg-light">
                                    <div class="card-body">
                                        <small class="text-muted d-block mb-2">
                                            <i class="bi bi-rulers me-1"></i>Unidad de Medida
                                        </small>
                                        <h6 class="text-dark mb-0" id="modalUnidadMedida">-</h6>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-4">
                                <div class="card border-0 bg-light">
                                    <div class="card-body">
                                        <small class="text-muted d-block mb-2">
                                            <i class="bi bi-circle-fill me-1" id="modalEstadoIcon"></i>Estado Actual
                                        </small>
                                        <h6 class="mb-0" id="modalEstadoText">-</h6>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Indicador visual grande de ocupación -->
                        <div class="card border-0 bg-light mt-3">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h6 class="mb-0">
                                        <i class="bi bi-pie-chart me-2 text-success"></i>Ocupación del Inventario
                                    </h6>
                                    <span class="badge bg-success fs-6" id="modalOcupacionPorcentaje">0%</span>
                                </div>
                                <div class="progress" style="height: 30px;">
                                    <div id="modalOcupacionBar" class="progress-bar d-flex align-items-center justify-content-center fw-bold text-dark" role="progressbar" style="width: 0%">
                                        <small id="modalOcupacionText">0%</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- TAB 2: INVENTARIO -->
                    <div class="tab-pane fade" id="inventario-content" role="tabpanel" aria-labelledby="tab-inventario">
                        <div class="row">
                            <div class="col-md-6 mb-4">
                                <div class="card border-success border-2">
                                    <div class="card-header bg-success text-white">
                                        <i class="bi bi-inbox me-2"></i>Stock Actual
                                    </div>
                                    <div class="card-body">
                                        <p class="h4 text-success mb-2" id="modalStockActual">0.00</p>
                                        <small class="text-muted" id="modalStockUnidad">unidades</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-4">
                                <div class="card border-primary border-2">
                                    <div class="card-header bg-primary text-white">
                                        <i class="bi bi-archive me-2"></i>Capacidad Máxima
                                    </div>
                                    <div class="card-body">
                                        <p class="h4 text-primary mb-2" id="modalCapacidadMaxima">0.00</p>
                                        <small class="text-muted" id="modalCapacidadUnidad">unidades</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-12 mb-4">
                                <div class="card border-0 bg-light">
                                    <div class="card-body">
                                        <h6 class="mb-3">
                                            <i class="bi bi-diagram-3 me-2 text-success"></i>Desglose de Ocupación
                                        </h6>
                                        <div class="row text-center">
                                            <div class="col-6">
                                                <div class="p-3 border rounded">
                                                    <small class="text-muted d-block mb-2">Espacio Usado</small>
                                                    <p class="h5 text-success mb-0" id="modalEspacioUsado">0.00</p>
                                                </div>
                                            </div>
                                            <div class="col-6">
                                                <div class="p-3 border rounded">
                                                    <small class="text-muted d-block mb-2">Espacio Disponible</small>
                                                    <p class="h5 text-info mb-0" id="modalEspacioDisponible">0.00</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- TAB 3: PRECIOS -->
                    <div class="tab-pane fade" id="precios-content" role="tabpanel" aria-labelledby="tab-precios">
                        <div class="row">
                            <div class="col-md-6 mb-4">
                                <div class="card border-info border-2">
                                    <div class="card-header bg-info text-white">
                                        <i class="bi bi-cart-plus me-2"></i>Precio de Compra
                                    </div>
                                    <div class="card-body">
                                        <p class="h4 text-info mb-0" id="modalPrecioCompra">$ 0.00</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-4">
                                <div class="card border-warning border-2">
                                    <div class="card-header bg-warning text-dark">
                                        <i class="bi bi-cart-check me-2"></i>Precio de Venta
                                    </div>
                                    <div class="card-body">
                                        <p class="h4 text-warning mb-0" id="modalPrecioVenta">$ 0.00</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-12 mb-4">
                                <div class="card border-0 bg-light">
                                    <div class="card-body">
                                        <h6 class="mb-3">
                                            <i class="bi bi-percent me-2 text-success"></i>Análisis de Precios
                                        </h6>
                                        <div class="row text-center">
                                            <div class="col-6">
                                                <div class="p-3 border rounded">
                                                    <small class="text-muted d-block mb-2">Margen de Ganancia</small>
                                                    <p class="h5 mb-0" id="modalMargenGanancia">-</p>
                                                </div>
                                            </div>
                                            <div class="col-6">
                                                <div class="p-3 border rounded">
                                                    <small class="text-muted d-block mb-2">% Margen</small>
                                                    <p class="h5 mb-0" id="modalPorcentajeMargen">-</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-12 mb-4">
                                <div class="card border-0 bg-light">
                                    <div class="card-body">
                                        <h6 class="mb-3">
                                            <i class="bi bi-calculator me-2 text-success"></i>Valor Total en Inventario
                                        </h6>
                                        <p class="h4 text-success mb-0" id="modalValorTotal">$ 0.00</p>
                                        <small class="text-muted">(Stock Actual × Precio Compra)</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- TAB 4: UMBRALES Y ALERTAS -->
                    <div class="tab-pane fade" id="alertas-content" role="tabpanel" aria-labelledby="tab-alertas">
                        <div class="row">
                            <div class="col-md-6 mb-4">
                                <div class="card border-warning border-2">
                                    <div class="card-header bg-warning text-dark">
                                        <i class="bi bi-exclamation-triangle me-2"></i>Umbral de Alerta
                                    </div>
                                    <div class="card-body">
                                        <p class="h4 text-warning mb-2" id="modalUmbralAlerta">0%</p>
                                        <small class="text-muted">Se activa cuando la ocupación supera este porcentaje</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-4">
                                <div class="card border-danger border-2">
                                    <div class="card-header bg-danger text-white">
                                        <i class="bi bi-exclamation-octagon me-2"></i>Umbral Crítico
                                    </div>
                                    <div class="card-body">
                                        <p class="h4 text-danger mb-2" id="modalUmbralCritico">0%</p>
                                        <small class="text-muted">Se activa cuando la ocupación supera este porcentaje</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Indicador de estado según umbrales -->
                        <div class="row">
                            <div class="col-12 mb-4">
                                <div class="card border-0" id="modalEstadoCard">
                                    <div class="card-body text-center p-4">
                                        <div id="modalEstadoIndicador"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Resumen de alertas -->
                        <div class="row">
                            <div class="col-12 mb-4">
                                <div class="card border-0 bg-light">
                                    <div class="card-body">
                                        <h6 class="mb-3">
                                            <i class="bi bi-bell me-2 text-success"></i>Resumen de Alertas
                                        </h6>
                                        <div id="modalResumenAlertas"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <div class="modal-footer border-top bg-light">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle me-1"></i>Cerrar
                </button>
                <button type="button" class="btn btn-success" id="btnEditarMaterial" style="display:none;">
                    <i class="bi bi-pencil me-1"></i>Editar Material
                </button>
            </div>
        </div>
    </div>
</div>

</section>

<!-- Script para manejar el modal de detalles y filtros -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // ============================================================
        // FUNCIONALIDAD DEL MODAL DE DETALLES
        // ============================================================
        const detallesModal = document.getElementById('detallesModal');

        detallesModal.addEventListener('show.bs.modal', function(event) {
            const button = event.relatedTarget;

            // Obtener datos del botón
            const materialId = button.getAttribute('data-material-id');
            const nombreMaterial = button.getAttribute('data-nombre-material');
            const stockActual = parseFloat(button.getAttribute('data-stock-actual'));
            const capacidadMaxima = parseFloat(button.getAttribute('data-capacidad-maxima'));
            const precioCompra = parseFloat(button.getAttribute('data-precio-compra'));
            const precioVenta = parseFloat(button.getAttribute('data-precio-venta'));
            const umbralAlerta = parseInt(button.getAttribute('data-umbral-alerta'));
            const umbralCritico = parseInt(button.getAttribute('data-umbral-critico'));
            const unidadMedida = button.getAttribute('data-unidad-medida');

            // Calcular ocupación
            const ocupacion = Math.round((stockActual / capacidadMaxima) * 100);

            // Calcular espacio disponible
            const espacioDisponible = capacidadMaxima - stockActual;

            // Calcular margen de ganancia
            const margenGanancia = precioVenta - precioCompra;
            const porcentajeMargen = precioCompra > 0 ? Math.round((margenGanancia / precioCompra) * 100) : 0;

            // Calcular valor total del inventario
            const valorTotalInventario = stockActual * precioCompra;

            // Determinar color de ocupación
            let colorClase = 'bg-success';
            let estadoTexto = '✓ OK';
            let estadoColor = '#28a745';

            if (ocupacion >= umbralCritico) {
                colorClase = 'bg-danger';
                estadoTexto = '✕ Crítico';
                estadoColor = '#dc3545';
            } else if (ocupacion >= umbralAlerta) {
                colorClase = 'bg-warning';
                estadoTexto = '⚠ Alerta';
                estadoColor = '#ffc107';
            }

            // ========== LLENAR TAB 1: INFORMACIÓN ==========
            document.getElementById('modalNombreMaterial').textContent = nombreMaterial;
            document.getElementById('modalMaterialId').textContent = materialId;
            document.getElementById('modalUnidadMedida').textContent = unidadMedida;
            document.getElementById('modalEstadoText').textContent = estadoTexto;
            document.getElementById('modalEstadoText').style.color = estadoColor;

            // Icono de estado
            const iconoEstado = document.getElementById('modalEstadoIcon');
            iconoEstado.style.color = estadoColor;

            // Ocupación
            document.getElementById('modalOcupacionPorcentaje').textContent = ocupacion + '%';
            document.getElementById('modalOcupacionText').textContent = ocupacion + '%';
            document.getElementById('modalOcupacionBar').style.width = ocupacion + '%';
            document.getElementById('modalOcupacionBar').className = 'progress-bar d-flex align-items-center justify-content-center fw-bold text-dark ' + colorClase;

            // ========== LLENAR TAB 2: INVENTARIO ==========
            document.getElementById('modalStockActual').textContent = stockActual.toLocaleString('es-CO', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            document.getElementById('modalCapacidadMaxima').textContent = capacidadMaxima.toLocaleString('es-CO', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            document.getElementById('modalStockUnidad').textContent = unidadMedida;
            document.getElementById('modalCapacidadUnidad').textContent = unidadMedida;

            document.getElementById('modalEspacioUsado').textContent = stockActual.toLocaleString('es-CO', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            document.getElementById('modalEspacioDisponible').textContent = espacioDisponible.toLocaleString('es-CO', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

            // ========== LLENAR TAB 3: PRECIOS ==========
            document.getElementById('modalPrecioCompra').textContent = '$ ' + precioCompra.toLocaleString('es-CO', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            document.getElementById('modalPrecioVenta').textContent = '$ ' + precioVenta.toLocaleString('es-CO', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            document.getElementById('modalMargenGanancia').textContent = '$ ' + margenGanancia.toLocaleString('es-CO', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            document.getElementById('modalPorcentajeMargen').textContent = porcentajeMargen + '%';
            document.getElementById('modalValorTotal').textContent = '$ ' + valorTotalInventario.toLocaleString('es-CO', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

            // ========== LLENAR TAB 4: UMBRALES Y ALERTAS ==========
            document.getElementById('modalUmbralAlerta').textContent = umbralAlerta + '%';
            document.getElementById('modalUmbralCritico').textContent = umbralCritico + '%';

            // Generar indicador de estado
            let indicadorHTML = `
                <h5 class="mb-3" style="color: ${estadoColor};">
                    <i class="bi bi-circle-fill me-2"></i>${estadoTexto}
                </h5>
                <p class="text-muted mb-0">
                    Ocupación actual: <strong>${ocupacion}%</strong>
                </p>
            `;
            document.getElementById('modalEstadoIndicador').innerHTML = indicadorHTML;

            // Generar resumen de alertas
            let resumenHTML = '<div class="list-group">';

            if (ocupacion < umbralAlerta) {
                resumenHTML += '<div class="list-group-item border-0"><i class="bi bi-check-circle text-success me-2"></i>Stock dentro de los límites normales</div>';
            } else if (ocupacion >= umbralAlerta && ocupacion < umbralCritico) {
                resumenHTML += '<div class="list-group-item border-0"><i class="bi bi-exclamation-triangle text-warning me-2"></i>Alerta: Stock en nivel moderado</div>';
            } else {
                resumenHTML += '<div class="list-group-item border-0"><i class="bi bi-exclamation-octagon text-danger me-2"></i>Crítico: Stock muy alto, requiere atención</div>';
            }

            if (espacioDisponible < stockActual * 0.1) {
                resumenHTML += '<div class="list-group-item border-0"><i class="bi bi-info-circle text-info me-2"></i>Poco espacio disponible en el inventario</div>';
            }

            if (margenGanancia <= 0) {
                resumenHTML += '<div class="list-group-item border-0"><i class="bi bi-exclamation-circle text-danger me-2"></i>Margen de ganancia negativo o nulo</div>';
            }

            resumenHTML += '</div>';
            document.getElementById('modalResumenAlertas').innerHTML = resumenHTML;

            // Actualizar título del modal
            document.getElementById('detallesModalLabel').textContent = 'Detalles: ' + nombreMaterial;
        });

        // ============================================================
        // FUNCIONALIDAD DE BÚSQUEDA Y FILTROS
        // ============================================================
        const busquedaInput = document.getElementById('busquedaMaterial');
        const btnLimpiar = document.getElementById('btnLimpiarBusqueda');
        const filtroSelects = document.querySelectorAll('.filtro-select');
        const btnAplicar = document.getElementById('btnAplicarFiltros');
        const btnRestablecer = document.getElementById('btnRestablecerFiltros');
        const contadorFiltros = document.getElementById('contadorFiltros');
        const resultadosInfo = document.getElementById('resultadosInfo');
        const resultadosCountNum = document.getElementById('resultadosCountNum');
        const totalCount = document.getElementById('totalCount');
        const resultadosCount = document.getElementById('resultadosCount');
        const tarjetas = document.querySelectorAll('.tarjeta-material');

        // Contador total inicial
        totalCount.textContent = tarjetas.length;

        // Evento: Búsqueda en tiempo real
        busquedaInput.addEventListener('input', aplicarFiltros);

        // Evento: Limpiar búsqueda
        btnLimpiar.addEventListener('click', function() {
            busquedaInput.value = '';
            busquedaInput.focus();
            aplicarFiltros();
        });

        // Evento: Aplicar filtros
        btnAplicar.addEventListener('click', aplicarFiltros);

        // Evento: Restablecer filtros
        btnRestablecer.addEventListener('click', function() {
            busquedaInput.value = '';
            filtroSelects.forEach(select => select.value = '');
            contadorFiltros.textContent = '0';
            aplicarFiltros();
        });

        // Evento: Actualizar contador de filtros
        filtroSelects.forEach(select => {
            select.addEventListener('change', function() {
                actualizarContadorFiltros();
            });
        });

        // Función: Aplicar filtros
        function aplicarFiltros() {
            const textoBusqueda = busquedaInput.value.toLowerCase().trim();
            const filtroEstado = document.getElementById('filtroEstado').value;
            const filtroUnidad = document.getElementById('filtroUnidad').value;
            const filtroOcupacion = document.getElementById('filtroOcupacion').value;
            const filtroStock = document.getElementById('filtroStock').value;

            let contadorVisible = 0;
            let noHayResultados = true;

            tarjetas.forEach(tarjeta => {
                const nombreMaterial = tarjeta.getAttribute('data-nombre-material').toLowerCase();
                const unidadMedida = tarjeta.getAttribute('data-unidad-medida').toLowerCase();
                const estado = tarjeta.querySelector('.card').getAttribute('data-estado');
                const ocupacion = parseInt(tarjeta.querySelector('.card').getAttribute('data-ocupacion'));
                const stockActual = parseFloat(tarjeta.querySelector('.card').getAttribute('data-stock-actual'));
                const capacidadMaxima = parseFloat(tarjeta.querySelector('.card').getAttribute('data-capacidad-maxima'));

                // Validar búsqueda de texto
                let coincideBusqueda = nombreMaterial.includes(textoBusqueda);

                // Validar filtro de estado
                let coincideEstado = !filtroEstado || estado === filtroEstado;

                // Validar filtro de unidad
                let coincideUnidad = !filtroUnidad || unidadMedida.includes(filtroUnidad.toLowerCase());

                // Validar filtro de ocupación
                let coincideOcupacion = true;
                if (filtroOcupacion) {
                    const [min, max] = filtroOcupacion.split('-').map(Number);
                    coincideOcupacion = ocupacion >= min && ocupacion <= max;
                }

                // Validar filtro de stock
                let coincideStock = true;
                if (filtroStock) {
                    const porcentajeStock = (stockActual / capacidadMaxima) * 100;
                    if (filtroStock === 'vacio') coincideStock = porcentajeStock < 10;
                    if (filtroStock === 'bajo') coincideStock = porcentajeStock >= 10 && porcentajeStock < 33;
                    if (filtroStock === 'medio') coincideStock = porcentajeStock >= 33 && porcentajeStock < 66;
                    if (filtroStock === 'alto') coincideStock = porcentajeStock >= 66;
                }

                // Aplicar visibilidad
                const mostrar = coincideBusqueda && coincideEstado && coincideUnidad && coincideOcupacion && coincideStock;

                if (mostrar) {
                    tarjeta.style.display = '';
                    tarjeta.classList.add('fadeIn');
                    contadorVisible++;
                    noHayResultados = false;
                } else {
                    tarjeta.style.display = 'none';
                }
            });

            // Actualizar información de resultados
            resultadosCountNum.textContent = contadorVisible;
            if (textoBusqueda || filtroEstado || filtroUnidad || filtroOcupacion || filtroStock) {
                resultadosInfo.style.display = 'inline-block';
                resultadosCount.style.display = 'inline-block';
            } else {
                resultadosInfo.style.display = 'none';
                resultadosCount.style.display = 'none';
            }

            // Mostrar mensaje si no hay resultados
            if (noHayResultados && tarjetas.length > 0) {
                mostrarMensajeNoResultados();
            } else {
                ocultarMensajeNoResultados();
            }
        }

        // Función: Actualizar contador de filtros activos
        function actualizarContadorFiltros() {
            let contador = 0;
            filtroSelects.forEach(select => {
                if (select.value) contador++;
            });
            contadorFiltros.textContent = contador;
        }

        // Función: Mostrar mensaje de no resultados
        function mostrarMensajeNoResultados() {
            let mensaje = document.getElementById('mensajeNoResultados');
            if (!mensaje) {
                const contenedor = document.getElementById('contenedorMateriales');
                mensaje = document.createElement('div');
                mensaje.id = 'mensajeNoResultados';
                mensaje.className = 'alert alert-info mt-4';
                mensaje.innerHTML = `
                    <div class="text-center">
                        <i class="bi bi-search fs-1 text-info mb-3" style="display: block;"></i>
                        <h6>No se encontraron materiales</h6>
                        <p class="text-muted mb-0">Intenta ajustar los filtros o tu búsqueda</p>
                    </div>
                `;
                contenedor.parentElement.insertBefore(mensaje, contenedor);
            }
            mensaje.style.display = 'block';
        }

        // Función: Ocultar mensaje de no resultados
        function ocultarMensajeNoResultados() {
            const mensaje = document.getElementById('mensajeNoResultados');
            if (mensaje) mensaje.style.display = 'none';
        }

        // Agregar estilos para animaciones
        const style = document.createElement('style');
        style.textContent = `
            .tarjeta-material {
                animation: slideIn 0.3s ease;
            }

            @keyframes slideIn {
                from {
                    opacity: 0;
                    transform: translateY(10px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            .fadeIn {
                animation: fadeInAnim 0.2s ease;
            }

            @keyframes fadeInAnim {
                from { opacity: 0.5; }
                to { opacity: 1; }
            }

            .estado-critico {
                border-left: 4px solid #dc3545 !important;
            }

            .estado-alerta {
                border-left: 4px solid #ffc107 !important;
            }

            .estado-ok {
                border-left: 4px solid #28a745 !important;
            }

            .form-control-lg:focus,
            .form-select-sm:focus {
                border-color: #198754;
                box-shadow: 0 0 0 0.2rem rgba(25, 135, 84, 0.25);
            }
        `;
        document.head.appendChild(style);

        // Inicializar modal handler
        inicializarModalMaterial();
    });
</script>

<!-- Script removido: ahora está en puntoECA-layout.html -->

