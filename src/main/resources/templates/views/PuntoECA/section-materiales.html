<!-- Fragment: Materiales -->
<section th:fragment="materiales" class="container py-4">
    <h2 class="h5 mb-3">Materiales</h2>

    <!-- Ocupación de inventario simplificada -->
    <div class="card mb-4">
        <div class="card-header bg-success text-white d-flex justify-content-between align-items-center flex-wrap gap-2">
            <strong>Ocupación de inventario</strong>
            <span class="small text-light" th:text="${#lists.size(inventarios)} + ' materiales'">0 materiales</span>
        </div>
        <div class="card-body">
            <div th:if="${#lists.isEmpty(inventarios)}" class="text-muted text-center py-3">
                No hay datos de inventario disponibles
            </div>
            <div class="table-responsive" th:if="${not #lists.isEmpty(inventarios)}">
                <table class="table table-sm align-middle mb-0">
                    <thead class="bg-success text-white">
                        <tr>
                            <th>Material</th>
                            <th class="text-end" style="width:140px;">Stock</th>
                            <th class="text-end" style="width:140px;">Capacidad</th>
                            <th style="min-width:240px;">% Ocupación</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="inventario : ${inventarios}">
                            <td class="fw-semibold" th:text="${inventario.nombreMaterial()}">Material</td>
                            <td class="text-end" th:text="${#numbers.formatDecimal(inventario.stockActual(), 1, 'COMMA', 2, 'POINT')}">0.00</td>
                            <td class="text-end" th:text="${#numbers.formatDecimal(inventario.capacidadMaxima(), 1, 'COMMA', 2, 'POINT')}">0.00</td>
                            <td>
                                <th:block th:with="ocupacion = ${(inventario.stockActual() / inventario.capacidadMaxima() * 100).intValue()}">
                                    <div class="progress" style="height:18px;">
                                        <div class="progress-bar"
                                             th:classappend="${ocupacion >= inventario.umbralCritico() ? 'bg-danger' : ocupacion >= inventario.umbralAlerta() ? 'bg-warning' : 'bg-success'}"
                                             role="progressbar"
                                             th:attr="aria-valuenow=${ocupacion}, aria-valuemin='0', aria-valuemax='100'"
                                             th:style="'width: ' + ${ocupacion} + '%'">
                                            <span class="small" th:text="${ocupacion} + '%'">0%</span>
                                        </div>
                                    </div>
                                </th:block>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="small text-muted mt-2">Colores: <span class="badge bg-success">OK</span> <span class="badge bg-warning">Alerta</span> <span class="badge bg-danger">Crítico</span></div>
        </div>
    </div>

    <!-- Listado de materiales registrados en tarjetas -->
    <div>
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h3 class="h5">Materiales registrados</h3>
            <span class="badge bg-success" th:text="${#lists.size(inventarios)} + ' items'">0 items</span>
        </div>

        <div th:if="${#lists.isEmpty(inventarios)}" class="alert alert-info" role="alert">
            <strong>Sin materiales</strong> - No hay materiales registrados en el inventario.
        </div>

        <div class="row g-4" th:if="${not #lists.isEmpty(inventarios)}">
            <div class="col-12 col-md-6 col-lg-4" th:each="inventario : ${inventarios}">
                <!-- Tarjeta de Material -->
                <div class="card h-100 shadow-sm border-0 transition" style="transition: all 0.3s ease;">
                    <div class="card-header bg-success text-white d-flex justify-content-between align-items-start">
                        <div>
                            <h5 class="card-title mb-1" th:text="${inventario.nombreMaterial()}">Material</h5>
                            <small class="text-light" th:text="${inventario.unidadMedida()}">Unidad</small>
                        </div>
                        <span class="badge bg-info" th:text="${inventario.unidadMedida()}">Unidad</span>
                    </div>

                    <div class="card-body">
                        <!-- Datos principales -->
                        <div class="row mb-3">
                            <div class="col-6">
                                <small class="text-muted">Stock Actual</small>
                                <p class="fw-bold text-success" th:text="${#numbers.formatDecimal(inventario.stockActual(), 1, 'COMMA', 2, 'POINT')}">0.00</p>
                            </div>
                            <div class="col-6">
                                <small class="text-muted">Capacidad Máxima</small>
                                <p class="fw-bold text-primary" th:text="${#numbers.formatDecimal(inventario.capacidadMaxima(), 1, 'COMMA', 2, 'POINT')}">0.00</p>
                            </div>
                        </div>

                        <!-- Indicador de ocupación con código de color -->
                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <small class="text-muted">% Ocupación</small>
                                <th:block th:with="ocupacion = ${(inventario.stockActual() / inventario.capacidadMaxima() * 100).intValue()}">
                                    <small class="fw-bold"
                                           th:classappend="${ocupacion >= inventario.umbralCritico() ? 'text-danger' : ocupacion >= inventario.umbralAlerta() ? 'text-warning' : 'text-success'}"
                                           th:text="${ocupacion} + '%'">
                                        0%
                                    </small>
                                </th:block>
                            </div>
                            <th:block th:with="ocupacion = ${(inventario.stockActual() / inventario.capacidadMaxima() * 100).intValue()}">
                                <div class="progress" style="height: 20px;">
                                    <div class="progress-bar"
                                         th:classappend="${ocupacion >= inventario.umbralCritico() ? 'bg-danger' : ocupacion >= inventario.umbralAlerta() ? 'bg-warning' : 'bg-success'}"
                                         role="progressbar"
                                         th:attr="aria-valuenow=${ocupacion}, aria-valuemin='0', aria-valuemax='100'"
                                         th:style="'width: ' + ${ocupacion} + '%'">
                                        <small class="d-flex align-items-center justify-content-center h-100 text-dark fw-bold" th:text="${ocupacion} + '%'">0%</small>
                                    </div>
                                </div>
                            </th:block>
                        </div>

                        <!-- Información de precios -->
                        <hr class="my-2">
                        <div class="row small mb-3">
                            <div class="col-6">
                                <small class="text-muted">Precio Compra</small>
                                <p class="text-dark mb-0" th:text="${inventario.precioCompra() != null ? '$ ' + #numbers.formatDecimal(inventario.precioCompra(), 1, 'COMMA', 2, 'POINT') : 'N/A'}">$ 0.00</p>
                            </div>
                            <div class="col-6">
                                <small class="text-muted">Precio Venta</small>
                                <p class="text-dark mb-0" th:text="${inventario.precioVenta() != null ? '$ ' + #numbers.formatDecimal(inventario.precioVenta(), 1, 'COMMA', 2, 'POINT') : 'N/A'}">$ 0.00</p>
                            </div>
                        </div>

                        <!-- Umbral de alerta -->
                        <div class="alert alert-light border border-warning p-2 mb-0" role="alert">
                            <small class="text-muted">Umbrales:</small>
                            <div class="d-flex justify-content-between mt-1">
                                <small>
                                    <span class="badge bg-warning">Alerta: <span th:text="${inventario.umbralAlerta()}">0</span>%</span>
                                </small>
                                <small>
                                    <span class="badge bg-danger">Crítico: <span th:text="${inventario.umbralCritico()}">0</span>%</span>
                                </small>
                            </div>
                        </div>
                    </div>

                    <!-- Botón de detalles -->
                    <div class="card-footer bg-light border-top d-grid gap-2">
                        <button type="button" class="btn btn-outline-success btn-sm" 
                                th:data-material-id="${inventario.materialId()}"
                                th:data-nombre-material="${inventario.nombreMaterial()}"
                                th:data-stock-actual="${inventario.stockActual()}"
                                th:data-capacidad-maxima="${inventario.capacidadMaxima()}"
                                th:data-precio-compra="${inventario.precioCompra() != null ? inventario.precioCompra() : 0}"
                                th:data-precio-venta="${inventario.precioVenta() != null ? inventario.precioVenta() : 0}"
                                th:data-umbral-alerta="${inventario.umbralAlerta()}"
                                th:data-umbral-critico="${inventario.umbralCritico()}"
                                th:data-unidad-medida="${inventario.unidadMedida()}"
                                data-bs-toggle="modal" 
                                data-bs-target="#detallesModal">
                            <i class="bi bi-eye me-1"></i> Ver Detalles
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Modal para ver detalles del material -->
<div class="modal fade" id="detallesModal" tabindex="-1" aria-labelledby="detallesModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="detallesModalLabel">Detalles del Material</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <small class="text-muted">Nombre</small>
                        <h5 id="modalNombreMaterial">-</h5>
                    </div>
                    <div class="col-md-6 mb-3">
                        <small class="text-muted">ID del Material</small>
                        <p class="font-monospace" id="modalMaterialId">-</p>
                    </div>
                </div>

                <hr>

                <h6 class="mb-3">Inventario</h6>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <div class="card bg-light">
                            <div class="card-body">
                                <small class="text-muted">Stock Actual</small>
                                <p class="h5 text-success mb-0" id="modalStockActual">0.00</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <div class="card bg-light">
                            <div class="card-body">
                                <small class="text-muted">Capacidad Máxima</small>
                                <p class="h5 text-primary mb-0" id="modalCapacidadMaxima">0.00</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mb-3">
                    <small class="text-muted">Unidad de Medida</small>
                    <p class="h6 mb-0" id="modalUnidadMedida">-</p>
                </div>

                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <small class="text-muted">Ocupación</small>
                        <h6 id="modalOcupacionPorcentaje" class="mb-0">0%</h6>
                    </div>
                    <div class="progress" style="height: 25px;">
                        <div id="modalOcupacionBar" class="progress-bar" role="progressbar" style="width: 0%">
                            <small id="modalOcupacionText" class="d-flex align-items-center justify-content-center h-100 text-dark fw-bold">0%</small>
                        </div>
                    </div>
                </div>

                <hr>

                <h6 class="mb-3">Precios</h6>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <div class="card bg-light">
                            <div class="card-body">
                                <small class="text-muted">Precio Compra</small>
                                <p class="h5 mb-0" id="modalPrecioCompra">$ 0.00</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <div class="card bg-light">
                            <div class="card-body">
                                <small class="text-muted">Precio Venta</small>
                                <p class="h5 mb-0" id="modalPrecioVenta">$ 0.00</p>
                            </div>
                        </div>
                    </div>
                </div>

                <hr>

                <h6 class="mb-3">Umbrales de Alerta</h6>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <div class="alert alert-warning mb-0">
                            <small class="text-muted">Umbral de Alerta</small>
                            <p class="h5 text-warning mb-0" id="modalUmbralAlerta">0%</p>
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <div class="alert alert-danger mb-0">
                            <small class="text-muted">Umbral Crítico</small>
                            <p class="h5 text-danger mb-0" id="modalUmbralCritico">0%</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<!-- Script para manejar el modal de detalles -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const detallesModal = document.getElementById('detallesModal');
        
        detallesModal.addEventListener('show.bs.modal', function(event) {
            const button = event.relatedTarget;
            
            // Obtener datos del botón
            const materialId = button.getAttribute('data-material-id');
            const nombreMaterial = button.getAttribute('data-nombre-material');
            const stockActual = parseFloat(button.getAttribute('data-stock-actual'));
            const capacidadMaxima = parseFloat(button.getAttribute('data-capacidad-maxima'));
            const precioCompra = parseFloat(button.getAttribute('data-precio-compra'));
            const precioVenta = parseFloat(button.getAttribute('data-precio-venta'));
            const umbralAlerta = parseInt(button.getAttribute('data-umbral-alerta'));
            const umbralCritico = parseInt(button.getAttribute('data-umbral-critico'));
            const unidadMedida = button.getAttribute('data-unidad-medida');
            
            // Calcular ocupación
            const ocupacion = Math.round((stockActual / capacidadMaxima) * 100);
            
            // Determinar color de ocupación
            let colorClase = 'bg-success';
            if (ocupacion >= umbralCritico) {
                colorClase = 'bg-danger';
            } else if (ocupacion >= umbralAlerta) {
                colorClase = 'bg-warning';
            }
            
            // Actualizar elementos del modal
            document.getElementById('detallesModalLabel').textContent = nombreMaterial;
            document.getElementById('modalNombreMaterial').textContent = nombreMaterial;
            document.getElementById('modalMaterialId').textContent = materialId;
            document.getElementById('modalStockActual').textContent = stockActual.toLocaleString('es-CO', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            document.getElementById('modalCapacidadMaxima').textContent = capacidadMaxima.toLocaleString('es-CO', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            document.getElementById('modalUnidadMedida').textContent = unidadMedida;
            document.getElementById('modalOcupacionPorcentaje').textContent = ocupacion + '%';
            document.getElementById('modalOcupacionText').textContent = ocupacion + '%';
            document.getElementById('modalOcupacionBar').style.width = ocupacion + '%';
            document.getElementById('modalOcupacionBar').className = 'progress-bar ' + colorClase;
            document.getElementById('modalPrecioCompra').textContent = '$ ' + precioCompra.toLocaleString('es-CO', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            document.getElementById('modalPrecioVenta').textContent = '$ ' + precioVenta.toLocaleString('es-CO', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            document.getElementById('modalUmbralAlerta').textContent = umbralAlerta + '%';
            document.getElementById('modalUmbralCritico').textContent = umbralCritico + '%';
        });
    });
</script>

