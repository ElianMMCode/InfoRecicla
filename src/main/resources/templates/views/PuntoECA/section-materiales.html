<!-- Fragment: Materiales -->
<section th:fragment="materiales" class="py-4"
         th:data-gestor="${gestor}"
         th:data-usuario-id="${usuario.usuarioId}"
         th:data-punto-eca-id="${puntoEcaId}">
    <!-- T√≠tulo principal -->
    <div class="mb-4">
        <h2 class="h4 fw-bold text-dark mb-1">
            <i class="bi bi-box-seam me-2"></i>Gesti√≥n de Materiales
        </h2>
        <p class="text-muted small mb-0">Registra, visualiza y gestiona los materiales en el inventario del centro de acopio</p>
    </div>

    <!-- ACORDE√ìN PRINCIPAL CON TODO -->
    <div class="accordion accordion-flush shadow-sm" id="acordeonMateriales">

        <!--/*@thymesVar id="inventario" type="org.sena.inforecicla.dto.puntoEca.inventario.InventarioResponseDTO"*/-->
        <!-- Item 1: AGREGAR MATERIAL AL INVENTARIO -->
        <div class="accordion-item border-start border-5 border-success">
            <h2 class="accordion-header" id="headingAgregar">
                <button class="accordion-button fw-bold collapsed" type="button"
                        data-bs-toggle="collapse" data-bs-target="#collapseAgregar" aria-expanded="false"
                        aria-controls="collapseAgregar">
                    <span class="bg-success p-2 rounded-circle me-3" style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">
                        <i class="bi bi-plus-circle text-white"></i>
                    </span>
                    <span>
                        <span class="fw-bold text-dark d-block">Agregar Material al Inventario</span>
                        <small class="text-muted fw-normal">Registra nuevos materiales en tu inventario</small>
                    </span>
                </button>
            </h2>
            <div id="collapseAgregar" class="accordion-collapse collapse" aria-labelledby="headingAgregar"
                 data-bs-parent="#acordeonMateriales">
                <div class="accordion-body p-4 bg-light">
                    <!-- Barra de b√∫squeda principal con Select2 AJAX -->
                    <div class="row g-3 mb-4">
                        <div class="col-12">
                            <label class="form-label fw-semibold text-muted mb-1" for="buscarMaterialSelect">Buscar Material</label>
                            <select id="buscarMaterialSelect" class="form-select form-select-lg border-2 border-success js-select2-material" style="width: 100%;">
                                <option></option>
                            </select>
                            <small class="text-muted">Comienza a escribir o haz clic para ver todos los materiales disponibles</small>
                        </div>
                    </div>

                    <!-- Categor√≠a, Tipo y Limpiar lado a lado -->
                    <div class="row g-3 align-items-end mb-3">
                        <div class="col-md-4">
                            <label class="form-label fw-semibold text-muted mb-1" for="selectCategoriaBusqueda">Categor√≠a</label>
                            <select id="selectCategoriaBusqueda" class="form-select border-2 border-success js-select2-categoria" style="width: 100%;">
                                <option value="">-- Ninguno --</option>
                                <th:block th:if="${not #lists.isEmpty(categoriaMateriales)}">
                                    <option th:each="cat : ${categoriaMateriales}"
                                            th:value="${cat.nmbCategoria}"
                                            th:text="${cat.nmbCategoria}">
                                        Categor√≠a
                                    </option>
                                </th:block>
                            </select>
                        </div>

                        <div class="col-md-4">
                            <label class="form-label fw-semibold text-muted mb-1" for="selectTipoBusqueda">Tipo</label>
                            <select id="selectTipoBusqueda" class="form-select border-2 border-success js-select2-tipo" style="width: 100%;">
                                <option value="">-- Ninguno --</option>
                                <th:block th:if="${not #lists.isEmpty(tiposMateriales)}">
                                    <option th:each="tipo : ${tiposMateriales}"
                                            th:value="${tipo.nmbCategoria}"
                                            th:text="${tipo.nmbCategoria}">
                                        Tipo
                                    </option>
                                </th:block>
                            </select>
                        </div>

                        <div class="col-md-4">
                            <button id="btnLimpiarBusquedaAgregar" class="btn btn-outline-secondary w-100" type="button">
                                <i class="bi bi-eraser me-1"></i>Limpiar
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- MODAL: AGREGAR MATERIAL AL INVENTARIO -->
        <div class="modal fade" id="agregarInventarioModal" tabindex="-1" aria-labelledby="agregarInventarioModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-scrollable">
                <div class="modal-content">
                    <div class="modal-header bg-success text-white">
                        <h5 class="modal-title" id="agregarInventarioModalLabel">
                            <i class="bi bi-plus-circle me-2"></i>Agregar Material al Inventario
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                    </div>
                    <div class="modal-body">
                        <form id="formAgregarInventario">
                            <!-- Input hidden para guardar el ID del material (no visible) -->
                            <input type="hidden" id="agregarMaterialId">
                            <!-- Input hidden para guardar el ID del punto (no visible) -->
                            <input type="hidden" id="agregarPuntoId" th:value="${usuario.puntoEcaId()}">
                            <div class="row g-3 mb-4">
                                <div class="col-12">
                                    <label for="agregarMaterialNombre" class="form-label fw-semibold">Material Seleccionado</label>
                                    <input type="text" class="form-control" id="agregarMaterialNombre" readonly style="background-color: #f5f5f5;">
                                </div>
                            </div>

                            <!-- Divisor -->
                            <hr class="my-4">

                            <!-- Fila 2: Datos de Inventario -->
                            <h6 class="fw-semibold text-success mb-3">Datos de Inventario</h6>

                            <div class="row g-3 mb-3">
                                <div class="col-md-6">
                                    <label for="stockInicial" class="form-label fw-semibold">Stock Inicial</label>
                                    <input type="number" class="form-control border-2 border-success" id="stockInicial" placeholder="0" min="0" required>
                                    <small class="text-muted">Cantidad inicial a agregar</small>
                                </div>
                                <div class="col-md-6">
                                    <label for="capacidadMaxima" class="form-label fw-semibold">Capacidad M√°xima</label>
                                    <input type="number" class="form-control border-2 border-success" id="capacidadMaxima" placeholder="1000" min="0" required>
                                    <small class="text-muted">M√°ximo que puede almacenar</small>
                                </div>
                            </div>

                            <!-- Fila 2.5: Unidad de Medida -->
                            <div class="row g-3 mb-3">
                                <div class="col-md-6">
                                    <label for="unidadMedida" class="form-label fw-semibold">Unidad de Medida</label>
                                    <select class="form-select border-2 border-success" id="unidadMedida" required>
                                        <option value="" selected disabled>Selecciona una unidad</option>
                                        <th:block th:if="${not #lists.isEmpty(unidadesMedida)}">
                                            <option th:each="unidad : ${unidadesMedida}"
                                                    th:value="${unidad.clave}"
                                                    th:text="${unidad.nombre}">
                                                Unidad
                                            </option>
                                        </th:block>
                                        <th:block th:if="${#lists.isEmpty(unidadesMedida)}">
                                            <option disabled>No hay unidades disponibles</option>
                                        </th:block>
                                    </select>
                                    <small class="text-muted">Selecciona la unidad de medida para el stock</small>
                                </div>
                            </div>

                            <!-- Fila 3: Precios -->
                            <h6 class="fw-semibold text-success mb-3 mt-4">Precios</h6>

                            <div class="row g-3 mb-3">
                                <div class="col-md-6">
                                    <label for="precioCompra" class="form-label fw-semibold">Precio de Compra</label>
                                    <div class="input-group">
                                        <span class="input-group-text">$</span>
                                        <input type="number" class="form-control border-2 border-success" id="precioCompra" placeholder="0.00" min="0" step="0.01" required>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label for="precioVenta" class="form-label fw-semibold">Precio de Venta</label>
                                    <div class="input-group">
                                        <span class="input-group-text">$</span>
                                        <input type="number" class="form-control border-2 border-success" id="precioVenta" placeholder="0.00" min="0" step="0.01" required>
                                    </div>
                                </div>
                            </div>

                            <!-- Fila 4: Umbrales -->
                            <h6 class="fw-semibold text-success mb-3 mt-4">Umbrales de Alerta</h6>

                            <div class="row g-3 mb-3">
                                <div class="col-md-6">
                                    <label for="umbralAlerta" class="form-label fw-semibold">Umbral de Alerta (%)</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control border-2 border-success" id="umbralAlerta" placeholder="25" min="0" max="100" step="1" required>
                                        <span class="input-group-text">%</span>
                                    </div>
                                    <small class="text-muted">Porcentaje m√≠nimo antes de alertar</small>
                                </div>
                                <div class="col-md-6">
                                    <label for="umbralCritico" class="form-label fw-semibold">Umbral Cr√≠tico (%)</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control border-2 border-success" id="umbralCritico" placeholder="10" min="0" max="100" step="1" required>
                                        <span class="input-group-text">%</span>
                                    </div>
                                    <small class="text-muted">Porcentaje cr√≠tico de stock</small>
                                </div>
                            </div>

                            <!-- Mensaje de estado -->
                            <div id="mensajeEstado" class="alert alert-info mt-4" style="display: none;" role="alert">
                                <i class="bi bi-info-circle me-2"></i>
                                <span id="textoMensaje"></span>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer border-top bg-light">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="bi bi-x-circle me-1"></i>Cancelar
                        </button>
                        <button type="button" class="btn btn-success" id="btnGuardarInventario">
                            <i class="bi bi-check-circle me-1"></i>Guardar en Inventario
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- SCRIPT INLINE PARA MANEJAR BOT√ìN LIMPIAR -->
        <script>
        (function() {
            console.log('üìå Script inline de limpiar ejecut√°ndose...');

            // ============================================================
            // HANDLER: BOT√ìN LIMPIAR
            // ============================================================
            const btnLimpiarAgregar = document.getElementById('btnLimpiarBusquedaAgregar');
            if (btnLimpiarAgregar) {
                btnLimpiarAgregar.addEventListener('click', function() {
                    console.log('üßπ Limpiando b√∫squeda y filtros del acorde√≥n agregar...');

                    // Limpiar Select2 de Buscar Material
                    $('#buscarMaterialSelect').val(null).trigger('change');
                    console.log('‚úì Limpiado: Buscar Material');

                    // Limpiar Select2 de Categor√≠a
                    $('#selectCategoriaBusqueda').val('').trigger('change');
                    console.log('‚úì Limpiado: Categor√≠a');

                    // Limpiar Select2 de Tipo
                    $('#selectTipoBusqueda').val('').trigger('change');
                    console.log('‚úì Limpiado: Tipo');

                    console.log('‚úì Todos los campos limpiados correctamente');
                });
                console.log('‚úì Handler LIMPIAR vinculado');
            }

            console.log('‚úì Script inline completado');
        })();
        </script>

        <!-- Item 2: OCUPACI√ìN DE INVENTARIO -->
        <div class="accordion-item border-start border-5 border-info">
            <h2 class="accordion-header" id="headingOcupacion">
                <button class="accordion-button fw-bold collapsed" type="button"
                        data-bs-toggle="collapse" data-bs-target="#collapseOcupacion" aria-expanded="false"
                        aria-controls="collapseOcupacion">
                    <span class="bg-info p-2 rounded-circle me-3" style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">
                        <i class="bi bi-graph-up text-white"></i>
                    </span>
                    <span>
                        <span class="fw-bold text-dark d-block">Ocupaci√≥n de Inventario</span>
                        <small class="text-muted fw-normal"><span th:text="${inventario != null ? inventario.size() : 0}">0</span> materiales registrados</small>
                    </span>
                </button>
            </h2>
            <div id="collapseOcupacion" class="accordion-collapse collapse" aria-labelledby="headingOcupacion"
                 data-bs-parent="#acordeonMateriales">
                <div class="accordion-body p-4 bg-light">
                    <div th:if="${#lists.isEmpty(inventario)}" class="text-muted text-center py-3">
                        No hay datos de inventario disponibles
                    </div>
                    <div class="table-responsive" th:if="${not #lists.isEmpty(inventario)}">
                        <table class="table table-sm align-middle mb-0">
                            <thead class="bg-success text-white">
                                <tr>
                                    <th>Material</th>
                                    <th class="text-end" style="width:140px;">Stock</th>
                                    <th class="text-end" style="width:140px;">Capacidad</th>
                                    <th style="min-width:240px;">% Ocupaci√≥n</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr th:each="inventario : ${inventario}">
                                    <td class="fw-semibold" th:text="${inventario.nombreMaterial()}">Material</td>
                                    <td class="text-end"
                                        th:text="${#numbers.formatDecimal(inventario.stockActual(), 1, 'COMMA', 2, 'POINT')}">0.00</td>
                                    <td class="text-end"
                                        th:text="${#numbers.formatDecimal(inventario.capacidadMaxima(), 1, 'COMMA', 2, 'POINT')}">0.00</td>
                                    <td>
                                        <th:block th:with="ocupacion = ${(inventario.stockActual() / inventario.capacidadMaxima() * 100).intValue()}">
                                            <div class="progress" style="height:18px;">
                                                <div class="progress-bar"
                                                     th:classappend="${ocupacion >= inventario.umbralCritico() ? 'bg-danger' : (ocupacion >= inventario.umbralAlerta() ? 'bg-warning' : 'bg-success')}"
                                                     role="progressbar"
                                                     th:attr="aria-valuenow=${ocupacion}, aria-valuemin='0', aria-valuemax='100'"
                                                     th:style="'width: ' + ${ocupacion} + '%'">
                                                    <span class="small" th:text="${ocupacion} + '%'">0%</span>
                                                </div>
                                            </div>
                                        </th:block>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="small text-muted mt-2">
                        Colores: <span class="badge bg-success">OK</span> <span class="badge bg-warning">Alerta</span>
                        <span class="badge bg-danger">Cr√≠tico</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Item 3: MATERIALES EN INVENTARIO -->
        <div class="accordion-item border-start border-5 border-primary">
            <h2 class="accordion-header" id="headingTarjetas">
                <button class="accordion-button fw-bold" type="button"
                        data-bs-toggle="collapse" data-bs-target="#collapseTarjetas"
                        aria-expanded="true" aria-controls="collapseTarjetas">
                    <span class="bg-primary p-2 rounded-circle me-3" style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">
                        <i class="bi bi-collection text-white"></i>
                    </span>
                    <span>
                        <span class="fw-bold text-dark d-block">Materiales en Inventario</span>
                        <small class="text-muted fw-normal"><span th:text="${inventario != null ? inventario.size() : 0}">0</span> items disponibles</small>
                    </span>
                </button>
            </h2>
            <div id="collapseTarjetas" class="accordion-collapse collapse show"
                 aria-labelledby="headingTarjetas" data-bs-parent="#acordeonMateriales">
                <div class="accordion-body p-4 bg-light">
                    <div class="accordion mb-4" id="acordeonFiltrosTarjetas">
                        <div class="accordion-item border-bottom border-2 border-secondary-subtle">
                            <h2 class="accordion-header bg-light" id="headingBusquedaTarjetas">
                                <button class="accordion-button fw-semibold collapsed" type="button"
                                        data-bs-toggle="collapse" data-bs-target="#collapseBusquedaTarjetas"
                                        aria-expanded="false" aria-controls="collapseBusquedaTarjetas">
                                    <i class="bi bi-funnel text-muted me-2"></i>
                                    <span>B√∫squeda y Filtros</span>
                                </button>
                            </h2>
                            <div id="collapseBusquedaTarjetas" class="accordion-collapse collapse"
                                 aria-labelledby="headingBusquedaTarjetas" data-bs-parent="#acordeonFiltrosTarjetas">
                                <div class="accordion-body p-4 bg-white">
                                    <!-- Select2: Buscar Material - Solo para seleccionar -->
                                    <div class="row g-3 mb-4">
                                        <div class="col-12">
                                            <label class="form-label fw-semibold text-muted mb-1" for="busquedaMaterialInventario">Buscar Material</label>
                                            <select id="busquedaMaterialInventario" class="form-select border-2 border-success js-select2-busqueda-inventario" style="width: 100%;">
                                                <option></option>
                                            </select>
                                        </div>
                                    </div>

                                    <!-- Categor√≠a, Tipo, Alerta, Unidad, Ocupaci√≥n -->
                                    <div class="row g-3 mb-3">
                                        <div class="col-md-6 col-lg-3">
                                            <label class="form-label fw-semibold text-muted mb-1" for="filtroCategoriaSelectInventario">Categor√≠a</label>
                                            <select id="filtroCategoriaSelectInventario" class="form-select border-2 border-success js-select2-filtro-categoria-inventario" style="width: 100%;">
                                                <option value="">-- Ninguno --</option>
                                                <th:block th:if="${not #lists.isEmpty(categoriaMateriales)}">
                                                    <option th:each="cat : ${categoriaMateriales}"
                                                            th:value="${cat.nmbCategoria}"
                                                            th:text="${cat.nmbCategoria}">
                                                        Categor√≠a
                                                    </option>
                                                </th:block>
                                            </select>
                                        </div>

                                        <div class="col-md-6 col-lg-3">
                                            <label class="form-label fw-semibold text-muted mb-1" for="filtroTipoSelectInventario">Tipo</label>
                                            <select id="filtroTipoSelectInventario" class="form-select border-2 border-success js-select2-filtro-tipo-inventario" style="width: 100%;">
                                                <option value="">-- Ninguno --</option>
                                                <th:block th:if="${not #lists.isEmpty(tiposMateriales)}">
                                                    <option th:each="tipo : ${tiposMateriales}"
                                                            th:value="${tipo.nmbCategoria}"
                                                            th:text="${tipo.nmbCategoria}">
                                                        Tipo
                                                    </option>
                                                </th:block>
                                            </select>
                                        </div>

                                        <div class="col-md-6 col-lg-3">
                                            <label for="filtroAlerataInventario" class="form-label fw-semibold text-muted mb-1">
                                                <i class="bi bi-exclamation-triangle me-1"></i>Alerta
                                            </label>
                                            <select class="form-select border-2 border-success js-select2-filtro-alerta-inventario"
                                                    id="filtroAlerataInventario"
                                                    style="width: 100%;">
                                                <option value="">Todas las alertas</option>
                                                <th:block th:if="${not #lists.isEmpty(alerta)}">
                                                    <option th:each="alert : ${alerta}"
                                                            th:value="${alert.clave}"
                                                            th:text="${alert.tipo}">
                                                        Alerta
                                                    </option>
                                                </th:block>
                                            </select>
                                        </div>

                                        <div class="col-md-6 col-lg-3">
                                            <label for="filtroUnidadInventario" class="form-label fw-semibold text-muted mb-1">
                                                <i class="bi bi-ruler me-1"></i>Unidad de Medida
                                            </label>
                                            <select class="form-select border-2 border-success js-select2-filtro-unidad-inventario"
                                                    id="filtroUnidadInventario"
                                                    style="width: 100%;">
                                                <option value="">Todas las unidades</option>
                                                <th:block th:if="${not #lists.isEmpty(unidadesMedida)}">
                                                    <option th:each="unidad : ${unidadesMedida}"
                                                            th:value="${unidad.clave}"
                                                            th:text="${unidad.nombre}">
                                                        Unidad
                                                    </option>
                                                </th:block>
                                            </select>
                                        </div>
                                    </div>

                                    <!-- Ocupaci√≥n y Botones -->
                                    <div class="row g-3 mb-3">
                                        <div class="col-md-6 col-lg-3">
                                            <label for="filtroOcupacionInventario" class="form-label fw-semibold text-muted mb-1">
                                                <i class="bi bi-percent me-1"></i>Ocupaci√≥n
                                            </label>
                                            <select class="form-select border-2 border-success js-select2-filtro-ocupacion-inventario"
                                                    id="filtroOcupacionInventario"
                                                    style="width: 100%;">
                                                <option value="">Cualquier ocupaci√≥n</option>
                                                <option value="0-25">0% - 25%</option>
                                                <option value="25-50">25% - 50%</option>
                                                <option value="50-75">50% - 75%</option>
                                                <option value="75-100">75% - 100%</option>
                                            </select>
                                        </div>

                                        <div class="col-md-6 col-lg-3 d-flex align-items-end gap-2">
                                            <button id="btnBuscarInventario" class="btn btn-success flex-grow-1" type="button">
                                                <i class="bi bi-search me-1"></i>Buscar
                                            </button>
                                            <button id="btnLimpiarTodosFiltraInventario" class="btn btn-outline-secondary" type="button" title="Limpiar todos los filtros">
                                                <i class="bi bi-eraser me-1"></i>Limpiar
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                    <!-- Espaciador entre acorde√≥n y tarjetas -->
                    <div class="my-4"></div>

                    <div th:if="${mensajeAlerta != null and !#strings.isEmpty(mensajeAlerta)}" class="alert alert-warning" role="alert">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        <strong th:text="${mensajeAlerta}">Mensaje de alerta</strong>
                    </div>

                    <div th:if="${#lists.isEmpty(inventario) and (mensajeAlerta == null or #strings.isEmpty(mensajeAlerta))}" class="alert alert-info" role="alert">
                        <i class="bi bi-info-circle me-2"></i>
                        <strong>Sin materiales</strong> - No hay materiales registrados en el inventario.
                    </div>

                    <div class="row g-4" th:if="${not #lists.isEmpty(inventario)}" id="contenedorMateriales">
                        <div class="col-12 col-md-6 col-lg-4 tarjeta-material"
                             th:each="inventario : ${inventario}"
                             th:data-nombre-material="${inventario.nombreMaterial()}"
                             th:data-unidad-medida="${inventario.unidadMedida()}"
                             th:with="ocupacion = ${(inventario.stockActual() / inventario.capacidadMaxima() * 100).intValue()}">
                            <!-- Tarjeta de Material -->
                            <div class="card h-100 shadow-sm border-0 transition"
                                 style="transition: all 0.3s ease;"
                                 th:classappend="${ocupacion >= inventario.umbralCritico() ? 'estado-critico' : (ocupacion >= inventario.umbralAlerta() ? 'estado-alerta' : 'estado-ok')}"
                                 th:data-ocupacion="${ocupacion}"
                                 th:data-estado="${ocupacion >= inventario.umbralCritico() ? 'critico' : (ocupacion >= inventario.umbralAlerta() ? 'alerta' : 'ok')}"
                                 th:data-stock-actual="${inventario.stockActual()}"
                                 th:data-capacidad-maxima="${inventario.capacidadMaxima()}">
                                <div class="card-header bg-success text-white d-flex justify-content-between align-items-start">
                                    <div>
                                        <h5 class="card-title mb-1" th:text="${inventario.nombreMaterial()}">Material</h5>
                                        <small class="text-light" th:text="${inventario.unidadMedida()}">Unidad</small>
                                    </div>
                                    <span class="badge bg-info" th:text="${inventario.unidadMedida()}">Unidad</span>
                                </div>

                                <div class="card-body">
                                    <!-- Datos principales -->
                                    <div class="row mb-3">
                                        <div class="col-6">
                                            <small class="text-muted">Stock Actual</small>
                                            <p class="fw-bold text-success" th:text="${#numbers.formatDecimal(inventario.stockActual(), 1, 'COMMA', 2, 'POINT')}">0.00</p>
                                        </div>
                                        <div class="col-6">
                                            <small class="text-muted">Capacidad M√°xima</small>
                                            <p class="fw-bold text-primary" th:text="${#numbers.formatDecimal(inventario.capacidadMaxima(), 1, 'COMMA', 2, 'POINT')}">0.00</p>
                                        </div>
                                    </div>

                                    <!-- Indicador de ocupaci√≥n con c√≥digo de color -->
                                    <div class="mb-3">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <small class="text-muted">% Ocupaci√≥n</small>
                                            <th:block th:with="ocupacion = ${(inventario.stockActual() / inventario.capacidadMaxima() * 100).intValue()}">
                                                <small class="fw-bold"
                                                       th:classappend="${ocupacion >= inventario.umbralCritico() ? 'text-danger' : (ocupacion >= inventario.umbralAlerta() ? 'text-warning' : 'text-success')}"
                                                       th:text="${ocupacion} + '%'">
                                                    0%
                                                </small>
                                            </th:block>
                                        </div>
                                        <th:block th:with="ocupacion = ${(inventario.stockActual() / inventario.capacidadMaxima() * 100).intValue()}">
                                            <div class="progress" style="height: 20px;">
                                                <div class="progress-bar"
                                                     th:classappend="${ocupacion >= inventario.umbralCritico() ? 'bg-danger' : (ocupacion >= inventario.umbralAlerta() ? 'bg-warning' : 'bg-success')}"
                                                     role="progressbar"
                                                     th:attr="aria-valuenow=${ocupacion}, aria-valuemin='0', aria-valuemax='100'"
                                                     th:style="'width: ' + ${ocupacion} + '%'">
                                                    <small class="d-flex align-items-center justify-content-center h-100 text-dark fw-bold" th:text="${ocupacion} + '%'">0%</small>
                                                </div>
                                            </div>
                                        </th:block>
                                    </div>

                                    <!-- Informaci√≥n de precios -->
                                    <hr class="my-2">
                                    <div class="row small mb-3">
                                        <div class="col-6">
                                            <small class="text-muted">Precio Compra</small>
                                            <p class="text-dark mb-0" th:text="${inventario.precioCompra() != null ? '$ ' + #numbers.formatDecimal(inventario.precioCompra(), 1, 'COMMA', 2, 'POINT') : 'N/A'}">$ 0.00</p>
                                        </div>
                                        <div class="col-6">
                                            <small class="text-muted">Precio Venta</small>
                                            <p class="text-dark mb-0" th:text="${inventario.precioVenta() != null ? '$ ' + #numbers.formatDecimal(inventario.precioVenta(), 1, 'COMMA', 2, 'POINT') : 'N/A'}">$ 0.00</p>
                                        </div>
                                    </div>

                                    <!-- Umbral de alerta -->
                                    <div class="alert alert-light border border-warning p-2 mb-0" role="alert">
                                        <small class="text-muted">Umbrales:</small>
                                        <div class="d-flex justify-content-between mt-1">
                                            <small>
                                                <span class="badge bg-warning">Alerta: <span th:text="${inventario.umbralAlerta()}">0</span>%</span>
                                            </small>
                                            <small>
                                                <span class="badge bg-danger">Cr√≠tico: <span th:text="${inventario.umbralCritico()}">0</span>%</span>
                                            </small>
                                        </div>
                                    </div>
                                </div>

                                <!-- Bot√≥n de detalles -->
                                <div class="card-footer bg-light border-top d-grid gap-2">
                                    <button type="button" class="btn btn-success btn-sm detallesBtn"
                                            th:data-inventario-id="${inventario.inventarioId() != null ? inventario.inventarioId() : ''}"
                                            th:data-material-id="${inventario.materialId() != null ? inventario.materialId() : ''}"
                                            th:data-nombre-material="${inventario.nombreMaterial()}"
                                            th:data-stock-actual="${inventario.stockActual()}"
                                            th:data-capacidad-maxima="${inventario.capacidadMaxima()}"
                                            th:data-precio-compra="${inventario.precioCompra() != null ? inventario.precioCompra() : 0}"
                                            th:data-precio-venta="${inventario.precioVenta() != null ? inventario.precioVenta() : 0}"
                                            th:data-umbral-alerta="${inventario.umbralAlerta()}"
                                            th:data-umbral-critico="${inventario.umbralCritico()}"
                                            th:data-unidad-medida="${inventario.unidadMedida()}">
                                        <i class="bi bi-eye me-1"></i> Ver Detalles
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    </div>

    <!-- MODALS: reemplazo por la versi√≥n global solicitada -->

    <!-- MODAL GLOBAL - DISPONIBLE EN TODAS LAS P√ÅGINAS -->
    <div class="modal fade" id="detallesModal" tabindex="-1" aria-labelledby="detallesModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content border-0 shadow-lg rounded-3">
                <!-- Header con fondo verde -->
                <div class="modal-header border-0 bg-success text-white p-4 rounded-top-3">
                    <div>
                        <h5 class="modal-title fw-bold fs-5" id="detallesModalLabel">
                            <i class="bi bi-box-seam me-2"></i><span id="modalHeaderNombre">Detalles del Material</span>
                        </h5>
                        <small class="text-white-50"><i class="bi bi-info-circle me-1"></i>Informaci√≥n completa del inventario</small>
                    </div>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <div class="modal-body p-0">
                    <!-- Secci√≥n 1: Informaci√≥n B√°sica -->
                    <div class="p-4 border-bottom bg-light">
                        <h6 class="text-success mb-3 fw-bold"><i class="bi bi-info-circle me-2"></i>Informaci√≥n B√°sica</h6>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="p-3 rounded-2 bg-light border-start border-4 border-success">
                                    <small class="text-muted d-block mb-1"><i class="bi bi-tag me-1"></i>Nombre del Material</small>
                                    <p class="h6 text-success fw-bold mb-0" id="modalNombreMaterial">-</p>
                                </div>
                            </div>
                            <div class="col-md-6 d-none">
                                <div class="p-3 rounded-2 bg-light border-start border-4 border-primary">
                                    <small class="text-muted d-block mb-1"><i class="bi bi-code-square me-1"></i>ID del Material</small>
                                    <p class="h6 font-monospace text-primary fw-bold mb-0" id="modalMaterialId">-</p>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="p-3 rounded-2 bg-warning bg-opacity-10 border-start border-4 border-warning">
                                    <small class="text-muted d-block mb-1"><i class="bi bi-rulers me-1"></i>Unidad de Medida</small>
                                    <p class="h6 fw-bold mb-0" id="modalUnidadMedida">-</p>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="p-3 rounded-2 bg-danger bg-opacity-10 border-start border-4 border-danger">
                                    <small class="text-muted d-block mb-1"><i class="bi bi-circle-fill me-1" id="modalEstadoIcon"></i>Estado Actual</small>
                                    <p class="h6 fw-bold mb-0" id="modalEstadoText">-</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Secci√≥n 2: Ocupaci√≥n -->
                    <div class="p-4 border-bottom">
                        <h6 class="text-success mb-3 fw-bold"><i class="bi bi-pie-chart me-2"></i>Ocupaci√≥n del Inventario <span class="badge bg-success" id="modalOcupacionPorcentaje">0%</span></h6>
                        <div class="progress rounded-pill" style="height: 40px;">
                            <div id="modalOcupacionBar" class="progress-bar d-flex align-items-center justify-content-center fw-bold text-white fs-6">
                                <small id="modalOcupacionText">0%</small>
                            </div>
                        </div>
                    </div>

                    <!-- Secci√≥n 3: Stock e Inventario -->
                    <div class="p-4 border-bottom bg-light">
                        <h6 class="text-success mb-3 fw-bold"><i class="bi bi-inbox me-2"></i>Inventario</h6>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="p-3 rounded-2 bg-white border border-success border-opacity-25 border-start border-4 border-success">
                                    <small class="text-muted d-block mb-1"><i class="bi bi-inbox me-1"></i>Stock Actual</small>
                                    <p class="h5 text-success fw-bold mb-1" id="modalStockActual">0.00</p>
                                    <small class="text-muted" id="modalStockUnidad">unidades</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="p-3 rounded-2 bg-white border border-primary border-opacity-25 border-start border-4 border-primary">
                                    <small class="text-muted d-block mb-1"><i class="bi bi-archive me-1"></i>Capacidad M√°xima</small>
                                    <p class="h5 text-primary fw-bold mb-1" id="modalCapacidadMaxima">0.00</p>
                                    <small class="text-muted" id="modalCapacidadUnidad">unidades</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="p-3 rounded-2 bg-white border border-info border-opacity-25 border-start border-4 border-info">
                                    <small class="text-muted d-block mb-1"><i class="bi bi-diagram-3 me-1"></i>Espacio Usado</small>
                                    <p class="h5 text-info fw-bold mb-0" id="modalEspacioUsado">0.00</p>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="p-3 rounded-2 bg-white border border-warning border-opacity-25 border-start border-4 border-warning">
                                    <small class="text-muted d-block mb-1"><i class="bi bi-diagram-3 me-1"></i>Espacio Disponible</small>
                                    <p class="h5 text-warning fw-bold mb-0" id="modalEspacioDisponible">0.00</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Secci√≥n 4: Precios y M√°rgenes -->
                    <div class="p-4 border-bottom">
                        <h6 class="text-success mb-3 fw-bold"><i class="bi bi-tag-fill me-2"></i>An√°lisis de Precios</h6>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="p-3 rounded-2 bg-primary bg-opacity-10 border-start border-4 border-primary">
                                    <small class="text-muted d-block mb-1"><i class="bi bi-cart-plus me-1"></i>Precio de Compra</small>
                                    <p class="h5 text-primary fw-bold mb-0" id="modalPrecioCompra">$ 0.00</p>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="p-3 rounded-2 bg-warning bg-opacity-10 border-start border-4 border-warning">
                                    <small class="text-muted d-block mb-1"><i class="bi bi-cart-check me-1"></i>Precio de Venta</small>
                                    <p class="h5 text-warning fw-bold mb-0" id="modalPrecioVenta">$ 0.00</p>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="p-3 rounded-2 bg-danger bg-opacity-10 border-start border-4 border-danger">
                                    <small class="text-muted d-block mb-1"><i class="bi bi-percent me-1"></i>Margen de Ganancia</small>
                                    <p class="h5 text-danger fw-bold mb-0" id="modalMargenGanancia">$ 0.00</p>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="p-3 rounded-2 bg-success bg-opacity-10 border-start border-4 border-success">
                                    <small class="text-muted d-block mb-1"><i class="bi bi-percent me-1"></i>% Margen</small>
                                    <p class="h5 text-success fw-bold mb-0" id="modalPorcentajeMargen">0%</p>
                                </div>
                            </div>
                            <div class="col-12">
                                <div class="p-3 rounded-2 bg-white border-3 border-success">
                                    <small class="text-muted d-block mb-1"><i class="bi bi-calculator me-1 text-success"></i>Valor Total en Inventario</small>
                                    <p class="h4 text-success fw-bold mb-0" id="modalValorTotal">$ 0.00</p>
                                    <small class="text-muted">(Stock Actual √ó Precio Compra)</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Secci√≥n 5: Umbrales y Alertas -->
                    <div class="p-4 border-bottom bg-light">
                        <h6 class="text-success mb-3 fw-bold"><i class="bi bi-exclamation-triangle me-2"></i>Umbrales y Alertas</h6>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="p-3 rounded-2 bg-warning bg-opacity-10 border-start border-4 border-warning">
                                    <small class="text-muted d-block mb-1"><i class="bi bi-exclamation-triangle me-1"></i>Umbral de Alerta</small>
                                    <p class="h5 text-warning fw-bold mb-0" id="modalUmbralAlerta">0%</p>
                                    <small class="text-muted">Se activa al superar este %</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="p-3 rounded-2 bg-danger bg-opacity-10 border-start border-4 border-danger">
                                    <small class="text-muted d-block mb-1"><i class="bi bi-exclamation-octagon me-1"></i>Umbral Cr√≠tico</small>
                                    <p class="h5 text-danger fw-bold mb-0" id="modalUmbralCritico">0%</p>
                                    <small class="text-muted">Requiere atenci√≥n inmediata</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Indicador de Estado -->
                    <div class="p-4 border-bottom" id="modalEstadoIndicador"></div>

                    <!-- Resumen de Alertas -->
                    <div class="p-4" id="modalResumenAlertas"></div>
                </div>

                <div class="modal-footer bg-light border-top">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle me-1"></i>Cerrar
                    </button>
                    <button type="button" class="btn btn-warning" id="btnEditarMaterial">
                        <i class="bi bi-pencil me-1"></i>Editar
                    </button>
                    <button type="button" class="btn btn-danger" id="btnBorrarMaterial">
                        <i class="bi bi-trash me-1"></i>Borrar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL EDITAR - PARA EDITAR DATOS DEL INVENTARIO -->
    <div class="modal fade" id="editarModal" tabindex="-1" aria-labelledby="editarModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content border-0 shadow-lg rounded-3">
                <!-- Header -->
                <div class="modal-header border-0 bg-warning text-dark p-4 rounded-top-3">
                    <div>
                        <h5 class="modal-title fw-bold fs-5" id="editarModalLabel">
                            <i class="bi bi-pencil-square me-2"></i>Editar Inventario
                        </h5>
                        <small class="text-secondary"><i class="bi bi-info-circle me-1"></i>Actualiza los datos del material</small>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <div class="modal-body p-4">
                    <form id="formularioEditarInventario">
                        <!-- Material ID (oculto) -->
                        <input type="hidden" id="editarMaterialId" value="">

                        <!-- Row 1: Stock y Capacidad -->
                        <div class="row g-3 mb-4">
                            <div class="col-md-6">
                                <label for="editarStockActual" class="form-label fw-bold">
                                    <i class="bi bi-inbox text-success me-2"></i>Stock Actual
                                </label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="editarStockActual" step="0.01" required>
                                    <span class="input-group-text" id="editarStockUnidad">un.</span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label for="editarCapacidadMaxima" class="form-label fw-bold">
                                    <i class="bi bi-archive text-primary me-2"></i>Capacidad M√°xima
                                </label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="editarCapacidadMaxima" step="0.01" required>
                                    <span class="input-group-text" id="editarCapacidadUnidad">un.</span>
                                </div>
                            </div>
                        </div>

                        <!-- Row 1.5: Unidad de Medida -->
                        <div class="row g-3 mb-4">
                            <div class="col-md-6">
                                <label for="editarUnidadMedida" class="form-label fw-bold">
                                    <i class="bi bi-rulers text-warning me-2"></i>Unidad de Medida
                                </label>
                                <select class="form-select" id="editarUnidadMedida" required>
                                    <option value="">-- Seleccionar unidad --</option>
                                    <th:block th:if="${not #lists.isEmpty(unidadesMedida)}">
                                        <option th:each="unidad : ${unidadesMedida}"
                                                th:value="${unidad.clave}"
                                                th:text="${unidad.nombre}">Unidad</option>
                                    </th:block>
                                </select>
                                <small class="text-muted d-block mt-2">Selecciona la unidad de medida del material</small>
                            </div>
                        </div>

                        <!-- Row 2: Precios -->
                        <div class="row g-3 mb-4">
                            <div class="col-md-6">
                                <label for="editarPrecioCompra" class="form-label fw-bold">
                                    <i class="bi bi-cart-plus text-info me-2"></i>Precio de Compra
                                </label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input type="number" class="form-control" id="editarPrecioCompra" step="0.01" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label for="editarPrecioVenta" class="form-label fw-bold">
                                    <i class="bi bi-cart-check text-warning me-2"></i>Precio de Venta
                                </label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input type="number" class="form-control" id="editarPrecioVenta" step="0.01" required>
                                </div>
                            </div>
                        </div>

                        <!-- Row 3: Umbrales -->
                        <div class="row g-3 mb-4">
                            <div class="col-md-6">
                                <label for="editarUmbralAlerta" class="form-label fw-bold">
                                    <i class="bi bi-exclamation-triangle text-warning me-2"></i>Umbral de Alerta (%)
                                </label>
                                <input type="number" class="form-control" id="editarUmbralAlerta" min="0" max="100" required>
                            </div>
                            <div class="col-md-6">
                                <label for="editarUmbralCritico" class="form-label fw-bold">
                                    <i class="bi bi-exclamation-octagon text-danger me-2"></i>Umbral Cr√≠tico (%)
                                </label>
                                <input type="number" class="form-control" id="editarUmbralCritico" min="0" max="100" required>
                            </div>
                        </div>

                        <!-- Resumen de cambios -->
                        <div class="alert alert-info rounded-2" role="alert">
                            <i class="bi bi-info-circle me-2"></i>
                            <strong>Nota:</strong> Los cambios se guardar√°n en la base de datos. Aseg√∫rate de verificar los datos antes de guardar.
                        </div>
                    </form>
                </div>

                <div class="modal-footer bg-light border-top">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle me-1"></i>Cancelar
                    </button>
                    <button type="button" class="btn btn-warning" id="btnGuardarCambios">
                        <i class="bi bi-check-circle me-1"></i>Guardar Cambios
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Resultado del Guardado (√âxito o Error) -->
    <div class="modal fade" id="modalResultadoGuardado" tabindex="-1" aria-labelledby="modalResultadoLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-body p-5 text-center">
                    <!-- Icono din√°mico -->
                    <div class="mb-4">
                        <i id="iconoResultado" class="bi bi-check-circle text-success" style="font-size: 4rem;"></i>
                    </div>
                    <!-- T√≠tulo din√°mico -->
                    <h5 id="tituloResultado" class="fw-bold mb-3 text-success" style="font-size: 1.5rem;">
                        ¬°Operaci√≥n Exitosa!
                    </h5>
                    <!-- Mensaje din√°mico -->
                    <p id="mensajeResultado" class="text-muted mb-0" style="font-size: 1rem;">
                        Los cambios se han guardado correctamente en la base de datos.
                    </p>
                </div>
                <div class="modal-footer bg-light border-top">
                    <button type="button" class="btn btn-success" id="btnOkResultado">
                        <i class="bi bi-check-circle me-1"></i>OK
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de √âxito en Actualizaci√≥n -->
    <div class="modal fade" id="modalExitoActualizacion" tabindex="-1" aria-labelledby="modalExitoLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-body p-4 text-center">
                    <div class="mb-3">
                        <i class="bi bi-check-circle text-success" style="font-size: 3rem;"></i>
                    </div>
                    <h5 class="modal-title fw-bold text-success mb-2" id="modalExitoLabel">¬°Operaci√≥n Exitosa!</h5>
                    <p class="text-muted mb-0">Los cambios se han guardado correctamente en la base de datos.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Resumen de Actualizaci√≥n -->
    <div class="modal fade" id="modalResumenActualizacion" tabindex="-1" aria-labelledby="modalResumenLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-header bg-success text-white border-0">
                    <h5 class="modal-title fw-bold" id="modalResumenLabel">
                        <i class="bi bi-info-circle me-2"></i>Datos Actualizados
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <div class="modal-body p-4">
                    <!-- Informaci√≥n del Material -->
                    <div class="mb-4">
                        <h6 class="text-success fw-bold mb-3">
                            <i class="bi bi-tag me-2"></i>Informaci√≥n del Material
                        </h6>
                        <div class="alert alert-light border-start border-4 border-success">
                            <p class="mb-1">
                                <strong>Nombre:</strong>
                                <span id="resumenNombreMaterial">-</span>
                            </p>
                            <p class="mb-0">
                                <strong>Ubicaci√≥n:</strong>
                                <span id="resumenNombrePunto">-</span>
                            </p>
                        </div>
                    </div>

                    <!-- Stock e Inventario -->
                    <div class="mb-4">
                        <h6 class="text-info fw-bold mb-3">
                            <i class="bi bi-boxes me-2"></i>Stock e Inventario
                        </h6>
                        <div class="row g-2">
                            <div class="col-md-6">
                                <div class="p-3 rounded-2 bg-info bg-opacity-10 border-start border-4 border-info">
                                    <small class="text-muted">Stock Actual</small>
                                    <p class="h6 fw-bold mb-0" id="resumenStockActual">-</p>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="p-3 rounded-2 bg-warning bg-opacity-10 border-start border-4 border-warning">
                                    <small class="text-muted">Capacidad M√°xima</small>
                                    <p class="h6 fw-bold mb-0" id="resumenCapacidadMaxima">-</p>
                                </div>
                            </div>
                        </div>
                        <div class="mt-2">
                            <div class="p-3 rounded-2 bg-secondary bg-opacity-10 border-start border-4 border-secondary">
                                <small class="text-muted">Unidad de Medida</small>
                                <p class="h6 fw-bold mb-0" id="resumenUnidadMedida">-</p>
                            </div>
                        </div>
                    </div>

                    <!-- Precios -->
                    <div class="mb-4">
                        <h6 class="text-danger fw-bold mb-3">
                            <i class="bi bi-currency-dollar me-2"></i>Precios
                        </h6>
                        <div class="row g-2">
                            <div class="col-md-6">
                                <div class="p-3 rounded-2 bg-danger bg-opacity-10 border-start border-4 border-danger">
                                    <small class="text-muted">Precio de Compra</small>
                                    <p class="h6 fw-bold mb-0" id="resumenPrecioCompra">-</p>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="p-3 rounded-2 bg-success bg-opacity-10 border-start border-4 border-success">
                                    <small class="text-muted">Precio de Venta</small>
                                    <p class="h6 fw-bold mb-0" id="resumenPrecioVenta">-</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Umbrales -->
                    <div>
                        <h6 class="text-warning fw-bold mb-3">
                            <i class="bi bi-exclamation-triangle me-2"></i>Umbrales de Alerta
                        </h6>
                        <div class="row g-2">
                            <div class="col-md-6">
                                <div class="p-3 rounded-2 bg-warning bg-opacity-10 border-start border-4 border-warning">
                                    <small class="text-muted">Umbral Alerta</small>
                                    <p class="h6 fw-bold mb-0" id="resumenUmbralAlerta">-</p>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="p-3 rounded-2 bg-danger bg-opacity-10 border-start border-4 border-danger">
                                    <small class="text-muted">Umbral Cr√≠tico</small>
                                    <p class="h6 fw-bold mb-0" id="resumenUmbralCritico">-</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="modal-footer bg-light border-top">
                    <button type="button" class="btn btn-success" data-bs-dismiss="modal" id="btnCerrarResumen">
                        <i class="bi bi-check-circle me-1"></i>Cerrar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- SCRIPT PARA MANEJO DE MODALES -->
    <script>
        // ====================================================================
        // FUNCI√ìN GLOBAL: Mostrar Modal de Resultado
        // ====================================================================
        function mostrarModalResultado(esExito, titulo, mensaje) {
            console.log('üîî Mostrando modal de resultado:', { esExito, titulo, mensaje });

            const modalEl = document.getElementById('modalResultadoGuardado');
            if (!modalEl) {
                console.error('‚ùå Modal de resultado no encontrado');
                alert(titulo + '\n' + mensaje);
                return;
            }

            // Actualizar contenido
            const icono = document.getElementById('iconoResultado');
            const tituloEl = document.getElementById('tituloResultado');
            const mensajeEl = document.getElementById('mensajeResultado');

            if (icono) {
                if (esExito) {
                    icono.className = 'bi bi-check-circle text-success';
                } else {
                    icono.className = 'bi bi-exclamation-circle text-danger';
                }
                icono.style.fontSize = '4rem';
            }

            if (tituloEl) {
                tituloEl.textContent = titulo;
                tituloEl.style.fontSize = '1.5rem';
                tituloEl.className = esExito ? 'fw-bold mb-3 text-success' : 'fw-bold mb-3 text-danger';
            }

            if (mensajeEl) {
                mensajeEl.textContent = mensaje;
            }

            // Configurar bot√≥n OK
            const btnOkResultado = document.getElementById('btnOkResultado');
            if (btnOkResultado) {
                // Limpiar eventos previos
                btnOkResultado.onclick = null;
                btnOkResultado.onclick = function() {
                    console.log('‚úì Bot√≥n OK presionado. Recargando p√°gina...');
                    // Cerrar modal usando Bootstrap
                    const bsModal = bootstrap.Modal.getInstance(modalEl);
                    if (bsModal) {
                        bsModal.hide();
                    } else {
                        modalEl.classList.remove('show');
                        const backdrop = document.querySelector('.modal-backdrop');
                        if (backdrop) backdrop.remove();
                    }
                    // Recargar p√°gina
                    setTimeout(() => {
                        window.location.reload(true);
                    }, 300);
                };
            }

            // Mostrar modal
            try {
                const modal = new bootstrap.Modal(modalEl, {
                    backdrop: 'static',
                    keyboard: false
                });
                console.log('‚úì Modal creado, mostrando...');
                modal.show();
                console.log('‚úì Modal mostrado exitosamente');
            } catch (err) {
                console.error('‚ùå Error mostrando modal:', err);
                alert(titulo + '\n' + mensaje);
            }
        }

        // ====================================================================
        // IIFE: Sistema de Modales
        // ====================================================================
        (function() {
            let detallesModalInstance = null;
            let editarModalInstance = null;
            let isInitialized = false;

            function inicializarModales() {
                // Esperar a que bootstrap est√© disponible
                if (typeof bootstrap === 'undefined') {
                    console.warn('‚ö† Bootstrap no est√° disponible a√∫n, reintentando...');
                    setTimeout(inicializarModales, 100);
                    return;
                }

                const detallesModalEl = document.getElementById('detallesModal');
                const editarModalEl = document.getElementById('editarModal');

                if (detallesModalEl) {
                    detallesModalInstance = new bootstrap.Modal(detallesModalEl, { backdrop: 'static' });
                    console.log('‚úì Modal de detalles inicializado');
                }
                if (editarModalEl) {
                    editarModalInstance = new bootstrap.Modal(editarModalEl, { backdrop: 'static' });
                    console.log('‚úì Modal de editar inicializado');
                }
            }

            function configurarEventListeners() {
                // Usar delegaci√≥n de eventos a nivel de documento para mayor robustez
                document.removeEventListener('click', manejarClickGlobal);
                document.addEventListener('click', manejarClickGlobal);
                console.log('‚úì Event listeners configurados globalmente');
            }

            function manejarClickGlobal(e) {
                const btn = e.target.closest('.detallesBtn');
                if (!btn) return;

                console.log('‚úì Clic en bot√≥n de detalles detectado');
                manejarClickTarjeta(btn);
            }

            function manejarClickTarjeta(btn) {
                const nombre = btn.dataset.nombreMaterial || '-';
                const materialId = btn.dataset.materialId || '';
                const stock = parseFloat(btn.dataset.stockActual || 0) || 0;
                const capacidad = parseFloat(btn.dataset.capacidadMaxima || 0) || 0;
                const precioCompra = btn.dataset.precioCompra || '0';
                const precioVenta = btn.dataset.precioVenta || '0';
                const umbralAlerta = parseInt(btn.dataset.umbralAlerta || 0) || 0;
                const umbralCritico = parseInt(btn.dataset.umbralCritico || 0) || 0;
                const unidad = btn.dataset.unidadMedida || '';
                const inventarioId = btn.dataset.inventarioId || '';

                console.log('Material:', { nombre, stock, capacidad, inventarioId });

                // Rellenar campos del modal detalles
                const setText = (id, text) => {
                    const el = document.getElementById(id);
                    if (el) {
                        el.textContent = text;
                    }
                };

                setText('modalHeaderNombre', 'Detalles del Material');
                setText('modalNombreMaterial', nombre);
                setText('modalMaterialId', materialId);
                setText('modalUnidadMedida', unidad || '-');
                setText('modalStockActual', Number(stock).toFixed(2));
                setText('modalStockUnidad', unidad || 'unidades');
                setText('modalCapacidadMaxima', Number(capacidad).toFixed(2));
                setText('modalCapacidadUnidad', unidad || 'unidades');
                const espacioUsado = (capacidad > 0) ? (stock).toFixed(2) : '0.00';
                const espacioDisp = (capacidad > 0) ? (Math.max(capacidad - stock, 0)).toFixed(2) : '0.00';
                setText('modalEspacioUsado', espacioUsado);
                setText('modalEspacioDisponible', espacioDisp);
                setText('modalPrecioCompra', '$ ' + Number(precioCompra).toFixed(2));
                setText('modalPrecioVenta', '$ ' + Number(precioVenta).toFixed(2));
                const margen = (Number(precioVenta) - Number(precioCompra)) || 0;
                setText('modalMargenGanancia', '$ ' + margen.toFixed(2));
                const pctMargen = (Number(precioCompra) > 0) ? Math.round((margen / Number(precioCompra)) * 100) + '%' : '0%';
                setText('modalPorcentajeMargen', pctMargen);
                const valorTotal = (Number(stock) * Number(precioCompra)) || 0;
                setText('modalValorTotal', '$ ' + Number(valorTotal).toFixed(2));
                setText('modalUmbralAlerta', umbralAlerta + '%');
                setText('modalUmbralCritico', umbralCritico + '%');

                // Ocupaci√≥n
                const porcentaje = ponerEstadoOcupacion(stock, capacidad);
                setText('modalOcupacionPorcentaje', porcentaje + '%');
                const barra = document.getElementById('modalOcupacionBar');
                const textoBar = document.getElementById('modalOcupacionText');
                if (barra && textoBar) {
                    const estado = aplicarColorBarra(barra, porcentaje, umbralAlerta, umbralCritico);
                    textoBar.textContent = porcentaje + '%';
                    const estadoTextEl = document.getElementById('modalEstadoText');
                    const estadoIconEl = document.getElementById('modalEstadoIcon');
                    if (estadoTextEl) estadoTextEl.textContent = estado;
                    if (estadoIconEl) {
                        estadoIconEl.className = 'bi bi-circle-fill me-1';
                        if (estado === 'Cr√≠tico') estadoIconEl.classList.add('text-danger');
                        else if (estado === 'Alerta') estadoIconEl.classList.add('text-warning');
                        else estadoIconEl.classList.add('text-success');
                    }
                }

                // Guardar id en botones del modal
                const btnEditar = document.getElementById('btnEditarMaterial');
                const btnBorrar = document.getElementById('btnBorrarMaterial');
                if (btnEditar) {
                    btnEditar.dataset.inventarioId = inventarioId;
                    btnEditar.dataset.materialId = materialId;
                    btnEditar.dataset.stock = stock;
                    btnEditar.dataset.capacidad = capacidad;
                    btnEditar.dataset.unidad = unidad;
                    btnEditar.dataset.precioCompra = precioCompra;
                    btnEditar.dataset.precioVenta = precioVenta;
                    btnEditar.dataset.umbralAlerta = umbralAlerta;
                    btnEditar.dataset.umbralCritico = umbralCritico;
                }
                if (btnBorrar) {
                    btnBorrar.dataset.inventarioId = inventarioId;
                    btnBorrar.dataset.nombreMaterial = nombre;
                    btnBorrar.dataset.puntoEcaId = document.querySelector('section[data-punto-eca-id]')?.dataset.puntoEcaId || '';
                }

                // Mostrar modal detalles
                if (detallesModalInstance) {
                    console.log('‚úì Abriendo modal de detalles');
                    detallesModalInstance.show();
                } else {
                    console.error('‚úó detallesModalInstance no est√° inicializado');
                }
            }

            function ponerEstadoOcupacion(stock, capacidad) {
                const pct = (capacidad && capacidad > 0) ? Math.round((stock / capacidad) * 100) : 0;
                return Math.min(Math.max(pct, 0), 100);
            }

            function aplicarColorBarra(barEl, porcentaje, umbralAlerta, umbralCritico) {
                barEl.style.width = porcentaje + '%';
                barEl.className = 'progress-bar d-flex align-items-center justify-content-center fw-bold text-white fs-6';
                if (porcentaje >= (umbralCritico || 100)) {
                    barEl.classList.add('bg-danger');
                    return 'Cr√≠tico';
                }
                if (porcentaje >= (umbralAlerta || 50)) {
                    barEl.classList.add('bg-warning');
                    return 'Alerta';
                }
                barEl.classList.add('bg-success');
                return 'OK';
            }

            // Abrir modal editar y rellenar campos
            function configurarBtnEditar() {
                const btnEditarModal = document.getElementById('btnEditarMaterial');
                if (btnEditarModal) {
                    btnEditarModal.removeEventListener('click', abrirModalEditar);
                    btnEditarModal.addEventListener('click', abrirModalEditar);
                }
            }

            function abrirModalEditar() {
                const inventarioId = this.dataset.inventarioid || this.dataset.inventarioId || '';
                const materialId = this.dataset.materialid || this.dataset.materialId || '';
                const stock = this.dataset.stock || '';
                const capacidad = this.dataset.capacidad || '';
                const unidad = this.dataset.unidad || '';
                const precioCompra = this.dataset.preciocompra || this.dataset.precioCompra || '0';
                const precioVenta = this.dataset.precioventa || this.dataset.precioVenta || '0';
                const umbralAlerta = this.dataset.umbralalerta || this.dataset.umbralAlerta || '0';
                const umbralCritico = this.dataset.umbralcritico || this.dataset.umbralCritico || '0';

                console.log('Abriendo modal editar con inventarioId:', inventarioId);

                const inputHidden = document.getElementById('editarMaterialId');
                if (inputHidden) inputHidden.value = inventarioId || materialId || '';

                const inputStock = document.getElementById('editarStockActual');
                if (inputStock) inputStock.value = stock;

                const inputCapacidad = document.getElementById('editarCapacidadMaxima');
                if (inputCapacidad) inputCapacidad.value = capacidad;

                const selectUnidad = document.getElementById('editarUnidadMedida');
                if (selectUnidad && unidad) {
                    const opt = Array.from(selectUnidad.options).find(o => o.value === unidad || o.text === unidad);
                    if (opt) selectUnidad.value = opt.value;
                }

                const inputPrecioCompra = document.getElementById('editarPrecioCompra');
                if (inputPrecioCompra) inputPrecioCompra.value = precioCompra;

                const inputPrecioVenta = document.getElementById('editarPrecioVenta');
                if (inputPrecioVenta) inputPrecioVenta.value = precioVenta;

                const inputUmbralAlerta = document.getElementById('editarUmbralAlerta');
                if (inputUmbralAlerta) inputUmbralAlerta.value = umbralAlerta;

                const inputUmbralCritico = document.getElementById('editarUmbralCritico');
                if (inputUmbralCritico) inputUmbralCritico.value = umbralCritico;

                if (detallesModalInstance) detallesModalInstance.hide();
                if (editarModalInstance) {
                    console.log('‚úì Abriendo modal de editar');
                    editarModalInstance.show();
                }
            }

            // Configurar bot√≥n de guardar cambios
            function configurarBtnGuardar() {
                const btnGuardarModal = document.getElementById('btnGuardarCambios');
                if (btnGuardarModal) {
                    btnGuardarModal.removeEventListener('click', manejarClickGuardar);
                    btnGuardarModal.addEventListener('click', manejarClickGuardar);
                }
            }

            function manejarClickGuardar(e) {
                e.preventDefault();
                guardarCambios(this);
            }

            function guardarCambios(btnGuardar) {
                if (!btnGuardar) {
                    btnGuardar = document.getElementById('btnGuardarCambios');
                }

                const inventarioId = document.getElementById('editarMaterialId').value;
                const stockActual = parseFloat(document.getElementById('editarStockActual').value) || 0;
                const capacidadMaxima = parseFloat(document.getElementById('editarCapacidadMaxima').value) || 0;
                const unidadMedida = document.getElementById('editarUnidadMedida').value;
                const precioCompra = parseFloat(document.getElementById('editarPrecioCompra').value) || 0;
                const precioVenta = parseFloat(document.getElementById('editarPrecioVenta').value) || 0;
                const umbralAlerta = parseInt(document.getElementById('editarUmbralAlerta').value) || 0;
                const umbralCritico = parseInt(document.getElementById('editarUmbralCritico').value) || 0;

                // ‚úÖ Obtener datos del usuario correctamente
                const section = document.querySelector('section[data-gestor]');
                let gestor = section?.getAttribute('data-gestor') || '';
                let usuarioId = section?.getAttribute('data-usuario-id') || '';

                console.log('üíæ Guardando cambios de inventario:', { inventarioId, stockActual, capacidadMaxima, unidadMedida, precioCompra, precioVenta, umbralAlerta, umbralCritico });
                console.log('üìç Datos de usuario:', { gestor, usuarioId });

                if (!inventarioId) {
                    mostrarModalResultado(false, 'Error', 'No se encontr√≥ el ID del inventario');
                    return;
                }

                if (!gestor || !usuarioId) {
                    console.error('‚ùå Datos de usuario no encontrados. Verificar atributos data-*');
                    mostrarModalResultado(false, 'Error', 'No se encontraron los datos de usuario. Por favor recarga la p√°gina.');
                    return;
                }

                if (!stockActual || !capacidadMaxima || !unidadMedida || !precioCompra || !precioVenta) {
                    mostrarModalResultado(false, 'Error', 'Por favor completa todos los campos requeridos');
                    return;
                }

                const datosActualizacion = {
                    stockActual: stockActual,
                    capacidadMaxima: capacidadMaxima,
                    unidadMedida: unidadMedida,
                    precioCompra: precioCompra,
                    precioVenta: precioVenta,
                    umbralAlerta: umbralAlerta,
                    umbralCritico: umbralCritico
                };

                // ‚úÖ Usar la referencia al bot√≥n
                const textoOriginal = btnGuardar?.innerHTML || 'Guardar Cambios';
                if (btnGuardar) {
                    btnGuardar.disabled = true;
                    btnGuardar.innerHTML = '<i class="bi bi-hourglass-split me-1"></i>Guardando...';
                }

                // ‚úÖ Construir URL correcta: /punto-eca/{nombrePunto}/{usuarioId}/actualizar-inventario/{inventarioId}
                const url = `/punto-eca/${gestor}/${usuarioId}/actualizar-inventario/${inventarioId}`;
                console.log('üîó URL de actualizaci√≥n:', url);

                fetch(url, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(datosActualizacion)
                })
                    .then(res => res.json().then(data => ({ status: res.status, ok: res.ok, data })))
                    .then(({ status, ok, data }) => {
                        console.log('üì¶ Respuesta del servidor:', { status, ok, data });

                        // Cerrar modales previos
                        if (editarModalInstance) editarModalInstance.hide();

                        if (!ok) {
                            // Mostrar error
                            const mensajeError = data?.mensaje || data?.message || 'Hubo un error al guardar los cambios';
                            console.error('‚ùå Error en respuesta:', mensajeError);
                            mostrarModalResultado(false, 'Error al guardar', mensajeError);
                            if (btnGuardar) {
                                btnGuardar.disabled = false;
                                btnGuardar.innerHTML = textoOriginal;
                            }
                        } else {
                            console.log('‚úÖ Actualizaci√≥n exitosa:', data);
                            // Mostrar √©xito
                            mostrarModalResultado(true, '¬°Operaci√≥n Exitosa!', 'Los cambios se han guardado correctamente en la base de datos.');
                            if (btnGuardar) {
                                btnGuardar.disabled = false;
                                btnGuardar.innerHTML = textoOriginal;
                            }
                        }
                    })
                    .catch(err => {
                        console.error('‚ùå Error en fetch:', err);
                        if (editarModalInstance) editarModalInstance.hide();
                        mostrarModalResultado(false, 'Error', 'Error al guardar cambios: ' + err.message);
                        if (btnGuardar) {
                            btnGuardar.disabled = false;
                            btnGuardar.innerHTML = textoOriginal;
                        }
                    });
            }

            // Funci√≥n para mostrar el modal de resultado
            // YA DEFINIDA GLOBALMENTE ARRIBA

            // Borrar: confirmaci√≥n simple
            function configurarBtnBorrar() {
                const btnBorrarModal = document.getElementById('btnBorrarMaterial');
                if (btnBorrarModal) {
                    btnBorrarModal.removeEventListener('click', manejarClickBorrar);
                    btnBorrarModal.addEventListener('click', manejarClickBorrar);
                }
            }

            function manejarClickBorrar(e) {
                e.preventDefault();
                confirmarBorrado(this);
            }

            function confirmarBorrado(btnBorrar) {
                if (!btnBorrar) {
                    btnBorrar = document.getElementById('btnBorrarMaterial');
                }

                const inventarioId = btnBorrar?.dataset.inventarioid || btnBorrar?.dataset.inventarioId || '';
                const nombreMaterial = btnBorrar?.dataset.nombreMaterial || 'el material';
                const puntoEcaId = btnBorrar?.dataset.puntoEcaId || '';

                // ‚úÖ Obtener datos del usuario correctamente
                const section = document.querySelector('section[data-gestor]');
                let gestor = section?.getAttribute('data-gestor') || '';
                let usuarioId = section?.getAttribute('data-usuario-id') || '';

                console.log('üóëÔ∏è Preparando eliminaci√≥n:', { inventarioId, nombreMaterial, gestor, usuarioId, puntoEcaId });

                if (!gestor || !usuarioId || !puntoEcaId) {
                    console.error('‚ùå Datos no encontrados', { gestor, usuarioId, puntoEcaId });
                    alert('Error: No se encontraron los datos necesarios. Por favor recarga la p√°gina.');
                    return;
                }

                if (!inventarioId) {
                    if (!confirm('¬øDeseas borrar este material del inventario?')) return;
                } else {
                    if (!confirm('¬øConfirma eliminar "' + nombreMaterial + '" del inventario?')) return;
                }

                // ‚úÖ Construir URL correcta: /punto-eca/{nombrePunto}/{usuarioId}/eliminar-inventario/{inventarioId}
                const url = `/punto-eca/${gestor}/${usuarioId}/eliminar-inventario/${inventarioId}`;
                console.log('üóëÔ∏è URL de eliminaci√≥n:', url);

                // ‚úÖ Preparar payload con puntoId
                const payload = {
                    puntoId: puntoEcaId
                };
                console.log('üì§ Body a enviar:', payload);

                fetch(url, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                })
                    .then(res => {
                        console.log('üì¶ Respuesta del DELETE:', { status: res.status, ok: res.ok });
                        if (res.ok) {
                            return res.json();
                        } else {
                            return res.json().then(j => { throw new Error(j?.mensaje || j?.message || 'Error al borrar'); });
                        }
                    })
                    .then(data => {
                        console.log('‚úÖ Eliminaci√≥n exitosa:', data);
                        mostrarModalResultado(true, '¬°Eliminado!', 'El material ha sido eliminado del inventario correctamente.');
                        if (detallesModalInstance) detallesModalInstance.hide();
                        // Recargar despu√©s de cerrar modal
                        setTimeout(() => {
                            window.location.reload();
                        }, 1500);
                    })
                    .catch(err => {
                        console.error('‚ùå Error borrando:', err);
                        mostrarModalResultado(false, 'Error al eliminar', 'No fue posible borrar: ' + (err.message || err));
                    });
            }

            function inicializar() {
                if (isInitialized) return;
                console.log('üìå Inicializando sistema de modales de materiales');
                inicializarModales();
                configurarEventListeners();
                configurarBtnEditar();
                configurarBtnGuardar();
                configurarBtnBorrar();
                isInitialized = true;
            }

            // Inicializar cuando el DOM est√° listo
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', inicializar);
            } else {
                inicializar();
            }

            // Re-inicializar si el contenedor cambia (para actualizaciones din√°micas)
            window.addEventListener('reinicializarModales', inicializar);

            console.log('‚úì Script de modales cargado');
        })();
    </script>

    <!-- ============================================================ -->
    <!-- SELECT2 ASSETS (jQuery + Select2 CSS/JS) -->
    <!-- ============================================================ -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/@ttskch/select2-bootstrap4-theme@1.5.2/dist/select2-bootstrap4.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <!-- ============================================================ -->
    <!-- SELECT2 INICIALIZACI√ìN CON FORMATSTATE PERSONALIZADO -->
    <!-- ============================================================ -->
    <script>
    (function() {
        console.log('üìå Inicializando Select2 - Acorde√≥n Agregar Material...');

        // Esperar a que jQuery y Select2 est√©n listos
        function inicializarSelect2() {
            if (typeof $ === 'undefined' || typeof $.fn.select2 === 'undefined') {
                console.warn('‚ö†Ô∏è Select2 o jQuery no disponibles, reintentando...');
                setTimeout(inicializarSelect2, 100);
                return;
            }

            console.log('‚úì jQuery y Select2 est√°n disponibles');

            // ========================================================
            // FUNCI√ìN PARA FORMATEAR EL ESTADO (Selecci√≥n)
            // ========================================================
            function formatState(state) {
                if (!state.id) {
                    return state.text;
                }

                // Extraer datos del objeto
                var imagenUrl = state.element?.getAttribute('data-imagen') || '/imagenes/materiales.png';
                var nmbTipo = state.element?.getAttribute('data-tipo') || '';
                var nmbCategoria = state.element?.getAttribute('data-categoria') || '';

                // Construir elemento HTML con imagen
                var $state = $(
                    '<span class="select2-state"><img class="img-material-select2" style="width: 24px; height: 24px; margin-right: 8px; border-radius: 4px; object-fit: cover;" /> ' +
                    '<span class="state-text"></span>' +
                    '<small class="state-meta" style="margin-left: 4px; color: #999; font-size: 0.85em;"></small></span>'
                );

                // Usar .text() para evitar inyecciones
                $state.find(".state-text").text(state.text);
                $state.find("img").attr("src", imagenUrl);

                // Agregar badges de tipo y categor√≠a si est√°n disponibles
                if (nmbTipo || nmbCategoria) {
                    var metaText = [];
                    if (nmbTipo) metaText.push(nmbTipo);
                    if (nmbCategoria) metaText.push(nmbCategoria);
                    $state.find(".state-meta").text('(' + metaText.join(' ‚Ä¢ ') + ')');
                }

                return $state;
            }

            // ========================================================
            // INICIALIZAR SELECT2 EN BUSCAR MATERIAL (ACORDE√ìN AGREGAR)
            // ========================================================
            var $buscarMaterial = $('#buscarMaterialSelect');
            if ($buscarMaterial.length) {
                console.log('‚úì Encontrado #buscarMaterialSelect');

                // Obtener endpoint y puntoId
                var endpoint = '/punto-eca/catalogo/materiales/buscar';
                var puntoId = document.getElementById('agregarPuntoId')?.value || '';

                console.log('üîó Endpoint:', endpoint);
                console.log('üìç PuntoId:', puntoId);

                $buscarMaterial.select2({
                    theme: 'bootstrap4',
                    width: '100%',
                    placeholder: 'Selecciona un material para continuar...',
                    minimumInputLength: 0,  // ‚úÖ Mostrar materiales al abrir
                    allowClear: true,
                        ajax: {
                            url: endpoint,
                            dataType: 'json',
                            delay: 300,
                            data: function(params) {
                                var searchTerm = params.term || '';

                                // Obtener categor√≠a y tipo desde los Select2 (no radio buttons)
                                var categoria = $('#selectCategoriaBusqueda').val() || '';
                                var tipo = $('#selectTipoBusqueda').val() || '';

                                console.log('Buscando:', searchTerm || 'SIN FILTRO - TRAER TODOS');
                                console.log('Categoria:', categoria || 'Sin filtro');
                                console.log('Tipo:', tipo || 'Sin filtro');

                                // Enviar par√°metros tal como est√°n (incluso vac√≠os)
                                var requestData = {
                                    texto: searchTerm,      // Puede estar vac√≠o
                                    puntoId: puntoId
                                };

                                // Solo agregar categoria si est√° seleccionada
                                if (categoria) {
                                    requestData.categoria = categoria;
                                }

                                // Solo agregar tipo si est√° seleccionado
                                if (tipo) {
                                    requestData.tipo = tipo;
                                }

                                console.log('Enviando al backend:', requestData);

                                return requestData;
                            },
                            processResults: function(data, params) {
                                console.log('Respuesta AJAX recibida:', data);

                                // Si la respuesta es un error, mostrar el mensaje
                                if (data.error) {
                                    console.error('Error del backend:', data.mensaje);
                                    return { results: [] };
                                }

                                if (!Array.isArray(data)) {
                                    console.warn('La respuesta no es un array, conviriendo...');
                                    data = [];
                                }

                                console.log('Total de resultados:', data.length);

                                var results = data.map(function(m) {
                                    console.log('Procesando material:', m.nmbMaterial);
                                    return {
                                        id: m.materialId || m.id || '',
                                        text: m.nmbMaterial || m.nombre || 'Material sin nombre',
                                        // Guardar atributos extra en el elemento para acceso en formatState
                                        element: $('<option>')
                                            .attr('data-imagen', m.imagenUrl || '/imagenes/materiales.png')
                                            .attr('data-tipo', m.nmbTipo || '')
                                            .attr('data-categoria', m.nmbCategoria || '')[0],
                                        dto: m
                                    };
                                });

                                return {
                                    results: results
                                };
                            },
                            error: function(xhr, status, error) {
                                console.error('Error AJAX:', error);
                                console.error('Status:', status);
                                console.error('Response:', xhr.responseText);
                            },
                            cache: false  // Desabilitar cache para debugging
                        },
                    // Aplicar formatState a la selecci√≥n y resultados
                    templateSelection: formatState,
                    templateResult: formatState
                });

                // Evento al abrir dropdown - Disparar b√∫squeda autom√°tica
                $buscarMaterial.on('select2:opening', function(e) {
                    console.log('Abriendo dropdown de materiales...');

                    // Esperar a que Select2 renderice el campo de b√∫squeda
                    setTimeout(function() {
                        var searchInput = $('.select2-search__field');
                        if (searchInput && searchInput.length > 0) {
                            console.log('Campo de b√∫squeda encontrado');
                            console.log('Disparando b√∫squeda autom√°tica...');
                            searchInput.trigger('input');
                        } else {
                            console.warn('Campo de b√∫squeda no encontrado');
                        }
                    }, 100);
                });

                // Evento al seleccionar material
                $buscarMaterial.on('select2:select', function(e) {
                    var data = e.params.data;
                    console.log('Material seleccionado:', data);

                    if (data && data.id) {
                        var dto = data.dto || {};
                        document.getElementById('agregarMaterialId').value = data.id;
                        document.getElementById('agregarMaterialNombre').value = data.text;

                        // Limpiar campos num√©ricos del formulario
                        ['stockInicial', 'capacidadMaxima', 'precioCompra', 'precioVenta', 'umbralAlerta', 'umbralCritico'].forEach(function(id) {
                            var el = document.getElementById(id);
                            if (el) el.value = '';
                        });

                        // Si trae unidad, ponerla en el select
                        if (dto.unidad) {
                            console.log('Preseleccionando unidad:', dto.unidad);
                            $('#unidadMedida').val(dto.unidad).trigger('change');
                        }

                        // Abrir modal de agregar
                        var modalAgregar = document.getElementById('agregarInventarioModal');
                        if (modalAgregar) {
                            console.log('Abriendo modal de agregar inventario...');
                            var modal = new bootstrap.Modal(modalAgregar);
                            modal.show();
                        }
                    }
                });

                console.log('Select2 inicializado en #buscarMaterialSelect');

                // ========================================================
                // INICIALIZAR SELECT2 EN CATEGOR√çA
                // ========================================================
                var $selectCategoria = $('#selectCategoriaBusqueda');
                if ($selectCategoria.length) {
                    console.log('‚úì Encontrado #selectCategoriaBusqueda');

                    $selectCategoria.select2({
                        theme: 'bootstrap4',
                        width: '100%',
                        allowClear: true,
                        placeholder: 'Selecciona una categor√≠a...',
                        minimumInputLength: 0
                    });

                    // Al cambiar categor√≠a, abre modal con b√∫squeda
                    $selectCategoria.on('select2:select', function(e) {
                        var categoria = e.params.data.id;
                        console.log('Categoria seleccionada:', categoria);

                        // Disparar b√∫squeda autom√°tica con la categor√≠a
                        dispararBusquedaYAbrirModal({
                            texto: '',
                            categoria: categoria,
                            tipo: $('#selectTipoBusqueda').val() || ''
                        });
                    });

                    // Al limpiar categor√≠a
                    $selectCategoria.on('select2:unselect', function(e) {
                        console.log('Categoria limpiada');
                    });

                    console.log('‚úì Select2 inicializado en #selectCategoriaBusqueda');
                }

                // ========================================================
                // INICIALIZAR SELECT2 EN TIPO
                // ========================================================
                var $selectTipo = $('#selectTipoBusqueda');
                if ($selectTipo.length) {
                    console.log('‚úì Encontrado #selectTipoBusqueda');

                    $selectTipo.select2({
                        theme: 'bootstrap4',
                        width: '100%',
                        allowClear: true,
                        placeholder: 'Selecciona un tipo...',
                        minimumInputLength: 0
                    });

                    // Al cambiar tipo, abre modal con b√∫squeda
                    $selectTipo.on('select2:select', function(e) {
                        var tipo = e.params.data.id;
                        console.log('Tipo seleccionado:', tipo);

                        // Disparar b√∫squeda autom√°tica con el tipo
                        dispararBusquedaYAbrirModal({
                            texto: '',
                            categoria: $('#selectCategoriaBusqueda').val() || '',
                            tipo: tipo
                        });
                    });

                    // Al limpiar tipo
                    $selectTipo.on('select2:unselect', function(e) {
                        console.log('Tipo limpiado');
                    });

                    console.log('‚úì Select2 inicializado en #selectTipoBusqueda');
                }

                // ========================================================
                // FUNCI√ìN AUXILIAR: Disparar b√∫squeda y abrir modal
                // ========================================================
                function dispararBusquedaYAbrirModal(filtros) {
                    console.log('Disparando b√∫squeda con filtros:', filtros);

                    var modalBuscarMaterial = document.getElementById('buscarMaterialModal');
                    if (!modalBuscarMaterial) {
                        console.error('Modal de b√∫squeda no encontrado');
                        return;
                    }

                    // Mostrar estado loading
                    var estadoBusquedaEl = document.getElementById('estadoBusquedaMateriales');
                    estadoBusquedaEl.innerHTML = '<div class="d-flex flex-column align-items-center"><div class="spinner-border text-success mb-3" role="status"></div><p class="mb-0">Buscando materiales...</p></div>';

                    // Limpiar resultados
                    var listaResultadosEl = document.getElementById('resultadosBusqueda');
                    listaResultadosEl.innerHTML = '';

                    // Abrir modal
                    var modal = new bootstrap.Modal(modalBuscarMaterial);
                    modal.show();

                    // Ejecutar b√∫squeda AJAX
                    var endpoint = '/punto-eca/catalogo/materiales/buscar';
                    var puntoId = document.getElementById('agregarPuntoId')?.value || '';

                    var params = new URLSearchParams();
                    if (filtros.texto) params.append('texto', filtros.texto);
                    if (filtros.categoria) params.append('categoria', filtros.categoria);
                    if (filtros.tipo) params.append('tipo', filtros.tipo);
                    if (puntoId) params.append('puntoId', puntoId);

                    var url = endpoint + (params.toString() ? ('?' + params.toString()) : '');
                    console.log('Buscando en:', url);

                    fetch(url, { method: 'GET', headers: { 'Accept': 'application/json' } })
                        .then(res => res.json().then(data => ({ status: res.status, ok: res.ok, data: data })))
                        .then(({ status, ok, data }) => {
                            console.log('Respuesta recibida:', data);

                            if (!ok) {
                                var mensajeError = data?.mensaje || data?.message || 'Error desconocido';
                                console.error('Error:', mensajeError);
                                estadoBusquedaEl.innerHTML = '<div class="alert alert-warning mb-0" role="alert"><i class="bi bi-exclamation-triangle me-2"></i>' + mensajeError + '</div>';
                                return;
                            }

                            if (!Array.isArray(data)) data = [];

                            console.log('Total de resultados:', data.length);

                            // Renderizar resultados
                            renderResultadosBusquedaModal(data);
                        })
                        .catch(err => {
                            console.error('Error en b√∫squeda:', err);
                            estadoBusquedaEl.innerHTML = '<div class="alert alert-danger mb-0" role="alert"><i class="bi bi-exclamation-octagon me-2"></i>Error de conexi√≥n</div>';
                        });
                }

                // ========================================================
                // FUNCI√ìN AUXILIAR: Renderizar resultados en modal
                // ========================================================
                function renderResultadosBusquedaModal(materiales) {
                    console.log('üé® Renderizando', materiales.length, 'resultados');

                    var listaResultadosEl = document.getElementById('resultadosBusqueda');
                    var estadoBusquedaEl = document.getElementById('estadoBusquedaMateriales');

                    listaResultadosEl.innerHTML = '';

                    if (!materiales || materiales.length === 0) {
                        listaResultadosEl.innerHTML = '<div class="list-group-item text-muted text-center py-4">Sin resultados disponibles</div>';
                        estadoBusquedaEl.innerHTML = '<i class="bi bi-search display-6 d-block mb-2"></i><p class="mb-0">No se encontraron materiales con estos filtros</p>';
                        return;
                    }

                    materiales.forEach(material => {
                        var item = document.createElement('button');
                        item.type = 'button';
                        item.className = 'list-group-item list-group-item-action resultado-material-item d-flex align-items-start gap-3';
                        item.dataset.materialId = material.materialId || '';
                        item.dataset.nombre = material.nmbMaterial || '';
                        item.dataset.descripcion = material.dscMaterial || '';
                        item.dataset.tipo = material.nmbTipo || '';
                        item.dataset.categoria = material.nmbCategoria || '';
                        item.dataset.unidad = material.unidad || '';

                        var img = document.createElement('img');
                        img.src = material.imagenUrl || '/imagenes/materiales.png';
                        img.alt = material.nmbMaterial || 'Material';
                        img.className = 'rounded';
                        img.style.width = '64px';
                        img.style.height = '64px';
                        img.style.objectFit = 'cover';
                        img.style.flexShrink = '0';

                        var content = document.createElement('div');
                        content.className = 'flex-grow-1 text-start';

                        var title = document.createElement('div');
                        title.className = 'fw-semibold';
                        title.textContent = material.nmbMaterial || 'Material sin nombre';

                        var desc = document.createElement('small');
                        desc.className = 'text-muted d-block mb-2';
                        desc.textContent = material.dscMaterial || 'Sin descripci√≥n';

                        var badges = document.createElement('div');
                        var tipoBadge = document.createElement('span');
                        tipoBadge.className = 'badge bg-primary me-1';
                        tipoBadge.textContent = material.nmbTipo || 'Tipo';
                        var catBadge = document.createElement('span');
                        catBadge.className = 'badge bg-secondary';
                        catBadge.textContent = material.nmbCategoria || 'Categor√≠a';

                        badges.appendChild(tipoBadge);
                        badges.appendChild(catBadge);

                        content.appendChild(title);
                        content.appendChild(desc);
                        content.appendChild(badges);

                        var actionBadge = document.createElement('span');
                        actionBadge.className = 'badge bg-success rounded-pill align-self-start';
                        actionBadge.textContent = 'Seleccionar';

                        item.appendChild(img);
                        item.appendChild(content);
                        item.appendChild(actionBadge);

                        listaResultadosEl.appendChild(item);
                    });

                    estadoBusquedaEl.innerHTML = '<i class="bi bi-check-circle text-success display-6 d-block mb-2"></i><p class="mb-0">Selecciona un material para continuar</p>';

                    // Agregar manejadores de clic a cada material
                    document.querySelectorAll('.resultado-material-item').forEach(item => {
                        item.addEventListener('click', function(e) {
                            e.preventDefault();

                            var materialId = this.dataset.materialId;
                            var materialNombre = this.dataset.nombre;

                            console.log('üì¶ Material seleccionado:', materialId, '-', materialNombre);

                            // Llenar los campos del formulario
                            document.getElementById('agregarMaterialId').value = materialId;
                            document.getElementById('agregarMaterialNombre').value = materialNombre;

                            // Limpiar campos de entrada
                            document.getElementById('stockInicial').value = '';
                            document.getElementById('capacidadMaxima').value = '';
                            document.getElementById('precioCompra').value = '';
                            document.getElementById('precioVenta').value = '';
                            document.getElementById('umbralAlerta').value = '';
                            document.getElementById('umbralCritico').value = '';
                            document.getElementById('unidadMedida').value = '';

                            // Cerrar modal de b√∫squeda
                            var modalBusquedaInstance = bootstrap.Modal.getInstance(document.getElementById('buscarMaterialModal'));
                            if (modalBusquedaInstance) {
                                modalBusquedaInstance.hide();
                            }

                            // Abrir modal de agregar inventario
                            var modalAgregar = document.getElementById('agregarInventarioModal');
                            if (modalAgregar) {
                                var modal = new bootstrap.Modal(modalAgregar);
                                modal.show();
                                console.log('‚úì Modal de agregar inventario abierto');
                            }
                        });
                    });
                }

            } else {
                console.error('‚ùå No se encontr√≥ #buscarMaterialSelect');
            }

            // ========================================================
            // INICIALIZAR SELECT2 EN UNIDAD MEDIDA DEL MODAL
            // ========================================================
            // Detectar el elemento nativo
            var unidadMedidaEl = document.getElementById('unidadMedida');
            if (unidadMedidaEl) {
                try {
                    // Si el select est√° dentro del modal de AGREGAR, lo dejamos como select nativo
                    var estaEnModalAgregar = unidadMedidaEl.closest && unidadMedidaEl.closest('#agregarInventarioModal');
                    if (estaEnModalAgregar) {
                        console.log('‚úã Saltando inicializaci√≥n Select2 para #unidadMedida dentro de #agregarInventarioModal (usar select nativo)');
                    } else {
                        console.log('‚úì Encontrado #unidadMedida fuera del modal, inicializando Select2');
                        $('#unidadMedida').select2({
                            theme: 'bootstrap4',
                            width: '100%',
                            allowClear: true,
                            placeholder: 'üìê Selecciona una unidad...',
                            minimumInputLength: 0
                        });
                        console.log('Select2 inicializado en #unidadMedida');
                    }
                } catch (err) {
                    console.warn('‚ö† Error verificando ubicaci√≥n de #unidadMedida, inicializando Select2 por seguridad', err);
                    $('#unidadMedida').select2({
                        theme: 'bootstrap4',
                        width: '100%',
                        allowClear: true,
                        placeholder: 'üìê Selecciona una unidad...',
                        minimumInputLength: 0
                    });
                }
            }

            // ========================================================
            // SELECT2 B√öSQUEDA DE MATERIAL EN INVENTARIO - CON AJAX
            // ========================================================
            var $busquedaMaterialInventario = $('#busquedaMaterialInventario');
            if ($busquedaMaterialInventario.length) {
                console.log('‚úì Encontrado #busquedaMaterialInventario');

                var endpoint = '/punto-eca/catalogo/inventario/materiales/buscar';
                var puntoIdElement = document.getElementById('agregarPuntoId');
                var puntoId = puntoIdElement ? puntoIdElement.value : '';

                console.log('PuntoId para b√∫squeda:', puntoId);

                $busquedaMaterialInventario.select2({
                    theme: 'bootstrap4',
                    width: '100%',
                    placeholder: 'Busca o selecciona un material...',
                    allowClear: true,
                    minimumInputLength: 0,
                    ajax: {
                        url: endpoint,
                        dataType: 'json',
                        delay: 300,
                        data: function(params) {
                            var searchTerm = params.term || '';
                            var categoria = $('#filtroCategoriaSelectInventario').val() || '';
                            var tipo = $('#filtroTipoSelectInventario').val() || '';

                            var requestData = {
                                puntoId: puntoId,
                                texto: searchTerm,
                                categoria: categoria,
                                tipo: tipo
                            };

                            console.log('üîç Par√°metros AJAX b√∫squeda:', requestData);
                            return requestData;
                        },
                        processResults: function(data) {
                            console.log('üì¶ Respuesta b√∫squeda:', data);

                            if (!Array.isArray(data)) {
                                console.warn('Respuesta no es array');
                                return { results: [] };
                            }

                            var results = data.map(function(m) {
                                return {
                                    id: m.nmbMaterial,  // Usar el nombre del material como ID
                                    text: m.nmbMaterial,
                                    materialId: m.materialId,
                                    category: m.nmbCategoria || '',
                                    type: m.nmbTipo || ''
                                };
                            });

                            console.log('‚úì Materiales procesados:', results.length);
                            return { results: results };
                        },
                        error: function(xhr, status, error) {
                            console.error('‚ùå Error AJAX b√∫squeda:', error);
                        }
                    }
                });

                // Evento cuando se selecciona un material
                $busquedaMaterialInventario.on('select2:select', function(e) {
                    console.log('Material seleccionado:', e.params.data);
                    // El valor guardado es el nombre del material (nmbMaterial)
                });

                // Disparar b√∫squeda al abrir sin escritura
                $busquedaMaterialInventario.on('select2:opening', function() {
                    setTimeout(function() {
                        var searchField = $busquedaMaterialInventario.data('select2').$dropdown.find('.select2-search__field');
                        if (searchField) {
                            searchField.trigger('input');
                        }
                    }, 50);
                });

                console.log('‚úì Select2 b√∫squeda inicializado');
            }

            // ========================================================
            // MANEJADOR: Bot√≥n Buscar Inventario
            // ========================================================
            var btnBuscarInventario = document.getElementById('btnBuscarInventario');
            if (btnBuscarInventario) {
                btnBuscarInventario.addEventListener('click', function() {
                    console.log('Click en Buscar Inventario');

                    // Obtener valores de los filtros
                    var materialSeleccionado = $('#busquedaMaterialInventario').val() || '';
                    var categoria = $('#filtroCategoriaSelectInventario').val() || '';
                    var tipo = $('#filtroTipoSelectInventario').val() || '';
                    var alerta = $('#filtroAlerataInventario').val() || '';
                    var unidad = $('#filtroUnidadInventario').val() || '';
                    var ocupacion = $('#filtroOcupacionInventario').val() || '';

                    console.log('Filtros seleccionados:', {
                        material: materialSeleccionado,
                        categoria: categoria,
                        tipo: tipo,
                        alerta: alerta,
                        unidad: unidad,
                        ocupacion: ocupacion
                    });

                    // Construir URL con par√°metros
                    var params = new URLSearchParams();
                    var pathSegments = window.location.pathname.split('/').filter(s => s);
                    var nombrePunto = pathSegments[1];
                    var gestorId = pathSegments[2];

                    // Agregar par√°metros a la URL
                    if (materialSeleccionado) params.append('texto', materialSeleccionado);
                    if (categoria) params.append('categoria', categoria);
                    if (tipo) params.append('tipo', tipo);
                    if (alerta) params.append('alerta', alerta);
                    if (unidad) params.append('unidad', unidad);
                    if (ocupacion) params.append('ocupacion', ocupacion);

                    var url = `/punto-eca/${nombrePunto}/${gestorId}/Materiales${params.toString() ? ('?' + params.toString()) : ''}`;
                    console.log('URL de b√∫squeda:', url);

                    // Recargar p√°gina con filtros
                    window.location.href = url;
                });

                console.log('Manejador bot√≥n buscar vinculado');
            }

            // ========================================================
            // MANEJADOR: Bot√≥n Limpiar Filtros Inventario
            // ========================================================
            var btnLimpiarTodosFiltraInventario = document.getElementById('btnLimpiarTodosFiltraInventario');
            if (btnLimpiarTodosFiltraInventario) {
                btnLimpiarTodosFiltraInventario.addEventListener('click', function() {
                    console.log('Click en Limpiar Filtros');

                    // Limpiar todos los Select2 usando jQuery
                    $('#busquedaMaterialInventario').val(null).trigger('change');
                    $('#filtroCategoriaSelectInventario').val('').trigger('change');
                    $('#filtroTipoSelectInventario').val('').trigger('change');
                    $('#filtroAlerataInventario').val('').trigger('change');
                    $('#filtroUnidadInventario').val('').trigger('change');
                    $('#filtroOcupacionInventario').val('').trigger('change');

                    console.log('Todos los filtros limpiados');
                });

                console.log('Manejador bot√≥n limpiar vinculado');
            }

            // ========================================================
            // INICIALIZAR SELECT2 EN CATEGOR√çA (Segunda b√∫squeda)
            // ========================================================
            var $filtroCategoriaSelectInventario = $('#filtroCategoriaSelectInventario');
            if ($filtroCategoriaSelectInventario.length) {
                console.log('Encontrado #filtroCategoriaSelectInventario');

                $filtroCategoriaSelectInventario.select2({
                    theme: 'bootstrap4',
                    width: '100%',
                    allowClear: true,
                    placeholder: 'Selecciona una categor√≠a...',
                    minimumInputLength: 0
                });

                console.log('Select2 inicializado en #filtroCategoriaSelectInventario');
            }

            // ========================================================
            // INICIALIZAR SELECT2 EN TIPO (Segunda b√∫squeda)
            // ========================================================
            var $filtroTipoSelectInventario = $('#filtroTipoSelectInventario');
            if ($filtroTipoSelectInventario.length) {
                console.log('Encontrado #filtroTipoSelectInventario');

                $filtroTipoSelectInventario.select2({
                    theme: 'bootstrap4',
                    width: '100%',
                    allowClear: true,
                    placeholder: 'Selecciona un tipo...',
                    minimumInputLength: 0
                });

                console.log('Select2 inicializado en #filtroTipoSelectInventario');
            }


            // ========================================================
            // INICIALIZAR SELECT2 EN ALERTA (Segunda b√∫squeda)
            // ========================================================
            var $filtroAlerataInventario = $('#filtroAlerataInventario');
            if ($filtroAlerataInventario.length) {
                console.log('Encontrado #filtroAlerataInventario');

                $filtroAlerataInventario.select2({
                    theme: 'bootstrap4',
                    width: '100%',
                    allowClear: true,
                    placeholder: 'Selecciona una alerta...',
                    minimumInputLength: 0
                });

                console.log('Select2 inicializado en #filtroAlerataInventario');
            }

            // ========================================================
            // INICIALIZAR SELECT2 EN UNIDAD DE MEDIDA (Segunda b√∫squeda)
            // ========================================================
            var $filtroUnidadInventario = $('#filtroUnidadInventario');
            if ($filtroUnidadInventario.length) {
                console.log('Encontrado #filtroUnidadInventario');

                $filtroUnidadInventario.select2({
                    theme: 'bootstrap4',
                    width: '100%',
                    allowClear: true,
                    placeholder: 'Selecciona una unidad...',
                    minimumInputLength: 0
                });

                console.log('Select2 inicializado en #filtroUnidadInventario');
            }

            // ========================================================
            // INICIALIZAR SELECT2 EN OCUPACI√ìN (Segunda b√∫squeda)
            // ========================================================
            var $filtroOcupacionInventario = $('#filtroOcupacionInventario');
            if ($filtroOcupacionInventario.length) {
                console.log('Encontrado #filtroOcupacionInventario');

                $filtroOcupacionInventario.select2({
                    theme: 'bootstrap4',
                    width: '100%',
                    allowClear: true,
                    placeholder: 'Selecciona ocupaci√≥n...',
                    minimumInputLength: 0
                });

                console.log('Select2 inicializado en #filtroOcupacionInventario');
            }

            console.log('Select2 inicializaci√≥n completada');
        }

        // Inicializar cuando DOM est√© listo
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', inicializarSelect2);
        } else {
            inicializarSelect2();
        }

        console.log('‚úì Script Select2 cargado y listo');
    })();
    </script>

    <!-- SCRIPT: Manejo de Guardar en Inventario -->
    <script>
    (function() {
        console.log('üìå Inicializando handler de Guardar en Inventario...');

        function obtenerNumero(id) {
            const el = document.getElementById(id);
            if (!el) return null;
            const v = el.value;
            if (v === null || v === undefined || v === '') return null;
            const n = Number(v);
            return Number.isNaN(n) ? null : n;
        }

        function mostrarMensajeTemporal(text, tipo = 'info') {
            const mensajeEl = document.getElementById('mensajeEstado');
            const texto = document.getElementById('textoMensaje');
            if (!mensajeEl || !texto) return;
            texto.textContent = text;
            mensajeEl.className = 'alert alert-' + (tipo === 'error' ? 'danger' : (tipo === 'success' ? 'success' : 'info')) + ' mt-4';
            mensajeEl.style.display = 'block';
            setTimeout(() => { mensajeEl.style.display = 'none'; }, 5000);
        }

        function validarPayload(payload) {
            const errores = [];
            if (!payload.materialId) errores.push('Material no seleccionado');
            if (!payload.puntoEcaId) errores.push('Punto no encontrado');
            if (payload.capacidadMaxima == null || payload.capacidadMaxima <= 0) errores.push('Capacidad m√°xima debe ser mayor a 0');
            if (!payload.unidadMedida) errores.push('Unidad de medida es obligatoria');
            if (payload.stockActual == null || payload.stockActual < 0) errores.push('Stock inicial inv√°lido');
            if (payload.precioCompra == null || payload.precioCompra <= 0) errores.push('Precio de compra inv√°lido');
            if (payload.precioVenta == null || payload.precioVenta <= 0) errores.push('Precio de venta inv√°lido');
            if (payload.umbralAlerta == null || payload.umbralAlerta < 1 || payload.umbralAlerta > 100) errores.push('Umbral de alerta debe estar entre 1 y 100');
            if (payload.umbralCritico == null || payload.umbralCritico < 1 || payload.umbralCritico > 100) errores.push('Umbral cr√≠tico debe estar entre 1 y 100');
            return errores;
        }

        function manejarGuardarInventario(e) {
            e.preventDefault();
            const btn = document.getElementById('btnGuardarInventario');
            if (!btn) return;

            // Recolectar datos
            const materialId = (document.getElementById('agregarMaterialId') || {}).value || '';
            const puntoEcaId = (document.getElementById('agregarPuntoId') || {}).value || '';
            const capacidadMaxima = obtenerNumero('capacidadMaxima');
            const unidadMedida = (document.getElementById('unidadMedida') || {}).value || '';
            const stockActual = obtenerNumero('stockInicial');
            const precioCompra = obtenerNumero('precioCompra');
            const precioVenta = obtenerNumero('precioVenta');
            const umbralAlerta = obtenerNumero('umbralAlerta');
            const umbralCritico = obtenerNumero('umbralCritico');

            const payload = {
                capacidadMaxima: capacidadMaxima,
                unidadMedida: unidadMedida,
                stockActual: stockActual,
                umbralAlerta: umbralAlerta ? Number(umbralAlerta) : null,
                umbralCritico: umbralCritico ? Number(umbralCritico) : null,
                precioVenta: precioVenta,
                precioCompra: precioCompra,
                materialId: materialId,
                puntoEcaId: puntoEcaId
            };

            console.log('üîé Payload a enviar:', payload);

            const errores = validarPayload(payload);
            if (errores.length) {
                console.warn('‚ö† Errores de validaci√≥n:', errores);
                mostrarMensajeTemporal('Errores: ' + errores.join('; '), 'error');
                return;
            }

            // Deshabilitar bot√≥n y mostrar estado
            const textoOriginal = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="bi bi-hourglass-split me-1"></i>Guardando...';

            // Ejecutar POST
            fetch('/punto-eca/inventario/agregar', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                body: JSON.stringify(payload)
            })
            .then(response => response.json().then(body => ({ status: response.status, ok: response.ok, body })))
            .then(({ status, ok, body }) => {
                console.log('üì• Respuesta servidor agregar inventario:', { status, ok, body });
                if (ok && (status === 201 || status === 200)) {
                    // √âxito
                    mostrarModalResultado(true, '¬°Inventario a√±adido!', body?.mensaje || 'Inventario guardado correctamente');
                } else {
                    const mensaje = body?.mensaje || body?.error || (body?.message) || 'Error al guardar inventario';
                    console.error('‚ùå Error en creaci√≥n:', mensaje);
                    mostrarModalResultado(false, 'Error', mensaje);
                }
            })
            .catch(err => {
                console.error('‚ùå Error fetch al guardar inventario:', err);
                mostrarModalResultado(false, 'Error', 'No fue posible guardar: ' + (err.message || err));
            })
            .finally(() => {
                btn.disabled = false;
                btn.innerHTML = textoOriginal;
            });
        }

        // Vincular evento al bot√≥n
        document.addEventListener('DOMContentLoaded', function() {
            const btn = document.getElementById('btnGuardarInventario');
            if (btn) {
                btn.removeEventListener('click', manejarGuardarInventario);
                btn.addEventListener('click', manejarGuardarInventario);
                console.log('‚úì Handler agregado a #btnGuardarInventario');
            } else {
                console.warn('‚úó Bot√≥n #btnGuardarInventario no encontrado');
            }
        });

    })();
    </script>

</section>

