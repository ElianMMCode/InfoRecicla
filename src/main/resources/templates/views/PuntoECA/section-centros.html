<!-- Fragment: Centros de Acopio -->
<section th:fragment="centros" class="py-4"
         th:data-gestor="${gestor}"
         th:data-usuario-id="${usuario.usuarioId}"
         th:data-punto-eca-id="${usuario.puntoEcaId()}">

    <!-- Título principal -->
    <div class="mb-4">
        <h2 class="h4 fw-bold text-dark mb-1">
            <i class="bi bi-geo-alt me-2"></i>Centros de Acopio
        </h2>
        <p class="text-muted small mb-0">Gestiona y visualiza los centros de acopio globales y propios de tu punto ECA</p>
    </div>

    <!-- ACORDEÓN PRINCIPAL -->
    <div class="accordion accordion-flush shadow-sm" id="acordeonCentros">

        <!-- ACORDEÓN 1: CENTROS GLOBALES -->
        <div class="accordion-item border-start border-5 border-info">
            <h2 class="accordion-header" id="headingCentrosGlobales">
                <button class="accordion-button fw-bold" type="button"
                        data-bs-toggle="collapse" data-bs-target="#collapseCentrosGlobales"
                        aria-expanded="true" aria-controls="collapseCentrosGlobales">
                    <span class="bg-info p-2 rounded-circle me-3" style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">
                        <i class="bi bi-globe-americas text-white"></i>
                    </span>
                    <span>
                        <span class="fw-bold text-dark d-block">Centros Globales</span>
                        <small class="text-muted fw-normal">Centros visibles para todos los usuarios</small>
                    </span>
                    <span class="badge bg-info ms-auto me-2" th:text="${totalCentrosGlobales}">0</span>
                </button>
            </h2>
            <div id="collapseCentrosGlobales" class="accordion-collapse collapse show"
                 aria-labelledby="headingCentrosGlobales" data-bs-parent="#acordeonCentros">
                <div class="accordion-body p-4 bg-light">

                    <!-- Filtros de búsqueda para centros globales -->
                    <div class="mb-4 pb-4 border-bottom">
                        <h6 class="fw-semibold text-info mb-3">
                            <i class="bi bi-funnel me-2"></i>Buscar y Filtrar
                        </h6>

                        <!-- Fila 1: Nombre, Tipo, Localidad -->
                        <div class="row g-3 mb-3">
                            <div class="col-md-4">
                                <label for="filtroNombreGlobal" class="form-label fw-semibold text-muted mb-2">
                                    <i class="bi bi-building me-1"></i>Por Nombre
                                </label>
                                <input type="text" class="form-control filtro-nombre-global"
                                       placeholder="Nombre del centro..." id="filtroNombreGlobal">
                            </div>

                            <div class="col-md-4">
                                <label for="filtroTipoGlobal" class="form-label fw-semibold text-muted mb-2">
                                    <i class="bi bi-tag me-1"></i>Por Tipo
                                </label>
                                <select id="filtroTipoGlobal" class="form-select filtro-tipo-global">
                                    <option value="">-- Todos --</option>
                                    <option value="Planta">Planta</option>
                                    <option value="Proveedor">Proveedor</option>
                                    <option value="OTRO">Otro</option>
                                </select>
                            </div>

                            <div class="col-md-4">
                                <label for="filtroLocalidadGlobal" class="form-label fw-semibold text-muted mb-2">
                                    <i class="bi bi-map me-1"></i>Por Localidad
                                </label>
                                <select id="filtroLocalidadGlobal" class="form-select filtro-localidad-global">
                                    <option value="">-- Todas las localidades --</option>
                                    <option th:each="localidad : ${localidades}" th:value="${localidad.localidadId}" th:text="${localidad.nombre}"></option>
                                </select>
                            </div>
                        </div>

                        <!-- Fila 2: Contacto, Email, Teléfono -->
                        <div class="row g-3 mb-3">
                            <div class="col-md-4">
                                <label for="filtroContactoGlobal" class="form-label fw-semibold text-muted mb-2">
                                    <i class="bi bi-person me-1"></i>Por Contacto
                                </label>
                                <input type="text" class="form-control filtro-contacto-global"
                                       placeholder="Nombre del contacto..." id="filtroContactoGlobal">
                            </div>

                            <div class="col-md-4">
                                <label for="filtroEmailGlobal" class="form-label fw-semibold text-muted mb-2">
                                    <i class="bi bi-envelope me-1"></i>Por Correo
                                </label>
                                <input type="text" class="form-control filtro-email-global"
                                       placeholder="Correo..." id="filtroEmailGlobal">
                            </div>

                            <div class="col-md-4">
                                <label for="filtroTelefonoGlobal" class="form-label fw-semibold text-muted mb-2">
                                    <i class="bi bi-telephone me-1"></i>Por Teléfono
                                </label>
                                <input type="text" class="form-control filtro-telefono-global"
                                       placeholder="Teléfono..." id="filtroTelefonoGlobal">
                            </div>
                        </div>

                        <!-- Fila 3: Botones Buscar y Limpiar -->
                        <div class="row g-3">
                            <div class="col-md-6">
                                <button class="btn btn-primary w-100 btn-buscar-globales" type="button">
                                    <i class="bi bi-search me-2"></i>Buscar
                                </button>
                            </div>
                            <div class="col-md-6">
                                <button class="btn btn-outline-secondary w-100 btn-limpiar-globales" type="button">
                                    <i class="bi bi-eraser me-2"></i>Limpiar
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Tabla de centros globales -->
                    <div class="table-responsive">
                        <table class="table table-hover table-sm align-middle mb-0" id="tablaCentrosGlobales">
                            <thead class="bg-info text-white sticky-top">
                                <tr>
                                    <th style="width: 20%;"><i class="bi bi-building me-1"></i>Nombre</th>
                                    <th style="width: 15%;"><i class="bi bi-tag me-1"></i>Tipo</th>
                                    <th style="width: 15%;"><i class="bi bi-geo me-1"></i>Ciudad</th>
                                    <th style="width: 15%;"><i class="bi bi-person me-1"></i>Contacto</th>
                                    <th style="width: 15%;"><i class="bi bi-telephone me-1"></i>Teléfono</th>
                                    <th style="width: 20%;"><i class="bi bi-envelope me-1"></i>Correo</th>
                                </tr>
                            </thead>
                            <tbody class="tabla-centros-globales-body">
                                <tr th:each="centro : ${centrosGlobales}" class="fila-centro-global"
                                    th:attr="data-nombre=${centro.nombreCntAcp},
                                             data-tipo=${centro.tipoCntAcp != null ? centro.tipoCntAcp.tipo : ''},
                                             data-localidad-id=${centro.localidad != null ? centro.localidad.localidadId : ''},
                                             data-contacto=${centro.nombreContactoCntAcp != null ? centro.nombreContactoCntAcp : ''},
                                             data-email=${centro.email != null ? centro.email : ''},
                                             data-telefono=${centro.celular != null ? centro.celular : ''}">
                                    <td class="fw-semibold text-dark" th:text="${centro.nombreCntAcp}">—</td>
                                    <td>
                                        <span class="badge bg-info-subtle text-info" th:text="${centro.tipoCntAcp != null ? centro.tipoCntAcp.tipo : '—'}">—</span>
                                    </td>
                                    <td th:text="${centro.ciudad != null ? centro.ciudad : '—'}">—</td>
                                    <td th:text="${centro.nombreContactoCntAcp != null ? centro.nombreContactoCntAcp : '—'}">—</td>
                                    <td>
                                        <a th:href="'tel:' + ${centro.celular}" th:text="${centro.celular != null ? centro.celular : '—'}"
                                           class="text-decoration-none" th:if="${centro.celular != null}">—</a>
                                        <span th:if="${centro.celular == null}">—</span>
                                    </td>
                                    <td>
                                        <a th:href="'mailto:' + ${centro.email}" th:text="${centro.email != null ? centro.email : '—'}"
                                           class="text-decoration-none text-truncate d-block" th:if="${centro.email != null}">—</a>
                                        <span th:if="${centro.email == null}">—</span>
                                    </td>
                                </tr>
                                <tr th:if="${centrosGlobales == null or centrosGlobales.isEmpty()}" class="sin-resultados-global">
                                    <td colspan="6" class="text-center text-muted py-4">
                                        <i class="bi bi-inbox me-2"></i>No hay centros globales disponibles
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- ACORDEÓN 2: CENTROS PROPIOS DEL PUNTO -->
        <div class="accordion-item border-start border-5 border-success">
            <h2 class="accordion-header" id="headingCentrosPropios">
                <button class="accordion-button fw-bold collapsed" type="button"
                        data-bs-toggle="collapse" data-bs-target="#collapseCentrosPropios"
                        aria-expanded="false" aria-controls="collapseCentrosPropios">
                    <span class="bg-success p-2 rounded-circle me-3" style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">
                        <i class="bi bi-house-fill text-white"></i>
                    </span>
                    <span>
                        <span class="fw-bold text-dark d-block">Centros Propios</span>
                        <small class="text-muted fw-normal">Centros específicos de tu punto ECA</small>
                    </span>
                    <span class="badge bg-success ms-auto me-2" th:text="${totalCentrosPropios}">0</span>
                </button>
            </h2>
            <div id="collapseCentrosPropios" class="accordion-collapse collapse"
                 aria-labelledby="headingCentrosPropios" data-bs-parent="#acordeonCentros">
                <div class="accordion-body p-4 bg-light">

                    <!-- Filtros de búsqueda para centros propios -->
                    <div class="mb-4 pb-4 border-bottom">
                        <h6 class="fw-semibold text-success mb-3">
                            <i class="bi bi-funnel me-2"></i>Buscar y Filtrar
                        </h6>

                        <!-- Fila 1: Nombre, Tipo, Localidad -->
                        <div class="row g-3 mb-3">
                            <div class="col-md-4">
                                <label for="filtroNombrePropio" class="form-label fw-semibold text-muted mb-2">
                                    <i class="bi bi-building me-1"></i>Por Nombre
                                </label>
                                <input type="text" class="form-control filtro-nombre-propio"
                                       placeholder="Nombre del centro..." id="filtroNombrePropio">
                            </div>

                            <div class="col-md-4">
                                <label for="filtroTipoPropio" class="form-label fw-semibold text-muted mb-2">
                                    <i class="bi bi-tag me-1"></i>Por Tipo
                                </label>
                                <select id="filtroTipoPropio" class="form-select filtro-tipo-propio">
                                    <option value="">-- Todos --</option>
                                    <option value="Planta">Planta</option>
                                    <option value="Proveedor">Proveedor</option>
                                    <option value="OTRO">Otro</option>
                                </select>
                            </div>

                            <div class="col-md-4">
                                <label for="filtroLocalidadPropio" class="form-label fw-semibold text-muted mb-2">
                                    <i class="bi bi-map me-1"></i>Por Localidad
                                </label>
                                <select id="filtroLocalidadPropio" class="form-select filtro-localidad-propio">
                                    <option value="">-- Todas las localidades --</option>
                                    <option th:each="localidad : ${localidades}" th:value="${localidad.localidadId}" th:text="${localidad.nombre}"></option>
                                </select>
                            </div>
                        </div>

                        <!-- Fila 2: Contacto, Email, Teléfono -->
                        <div class="row g-3 mb-3">
                            <div class="col-md-4">
                                <label for="filtroContactoPropio" class="form-label fw-semibold text-muted mb-2">
                                    <i class="bi bi-person me-1"></i>Por Contacto
                                </label>
                                <input type="text" class="form-control filtro-contacto-propio"
                                       placeholder="Nombre del contacto..." id="filtroContactoPropio">
                            </div>

                            <div class="col-md-4">
                                <label for="filtroEmailPropio" class="form-label fw-semibold text-muted mb-2">
                                    <i class="bi bi-envelope me-1"></i>Por Correo
                                </label>
                                <input type="text" class="form-control filtro-email-propio"
                                       placeholder="Correo..." id="filtroEmailPropio">
                            </div>

                            <div class="col-md-4">
                                <label for="filtroTelefonoPropio" class="form-label fw-semibold text-muted mb-2">
                                    <i class="bi bi-telephone me-1"></i>Por Teléfono
                                </label>
                                <input type="text" class="form-control filtro-telefono-propio"
                                       placeholder="Teléfono..." id="filtroTelefonoPropio">
                            </div>
                        </div>

                        <!-- Fila 3: Botones Buscar y Limpiar -->
                        <div class="row g-3">
                            <div class="col-md-6">
                                <button class="btn btn-primary w-100 btn-buscar-propios" type="button">
                                    <i class="bi bi-search me-2"></i>Buscar
                                </button>
                            </div>
                            <div class="col-md-6">
                                <button class="btn btn-outline-secondary w-100 btn-limpiar-propios" type="button">
                                    <i class="bi bi-eraser me-2"></i>Limpiar
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Tabla de centros propios -->
                    <div class="table-responsive">
                        <table class="table table-hover table-sm align-middle mb-0" id="tablaCentrosPropios">
                            <thead class="bg-success text-white sticky-top">
                                <tr>
                                    <th style="width: 20%;"><i class="bi bi-building me-1"></i>Nombre</th>
                                    <th style="width: 15%;"><i class="bi bi-tag me-1"></i>Tipo</th>
                                    <th style="width: 15%;"><i class="bi bi-map me-1"></i>Localidad</th>
                                    <th style="width: 15%;"><i class="bi bi-telephone me-1"></i>Teléfono</th>
                                    <th style="width: 20%;"><i class="bi bi-chat-left-text me-1"></i>Notas</th>
                                    <th style="width: 15%;"><i class="bi bi-gear me-1"></i>Acciones</th>
                                </tr>
                            </thead>
                            <tbody class="tabla-centros-propios-body">
                                <tr th:each="centro : ${centrosPropios}" class="fila-centro-propio"
                                    th:data-centro-id="${centro.cntAcpId}"
                                    th:attr="data-nombre=${centro.nombreCntAcp},
                                             data-tipo=${centro.tipoCntAcp != null ? centro.tipoCntAcp.tipo : ''},
                                             data-localidad=${centro.localidad != null ? centro.localidad.nombre : ''},
                                             data-localidad-id=${centro.localidad != null ? centro.localidad.localidadId : ''},
                                             data-contacto=${centro.nombreContactoCntAcp != null ? centro.nombreContactoCntAcp : ''},
                                             data-email=${centro.email != null ? centro.email : ''},
                                             data-telefono=${centro.celular != null ? centro.celular : ''}">
                                    <td class="fw-semibold text-dark" th:text="${centro.nombreCntAcp}">—</td>
                                    <td>
                                        <span class="badge bg-success-subtle text-success" th:text="${centro.tipoCntAcp != null ? centro.tipoCntAcp.tipo : '—'}">—</span>
                                    </td>
                                    <td th:text="${centro.localidad != null ? centro.localidad.nombre : '—'}">—</td>
                                    <td>
                                        <a th:href="'tel:' + ${centro.celular}" th:text="${centro.celular != null ? centro.celular : '—'}"
                                           class="text-decoration-none" th:if="${centro.celular != null}">—</a>
                                        <span th:if="${centro.celular == null}">—</span>
                                    </td>
                                    <td>
                                        <small th:text="${centro.nota != null ? centro.nota : '—'}" class="text-muted">—</small>
                                    </td>
                                    <td>
                                        <button type="button" class="btn btn-outline-primary btn-sm"
                                                title="Ver detalles"
                                                onclick="abrirDetallesCentro(event, this.getAttribute('data-centro-id'))"
                                                th:data-centro-id="${centro.cntAcpId}">
                                            <i class="bi bi-eye"></i> Detalles
                                        </button>
                                    </td>
                                </tr>
                                <tr th:if="${centrosPropios == null or centrosPropios.isEmpty()}" class="sin-resultados-propios">
                                    <td colspan="6" class="text-center text-muted py-4">
                                        <i class="bi bi-inbox me-2"></i>No tienes centros propios registrados
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Botón para agregar nuevo centro -->
                    <div class="mt-4">
                        <button type="button" class="btn btn-success btn-lg w-100" id="btnAgregarNuevoCentro">
                            <i class="bi bi-plus-circle me-2"></i>Agregar Nuevo Centro
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL: Detalles del Centro Propio - Con edición -->
    <div class="modal fade" id="modalDetallesCentroPropio" data-modal-ready="true" tabindex="-1" aria-labelledby="modalDetallesCentroPropioLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title" id="modalDetallesCentroPropioLabel">
                        <i class="bi bi-building me-2"></i>Detalles del Centro
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="inputCentroId">

                    <!-- Nombre -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">
                                <i class="bi bi-building me-2"></i>Nombre
                            </label>
                            <div class="p-3 bg-light rounded border modo-lectura" id="lecturaNombre">
                                <p id="inputNombreCentro" class="mb-0">—</p>
                            </div>
                            <input type="text" class="form-control d-none modo-edicion" id="editNombreCentro" placeholder="Nombre del centro">
                        </div>
                        <!-- Tipo -->
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">
                                <i class="bi bi-tag me-2"></i>Tipo
                            </label>
                            <div class="p-3 bg-light rounded border modo-lectura" id="lecturaTipo">
                                <span id="inputTipoCentro" class="badge bg-info">—</span>
                            </div>
                            <input type="text" class="form-control d-none modo-edicion" id="editTipoCentro" placeholder="Tipo del centro">
                        </div>
                    </div>

                    <!-- Localidad y Teléfono -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">
                                <i class="bi bi-map me-2"></i>Localidad
                            </label>
                            <div class="p-3 bg-light rounded border modo-lectura" id="lecturaLocalidad">
                                <p id="inputLocalidadCentro" class="mb-0">—</p>
                            </div>
                            <input type="text" class="form-control d-none modo-edicion" id="editLocalidadCentro" placeholder="Localidad">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">
                                <i class="bi bi-telephone me-2"></i>Teléfono
                            </label>
                            <div class="p-3 bg-light rounded border modo-lectura" id="lecturaTelefono">
                                <a id="inputTelefonoCentro" href="#" class="text-decoration-none">—</a>
                            </div>
                            <input type="tel" class="form-control d-none modo-edicion" id="editTelefonoCentro" placeholder="Teléfono">
                        </div>
                    </div>

                    <!-- Email y Contacto -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">
                                <i class="bi bi-envelope me-2"></i>Correo
                            </label>
                            <div class="p-3 bg-light rounded border modo-lectura" id="lecturaEmail">
                                <a id="inputEmailCentro" href="mailto:#" class="text-decoration-none text-truncate d-block">—</a>
                            </div>
                            <input type="email" class="form-control d-none modo-edicion" id="editEmailCentro" placeholder="Correo">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">
                                <i class="bi bi-person me-2"></i>Nombre del Contacto
                            </label>
                            <div class="p-3 bg-light rounded border modo-lectura" id="lecturaContacto">
                                <p id="inputContactoCentro" class="mb-0">—</p>
                            </div>
                            <input type="text" class="form-control d-none modo-edicion" id="editContactoCentro" placeholder="Nombre del contacto">
                        </div>
                    </div>

                    <!-- Notas -->
                    <div class="row">
                        <div class="col-12">
                            <label class="form-label fw-semibold">
                                <i class="bi bi-chat-left-text me-2"></i>Notas
                            </label>
                            <div class="p-3 bg-light rounded border modo-lectura" id="lecturaNotas">
                                <p id="inputNotasCentro" class="mb-0 small text-muted">—</p>
                            </div>
                            <textarea class="form-control d-none modo-edicion" id="editNotasCentro" placeholder="Notas" rows="3"></textarea>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary modo-lectura" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle me-2"></i>Cerrar
                    </button>
                    <button type="button" class="btn btn-danger modo-lectura" id="btnBorrarModal">
                        <i class="bi bi-trash me-2"></i>Borrar
                    </button>
                    <button type="button" class="btn btn-primary modo-lectura" id="btnEditarModal">
                        <i class="bi bi-pencil me-2"></i>Editar
                    </button>
                    <button type="button" class="btn btn-secondary d-none modo-edicion" id="btnCancelarEdicion">
                        <i class="bi bi-x me-2"></i>Cancelar
                    </button>
                    <button type="button" class="btn btn-success d-none modo-edicion" id="btnGuardarEdicion">
                        <i class="bi bi-save me-2"></i>Guardar
                    </button>
                </div>
            </div>
        </div>
    </div>
</section>
