<!-- Fragment: Configuración -->
<section th:fragment="configuracion" class="container py-4">
    <h2 class="h5 mb-4">Configuración</h2>

    <!-- Alerts -->
    <div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show" role="alert">
        <i class="bi bi-check-circle me-2"></i><span th:text="${successMessage}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show" role="alert">
        <i class="bi bi-exclamation-circle me-2"></i><span th:text="${errorMessage}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>

    <div class="row g-4">
        <!-- Cambiar Contraseña -->
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-lock me-2"></i>Cambiar Contraseña
                    </h5>
                </div>
                <div class="card-body">
                    <form id="formCambiarContrasena" class="needs-validation">
                        <div class="mb-3">
                            <label class="form-label" for="contrasenaActual">Contraseña Actual</label>
                            <input class="form-control" id="contrasenaActual" name="contrasenaActual" type="password" required>
                            <small class="text-muted">Ingresa tu contraseña actual para confirmar el cambio</small>
                        </div>

                        <div class="mb-3">
                            <label class="form-label" for="contrasenaNueva">Contraseña Nueva</label>
                            <input class="form-control" id="contrasenaNueva" name="contrasenaNueva" type="password" required
                                   minlength="8" pattern="^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{8,}$">
                            <small class="text-muted d-block">
                                ✓ Mínimo 8 caracteres<br>
                                ✓ Mayúsculas (A-Z)<br>
                                ✓ Minúsculas (a-z)<br>
                                ✓ Números (0-9)<br>
                                ✓ Caracteres especiales (@$!%*?&)
                            </small>
                        </div>

                        <div class="mb-3">
                            <label class="form-label" for="confirmarContrasena">Confirmar Contraseña</label>
                            <input class="form-control" id="confirmarContrasena" name="confirmarContrasena" type="password" required>
                            <small class="text-muted" id="mensajeCoincidencia"></small>
                        </div>

                        <div class="d-grid gap-2">
                            <button class="btn btn-success" id="btnCambiarContrasena" type="button" disabled>
                                <i class="bi bi-check-circle me-2"></i>Cambiar Contraseña
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Preferencias -->
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-sliders me-2"></i>Preferencias
                    </h5>
                </div>
                <div class="card-body">
                    <form id="formPreferencias" method="post" th:action="@{/punto-eca/actualizar-preferencias}">
                        <div class="mb-3">
                            <label class="form-label">Visibilidad en el mapa</label>
                            <div class="form-check form-switch">
                                <input class="form-check-input" id="cfgMapa" name="visibleEnMapa" type="checkbox">
                                <label class="form-check-label" for="cfgMapa">
                                    Mostrar punto ECA en el mapa público
                                </label>
                            </div>
                            <small class="text-muted d-block mt-2">Solo será visible cuando tu punto esté aprobado</small>
                        </div>

                        <hr>

                        <div class="mb-3">
                            <label class="form-label">Notificaciones</label>
                            <div class="form-check form-switch">
                                <input class="form-check-input" id="cfgNotiAprobacion" name="notificacionesAprobacion" type="checkbox" checked>
                                <label class="form-check-label" for="cfgNotiAprobacion">
                                    Aprobaciones y cambios de estado
                                </label>
                            </div>
                            <div class="form-check form-switch">
                                <input class="form-check-input" id="cfgNotiMensajes" name="notificacionesMensajes" type="checkbox" checked>
                                <label class="form-check-label" for="cfgNotiMensajes">
                                    Mensajes y comentarios
                                </label>
                            </div>
                            <div class="form-check form-switch">
                                <input class="form-check-input" id="cfgNotiInventario" name="notificacionesInventario" type="checkbox" checked>
                                <label class="form-check-label" for="cfgNotiInventario">
                                    Alertas de inventario
                                </label>
                            </div>
                        </div>

                        <hr>

                        <div class="d-grid gap-2">
                            <button class="btn btn-success" type="submit">
                                <i class="bi bi-save me-2"></i>Guardar Preferencias
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Información del Punto -->
    <div class="card mt-4">
        <div class="card-header bg-success text-white">
            <h5 class="card-title mb-0">
                <i class="bi bi-info-circle me-2"></i>Información del Punto ECA
            </h5>
        </div>
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-6">
                    <p class="text-muted small mb-1">Nombre del Punto</p>
                    <p class="h6 mb-3" th:text="${usuario.nombrePunto}">—</p>
                </div>
                <div class="col-md-6">
                    <p class="text-muted small mb-1">Email de Contacto</p>
                    <p class="h6 mb-3" th:text="${usuario.email}">—</p>
                </div>
                <div class="col-md-6">
                    <p class="text-muted small mb-1">Teléfono</p>
                    <p class="h6 mb-3" th:text="${usuario.celular}">—</p>
                </div>
                <div class="col-md-6">
                    <p class="text-muted small mb-1">Ciudad</p>
                    <p class="h6 mb-3" th:text="${usuario.ciudad}">—</p>
                </div>
            </div>
        </div>
    </div>
</section>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const contrasenaActual = document.getElementById('contrasenaActual');
    const contrasenaNueva = document.getElementById('contrasenaNueva');
    const confirmarContrasena = document.getElementById('confirmarContrasena');
    const btnCambiar = document.getElementById('btnCambiarContrasena');
    const mensajeCoincidencia = document.getElementById('mensajeCoincidencia');

    function validarCoincidencia() {
        if (contrasenaNueva.value && confirmarContrasena.value) {
            if (contrasenaNueva.value === confirmarContrasena.value) {
                confirmarContrasena.classList.remove('is-invalid');
                confirmarContrasena.classList.add('is-valid');
                mensajeCoincidencia.textContent = '✓ Las contraseñas coinciden';
                mensajeCoincidencia.classList.add('text-success');
                mensajeCoincidencia.classList.remove('text-danger');
            } else {
                confirmarContrasena.classList.remove('is-valid');
                confirmarContrasena.classList.add('is-invalid');
                mensajeCoincidencia.textContent = '✗ Las contraseñas no coinciden';
                mensajeCoincidencia.classList.remove('text-success');
                mensajeCoincidencia.classList.add('text-danger');
            }
        } else {
            confirmarContrasena.classList.remove('is-valid', 'is-invalid');
            mensajeCoincidencia.textContent = '';
        }
        actualizarEstadoBoton();
    }

    function validarRequisitos(password) {
        const tieneMinuscula = /[a-z]/.test(password);
        const tieneMayuscula = /[A-Z]/.test(password);
        const tieneNumero = /\d/.test(password);
        const tieneEspecial = /[@$!%*?&]/.test(password);
        const tieneLongitud = password.length >= 8;

        return tieneMinuscula && tieneMayuscula && tieneNumero && tieneEspecial && tieneLongitud;
    }

    function actualizarEstadoBoton() {
        const todosLlenos = contrasenaActual.value && contrasenaNueva.value && confirmarContrasena.value;
        const coinciden = contrasenaNueva.value === confirmarContrasena.value;
        const valida = validarRequisitos(contrasenaNueva.value);

        btnCambiar.disabled = !(todosLlenos && coinciden && valida);
    }

    // Event listeners
    contrasenaNueva.addEventListener('input', function() {
        validarCoincidencia();
        actualizarEstadoBoton();
    });
    confirmarContrasena.addEventListener('input', function() {
        validarCoincidencia();
        actualizarEstadoBoton();
    });
    contrasenaActual.addEventListener('input', actualizarEstadoBoton);

    // Enviar formulario
    btnCambiar.addEventListener('click', function(e) {
        e.preventDefault();

        const formData = new FormData();
        formData.append('contrasenaActual', contrasenaActual.value);
        formData.append('contrasenaNueva', contrasenaNueva.value);
        formData.append('confirmarContrasena', confirmarContrasena.value);

        fetch('/punto-eca/cambiar-contrasena', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (response.redirected) {
                window.location.href = response.url;
            } else {
                return response.text().then(text => {
                    console.error('Error response:', text);
                    alert('Error al cambiar la contraseña');
                });
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error al cambiar la contraseña: ' + error);
        });
    });
});
</script>

