<!-- Fragment: Movimientos -->
<section th:fragment="movimientos" class="py-4"
         th:data-gestor="${gestor}"
         th:data-usuario-id="${usuario.usuarioId}"
         th:data-punto-eca-id="${puntoEcaId}">
    <!-- T√≠tulo principal -->
    <div class="mb-4">
        <h2 class="h4 fw-bold text-dark mb-1">
            <i class="bi bi-arrow-left-right me-2"></i>Gesti√≥n de Movimientos de Inventario
        </h2>
        <p class="text-muted small mb-0">Registra y consulta entradas y salidas de materiales en el centro de acopio</p>
    </div>
    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <!-- SECCI√ìN 1: BARRA DE B√öSQUEDA Y SELECCI√ìN DE MATERIAL -->
    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="card shadow-sm mb-4" id="seccionBusquedaMaterial">
        <div class="card-header bg-primary-subtle border-0 px-4 py-3">
            <h6 class="mb-0 fw-bold text-primary">
                <i class="bi bi-search me-2"></i>Seleccionar Material para Registrar Movimiento
            </h6>
        </div>
        <div class="card-body">
            <!-- Barra de b√∫squeda -->
            <div class="row g-3 mb-4">
                <div class="col-12">
                    <label class="form-label fw-semibold text-muted mb-1" for="buscarMaterialMovimientos">Buscar Material</label>
                    <div class="input-group input-group-lg flex-nowrap">
                        <span class="input-group-text bg-light border-2 border-primary">
                            <i class="bi bi-search text-primary"></i>
                        </span>
                        <input id="buscarMaterialMovimientos" type="text" class="form-control form-control-lg border-2 border-primary"
                               placeholder="Nombre, c√≥digo, categor√≠a..." aria-label="Buscar material">
                    </div>
                </div>
            </div>
            <!-- Filtros: Categor√≠a -->
            <div class="row g-3 mb-3">
                <div class="col-12">
                    <span class="form-label fw-semibold text-muted d-block mb-2">Categor√≠a</span>
                    <div class="btn-group flex-wrap gap-2" role="group" aria-label="Filtro categor√≠a movimientos">
                        <input type="radio" class="btn-check" name="radioCategoriaMov" id="radioCategoriaMov_none" value="" autocomplete="off" checked>
                        <label class="btn btn-outline-primary" for="radioCategoriaMov_none">Ninguno</label>
                        <th:block th:if="${not #lists.isEmpty(categoriaMateriales)}">
                            <th:block th:each="cat, iter : ${categoriaMateriales}">
                                <input type="radio" class="btn-check" name="radioCategoriaMov"
                                       th:id="${'radioCategoriaMov_' + iter.index}" th:value="${cat.nmbCategoria}" autocomplete="off">
                                <label class="btn btn-outline-primary"
                                       th:for="${'radioCategoriaMov_' + iter.index}" th:text="${cat.nmbCategoria}"
                                       data-bs-toggle="tooltip" data-bs-placement="top"
                                       th:attr="title=${cat.dscCategoria}">
                                </label>
                            </th:block>
                        </th:block>
                    </div>
                </div>
            </div>
            <!-- Filtros: Tipo -->
            <div class="row g-3 mb-4">
                <div class="col-12">
                    <span class="form-label fw-semibold text-muted d-block mb-2">Tipo</span>
                    <div class="btn-group flex-wrap gap-2" role="group" aria-label="Filtro tipo movimientos">
                        <input type="radio" class="btn-check" name="radioTipoMov" id="radioTipoMov_none" value="" autocomplete="off" checked>
                        <label class="btn btn-outline-primary" for="radioTipoMov_none">Ninguno</label>
                        <th:block th:if="${not #lists.isEmpty(tiposMateriales)}">
                            <th:block th:each="tipo, iter : ${tiposMateriales}">
                                <input type="radio" class="btn-check" name="radioTipoMov"
                                       th:id="${'radioTipoMov_' + iter.index}" th:value="${tipo.nmbCategoria}" autocomplete="off">
                                <label class="btn btn-outline-primary"
                                       th:for="${'radioTipoMov_' + iter.index}" th:text="${tipo.nmbCategoria}"
                                       data-bs-toggle="tooltip" data-bs-placement="top"
                                       th:attr="title=${tipo.dscCategoria}">
                                </label>
                            </th:block>
                        </th:block>
                    </div>
                </div>
            </div>
            <!-- Botones de acci√≥n -->
            <div class="row">
                <div class="col-12 d-flex flex-wrap gap-3 justify-content-between align-items-center">
                    <small class="text-muted">Selecciona opcionalmente categor√≠a y tipo o deja "Ninguno" para no filtrar.</small>
                    <div class="d-flex gap-2">
                        <button id="btnBuscarMaterialMov" class="btn btn-primary btn-sm fw-semibold" type="button">
                            <i class="bi bi-search me-1"></i>Buscar
                        </button>
                        <button id="btnLimpiarBusquedaMov" class="btn btn-outline-secondary btn-sm fw-semibold" type="button">
                            <i class="bi bi-eraser me-1"></i>Limpiar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- MODAL: RESULTADOS DE B√öSQUEDA -->
    <div class="modal fade" id="buscarMaterialMovimientosModal" tabindex="-1" aria-labelledby="buscarMaterialMovimientosLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="buscarMaterialMovimientosLabel">
                        <i class="bi bi-search me-2"></i>Selecciona un Material
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info mb-3">
                        <strong>Filtros aplicados:</strong>
                        <div class="mt-2">
                            <span class="badge bg-info-subtle text-info">Texto: <strong id="resumenMaterialTexto">Sin filtro</strong></span>
                            <span class="badge bg-info-subtle text-info ms-2">Categor√≠a: <strong id="resumenMaterialCategoria">Sin filtro</strong></span>
                            <span class="badge bg-info-subtle text-info ms-2">Tipo: <strong id="resumenMaterialTipo">Sin filtro</strong></span>
                        </div>
                    </div>
                    <div id="estadoBusquedaMov" class="text-center text-muted py-4 mb-3">
                        <i class="bi bi-search display-6 d-block mb-2"></i>
                        <p class="mb-0">Buscando materiales...</p>
                    </div>
                    <div id="resultadosBusquedaMov" class="list-group">
                        <!-- Los resultados se renderizar√°n aqu√≠ -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <!-- ACORDE√ìN PRINCIPAL -->
    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="accordion accordion-flush shadow-sm" id="movimientosAccordion">
        <!-- ITEM 1: ENTRADAS DE MATERIAL -->
        <div class="accordion-item border-start border-5 border-success">
            <h2 class="accordion-header" id="headingEntradas">
                <button class="accordion-button fw-bold collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseEntradas">
                    <span class="bg-success p-2 rounded-circle me-3" style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">
                        <i class="bi bi-arrow-down text-white"></i>
                    </span>
                    <span>
                        <span class="fw-bold text-dark d-block">Entradas de Material</span>
                        <small class="text-muted fw-normal">Registra la entrada de materiales reciclables al inventario</small>
                    </span>
                </button>
            </h2>
            <div id="collapseEntradas" class="accordion-collapse collapse" data-bs-parent="#movimientosAccordion">
                <div class="accordion-body p-4 bg-light">
                    <!-- Formulario de entrada -->
                    <div class="card shadow-sm mb-4">
                        <div class="card-header bg-success-subtle border-0 px-4 py-3">
                            <h6 class="mb-0 fw-bold text-success">Registrar Nueva Entrada</h6>
                        </div>
                        <div class="card-body" id="formEntradaContainer" style="display: none;">
                            <form id="formEntrada" class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label fw-semibold small">Material <span class="text-danger">*</span></label>
                                    <input id="entradaMaterialSeleccionado" type="text" class="form-control form-control-sm" readonly required>
                                    <input id="entradaMaterialId" type="hidden">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-semibold small">Tipo</label>
                                    <input id="entradaMaterialTipo" type="text" class="form-control form-control-sm bg-white" readonly>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-semibold small">Categor√≠a</label>
                                    <input id="entradaMaterialCategoria" type="text" class="form-control form-control-sm bg-white" readonly>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-semibold small">Descripci√≥n</label>
                                    <input id="entradaMaterialDescripcion" type="text" class="form-control form-control-sm bg-white" readonly>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-semibold small">Cantidad (kg) <span class="text-danger">*</span></label>
                                    <input id="entradaCantidad" name="cantidad" type="number" step="0.01" min="0" class="form-control form-control-sm" placeholder="0.00" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-semibold small">Fecha <span class="text-danger">*</span></label>
                                    <input type="datetime-local" class="form-control form-control-sm" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-semibold small">Precio de Compra Unitario (COP)</label>
                                    <input type="number" step="0.01" min="0" class="form-control form-control-sm" placeholder="0.00">
                                </div>
                                <div class="col-12">
                                    <label class="form-label fw-semibold small">Observaciones</label>
                                    <textarea class="form-control form-control-sm" rows="2" placeholder="Notas adicionales..."></textarea>
                                </div>
                                <div class="col-12">
                                    <button type="submit" class="btn btn-success btn-sm fw-semibold">
                                        <i class="bi bi-check-circle me-2"></i>Guardar Entrada
                                    </button>
                                    <button type="reset" class="btn btn-outline-secondary btn-sm fw-semibold">
                                        <i class="bi bi-eraser me-2"></i>Limpiar
                                    </button>
                                    <button type="button" class="btn btn-outline-primary btn-sm fw-semibold" onclick="cambiarMaterial()">
                                        <i class="bi bi-arrow-counterclockwise me-2"></i>Cambiar Material
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                    <!-- Filtros -->
                    <div class="card shadow-sm mb-4">
                        <div class="card-header bg-light border-0 px-4 py-3">
                            <h6 class="mb-0 fw-bold text-dark">
                                <i class="bi bi-funnel me-2"></i>Filtros de B√∫squeda
                            </h6>
                        </div>
                        <div class="card-body">
                            <form class="row g-3" id="filtrosFormEntradas">
                                <div class="col-md-3">
                                    <label class="form-label fw-semibold small">Material</label>
                                    <input type="text" class="form-control form-control-sm" placeholder="Buscar material...">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label fw-semibold small">Desde</label>
                                    <input type="date" class="form-control form-control-sm">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label fw-semibold small">Hasta</label>
                                    <input type="date" class="form-control form-control-sm">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label fw-semibold small">&nbsp;</label>
                                    <div class="d-flex gap-2">
                                        <button type="submit" class="btn btn-primary btn-sm fw-semibold flex-grow-1">
                                            <i class="bi bi-search me-1"></i>Filtrar
                                        </button>
                                        <button type="reset" class="btn btn-outline-secondary btn-sm fw-semibold">
                                            <i class="bi bi-arrow-counterclockwise"></i>
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                    <!-- Tabla de entradas -->
                    <div class="card shadow-sm">
                        <div class="card-header bg-light border-0 px-4 py-3 d-flex justify-content-between align-items-center">
                            <h6 class="mb-0 fw-bold text-dark">Historial de Entradas</h6>
                            <span class="badge bg-success rounded-pill" id="badgeEntradasCount">0 registros</span>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-sm table-hover align-middle mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th scope="col" class="fw-bold small">Fecha</th>
                                            <th scope="col" class="fw-bold small">Material</th>
                                            <th scope="col" class="fw-bold small text-end">Cantidad (kg)</th>
                                            <th scope="col" class="fw-bold small text-end">Precio Unit.</th>
                                            <th scope="col" class="fw-bold small">Observaciones</th>
                                        </tr>
                                    </thead>
                                    <tbody class="border-top" id="tablasEntradasBody">
                                        <tr class="text-muted text-center">
                                            <td colspan="5" class="py-3"><small>Sin registros</small></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="card-footer bg-light border-top px-4 py-3">
                            <nav aria-label="Paginaci√≥n entradas">
                                <ul class="pagination pagination-sm mb-0 justify-content-center" id="paginacionEntradas">
                                    <li class="page-item disabled"><a class="page-link" href="#">Anterior</a></li>
                                    <li class="page-item active"><a class="page-link" href="#">1</a></li>
                                    <li class="page-item"><a class="page-link" href="#">Siguiente</a></li>
                                </ul>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- ITEM 2: SALIDAS DE MATERIAL -->
        <div class="accordion-item border-start border-5 border-danger">
            <h2 class="accordion-header" id="headingSalidas">
                <button class="accordion-button fw-bold collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSalidas">
                    <span class="bg-danger p-2 rounded-circle me-3" style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">
                        <i class="bi bi-arrow-up text-white"></i>
                    </span>
                    <span>
                        <span class="fw-bold text-dark d-block">Salidas de Material</span>
                        <small class="text-muted fw-normal">Registra la salida de materiales reciclables del inventario</small>
                    </span>
                </button>
            </h2>
            <div id="collapseSalidas" class="accordion-collapse collapse" data-bs-parent="#movimientosAccordion">
                <div class="accordion-body p-4 bg-light">
                    <!-- Formulario de salida -->
                    <div class="card shadow-sm mb-4">
                        <div class="card-header bg-danger-subtle border-0 px-4 py-3">
                            <h6 class="mb-0 fw-bold text-danger">Registrar Nueva Salida</h6>
                        </div>
                        <div class="card-body" id="formSalidaContainer" style="display: none;">
                            <form id="formSalida" class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label fw-semibold small">Material <span class="text-danger">*</span></label>
                                    <input id="salidaMaterialSeleccionado" type="text" class="form-control form-control-sm" readonly required>
                                    <input id="salidaMaterialId" type="hidden">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-semibold small">Tipo</label>
                                    <input id="salidaMaterialTipo" type="text" class="form-control form-control-sm bg-white" readonly>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-semibold small">Categor√≠a</label>
                                    <input id="salidaMaterialCategoria" type="text" class="form-control form-control-sm bg-white" readonly>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-semibold small">Descripci√≥n</label>
                                    <input id="salidaMaterialDescripcion" type="text" class="form-control form-control-sm bg-white" readonly>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-semibold small">Cantidad (kg) <span class="text-danger">*</span></label>
                                    <input id="salidaCantidad" name="cantidad" type="number" step="0.01" min="0" class="form-control form-control-sm" placeholder="0.00" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-semibold small">Fecha <span class="text-danger">*</span></label>
                                    <input type="datetime-local" class="form-control form-control-sm" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-semibold small">Precio de Venta Unitario (COP)</label>
                                    <input type="number" step="0.01" min="0" class="form-control form-control-sm" placeholder="0.00">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-semibold small">Centro de Acopio</label>
                                    <select class="form-select form-select-sm" required>
                                        <option value="">Selecciona un centro...</option>
                                        <th:block th:if="${not #lists.isEmpty(centrosAcopio)}">
                                            <option th:each="centro : ${centrosAcopio}"
                                                    th:value="${centro.cntAcpId}"
                                                    th:text="${centro.nombreCntAcp}">
                                                Centro de Acopio
                                            </option>
                                        </th:block>
                                        <th:block th:if="${#lists.isEmpty(centrosAcopio)}">
                                            <option disabled>No hay centros disponibles</option>
                                        </th:block>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-semibold small">Observaciones</label>
                                    <input type="text" class="form-control form-control-sm" placeholder="Notas adicionales...">
                                </div>
                                <div class="col-12">
                                    <button type="submit" class="btn btn-danger btn-sm fw-semibold">
                                        <i class="bi bi-check-circle me-2"></i>Guardar Salida
                                    </button>
                                    <button type="reset" class="btn btn-outline-secondary btn-sm fw-semibold">
                                        <i class="bi bi-eraser me-2"></i>Limpiar
                                    </button>
                                    <button type="button" class="btn btn-outline-primary btn-sm fw-semibold" onclick="cambiarMaterial()">
                                        <i class="bi bi-arrow-counterclockwise me-2"></i>Cambiar Material
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                    <!-- Filtros -->
                    <div class="card shadow-sm mb-4">
                        <div class="card-header bg-light border-0 px-4 py-3">
                            <h6 class="mb-0 fw-bold text-dark">
                                <i class="bi bi-funnel me-2"></i>Filtros de B√∫squeda
                            </h6>
                        </div>
                        <div class="card-body">
                            <form class="row g-3" id="filtrosFormSalidas">
                                <div class="col-md-3">
                                    <label class="form-label fw-semibold small">Material</label>
                                    <input type="text" class="form-control form-control-sm" placeholder="Buscar material...">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label fw-semibold small">Desde</label>
                                    <input type="date" class="form-control form-control-sm">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label fw-semibold small">Hasta</label>
                                    <input type="date" class="form-control form-control-sm">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label fw-semibold small">&nbsp;</label>
                                    <div class="d-flex gap-2">
                                        <button type="submit" class="btn btn-primary btn-sm fw-semibold flex-grow-1">
                                            <i class="bi bi-search me-1"></i>Filtrar
                                        </button>
                                        <button type="reset" class="btn btn-outline-secondary btn-sm fw-semibold">
                                            <i class="bi bi-arrow-counterclockwise"></i>
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                    <!-- Tabla de salidas -->
                    <div class="card shadow-sm">
                        <div class="card-header bg-light border-0 px-4 py-3 d-flex justify-content-between align-items-center">
                            <h6 class="mb-0 fw-bold text-dark">Historial de Salidas</h6>
                            <span class="badge bg-danger rounded-pill" id="badgeSalidasCount">0 registros</span>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-sm table-hover align-middle mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th scope="col" class="fw-bold small">Fecha</th>
                                            <th scope="col" class="fw-bold small">Material</th>
                                            <th scope="col" class="fw-bold small text-end">Cantidad (kg)</th>
                                            <th scope="col" class="fw-bold small text-end">Precio Unit.</th>
                                            <th scope="col" class="fw-bold small">Centro Acopio</th>
                                        </tr>
                                    </thead>
                                    <tbody class="border-top" id="tablasSalidasBody">
                                        <tr class="text-muted text-center">
                                            <td colspan="5" class="py-3"><small>Sin registros</small></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="card-footer bg-light border-top px-4 py-3">
                            <nav aria-label="Paginaci√≥n salidas">
                                <ul class="pagination pagination-sm mb-0 justify-content-center" id="paginacionSalidas">
                                    <li class="page-item disabled"><a class="page-link" href="#">Anterior</a></li>
                                    <li class="page-item active"><a class="page-link" href="#">1</a></li>
                                    <li class="page-item"><a class="page-link" href="#">Siguiente</a></li>
                                </ul>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- ITEM 3: HISTORIAL GENERAL -->
        <div class="accordion-item border-start border-5 border-secondary">
            <h2 class="accordion-header" id="headingHistorial">
                <button class="accordion-button fw-bold collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseHistorial">
                    <span class="bg-secondary p-2 rounded-circle me-3" style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">
                        <i class="bi bi-search text-white"></i>
                    </span>
                    <span>
                        <span class="fw-bold text-dark d-block">Historial General de Movimientos</span>
                        <small class="text-muted fw-normal">Busca y filtra todos los movimientos registrados</small>
                    </span>
                </button>
            </h2>
            <div id="collapseHistorial" class="accordion-collapse collapse" data-bs-parent="#movimientosAccordion">
                <div class="accordion-body p-4 bg-light">
                    <!-- Filtros -->
                    <div class="card shadow-sm mb-4">
                        <div class="card-header bg-light border-0 px-4 py-3">
                            <h6 class="mb-0 fw-bold text-dark">
                                <i class="bi bi-funnel me-2"></i>Filtros de B√∫squeda
                            </h6>
                        </div>
                        <div class="card-body">
                            <form class="row g-3" id="filtrosFormHistorial">
                                <div class="col-md-3">
                                    <label class="form-label fw-semibold small">Material</label>
                                    <input type="text" class="form-control form-control-sm" placeholder="Buscar material...">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label fw-semibold small">Tipo de Movimiento</label>
                                    <select class="form-select form-select-sm">
                                        <option value="">Todos</option>
                                        <option value="entrada">Entradas</option>
                                        <option value="salida">Salidas</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label fw-semibold small">Desde</label>
                                    <input type="date" class="form-control form-control-sm">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label fw-semibold small">Hasta</label>
                                    <input type="date" class="form-control form-control-sm">
                                </div>
                                <div class="col-12">
                                    <button type="submit" class="btn btn-primary btn-sm fw-semibold">
                                        <i class="bi bi-search me-2"></i>Buscar
                                    </button>
                                    <button type="reset" class="btn btn-outline-secondary btn-sm fw-semibold">
                                        <i class="bi bi-arrow-counterclockwise me-2"></i>Limpiar
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                    <!-- Tabla general -->
                    <div class="card shadow-sm">
                        <div class="card-header bg-light border-0 px-4 py-3 d-flex justify-content-between align-items-center">
                            <h6 class="mb-0 fw-bold text-dark">Todos los Movimientos</h6>
                            <span class="badge bg-secondary rounded-pill" id="badgeHistorialCount">0 registros</span>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-sm table-hover align-middle mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th scope="col" class="fw-bold small">Fecha</th>
                                            <th scope="col" class="fw-bold small">Tipo</th>
                                            <th scope="col" class="fw-bold small">Material</th>
                                            <th scope="col" class="fw-bold small text-end">Cantidad (kg)</th>
                                            <th scope="col" class="fw-bold small text-end">Precio Unit.</th>
                                            <th scope="col" class="fw-bold small">Detalles</th>
                                        </tr>
                                    </thead>
                                    <tbody class="border-top" id="tablasHistorialBody">
                                        <tr class="text-muted text-center">
                                            <td colspan="6" class="py-4">
                                                <i class="bi bi-inbox"></i>
                                                <p class="mb-0 mt-2">Sin movimientos registrados</p>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="card-footer bg-light border-top px-4 py-3">
                            <nav aria-label="Paginaci√≥n historial">
                                <ul class="pagination pagination-sm mb-0 justify-content-center" id="paginacionHistorial">
                                    <li class="page-item disabled"><a class="page-link" href="#">Anterior</a></li>
                                    <li class="page-item active"><a class="page-link" href="#">1</a></li>
                                    <li class="page-item"><a class="page-link" href="#">Siguiente</a></li>
                                </ul>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- FIN DEL ACORDE√ìN -->

    <!-- SCRIPT INLINE PARA B√öSQUEDA Y SELECCI√ìN DE MATERIALES -->
    <script>
    (function() {
        console.log('üìå Script inline de movimientos ejecut√°ndose...');

        const puntoEcaSection = document.querySelector('section[data-usuario-id]');
        const usuarioId = puntoEcaSection?.dataset.usuarioId;
        const puntoEcaId = puntoEcaSection?.dataset.puntoEcaId;
        const gestor = puntoEcaSection?.dataset.gestor;

        const inputBusqueda = document.getElementById('buscarMaterialMovimientos');
        const btnBuscar = document.getElementById('btnBuscarMaterialMov');
        const btnLimpiar = document.getElementById('btnLimpiarBusquedaMov');
        const modalBusqueda = document.getElementById('buscarMaterialMovimientosModal');
        const resultadosDiv = document.getElementById('resultadosBusquedaMov');
        const estadoDiv = document.getElementById('estadoBusquedaMov');

        console.log('‚úì Variables inicializadas - Usuario:', usuarioId, 'PuntoECA:', puntoEcaId, 'Gestor:', gestor);

        // Funci√≥n para mostrar estado
        function mostrarEstadoBusquedaMov(estado) {
            if (!estadoDiv) return;

            const estados = {
                idle: '<i class="bi bi-search display-6 d-block mb-2"></i><p class="mb-0">Buscando materiales...</p>',
                loading: '<div class="spinner-border spinner-border-sm me-2" role="status"><span class="visually-hidden">Cargando...</span></div><span>Buscando...</span>',
                ready: '',
                error: '<div class="alert alert-danger">Error al cargar los resultados. Intenta nuevamente.</div>'
            };

            estadoDiv.innerHTML = estados[estado] || estados.idle;
            estadoDiv.style.display = estado === 'ready' ? 'none' : 'block';
        }

        // Funci√≥n para actualizar resumen de filtros
        function actualizarResumenFiltros(texto, categoria, tipo) {
            const resumenTexto = document.getElementById('resumenMaterialTexto');
            const resumenCat = document.getElementById('resumenMaterialCategoria');
            const resumenTipo = document.getElementById('resumenMaterialTipo');

            if (resumenTexto) resumenTexto.textContent = texto || 'Sin filtro';
            if (resumenCat) resumenCat.textContent = categoria || 'Sin filtro';
            if (resumenTipo) resumenTipo.textContent = tipo || 'Sin filtro';
        }

        // Funci√≥n para renderizar resultados
        function renderResultadosBusqueda(materiales, opciones = {}) {
            if (!resultadosDiv) return;

            resultadosDiv.innerHTML = '';

            if (opciones.modoCarga) {
                const skeleton = document.createElement('div');
                skeleton.className = 'list-group-item py-3 text-muted d-flex align-items-center gap-3';
                skeleton.innerHTML = '<span class="placeholder col-2"></span><span class="placeholder col-5"></span><span class="placeholder col-3 ms-auto"></span>';
                resultadosDiv.appendChild(skeleton);
                return;
            }

            if (!materiales || materiales.length === 0) {
                const emptyItem = document.createElement('div');
                emptyItem.className = 'list-group-item text-muted text-center py-4';
                emptyItem.textContent = 'Sin resultados disponibles. Ejecuta una b√∫squeda para comenzar.';
                resultadosDiv.appendChild(emptyItem);
                mostrarEstadoBusquedaMov('idle');
                return;
            }

            materiales.forEach(material => {
                const item = document.createElement('button');
                item.type = 'button';
                item.className = 'list-group-item list-group-item-action resultado-material-item d-flex align-items-start gap-3';
                item.dataset.materialId = material.materialId || '';
                item.dataset.nombre = material.nmbMaterial || '';
                item.dataset.descripcion = material.dscMaterial || '';
                item.dataset.tipo = material.nmbTipo || '';
                item.dataset.categoria = material.nmbCategoria || '';
                item.dataset.unidad = material.unidad || '';

                // Crear imagen
                const img = document.createElement('img');
                img.src = material.imagenUrl || '/imagenes/materiales.png';
                img.alt = material.nmbMaterial || 'Imagen material';
                img.className = 'rounded';
                img.style.width = '64px';
                img.style.height = '64px';
                img.style.objectFit = 'cover';
                img.style.flexShrink = '0';

                // Contenido textual
                const content = document.createElement('div');
                content.className = 'flex-grow-1 text-start';

                const title = document.createElement('div');
                title.className = 'fw-semibold';
                title.textContent = material.nmbMaterial || 'Material sin nombre';

                const desc = document.createElement('small');
                desc.className = 'text-muted d-block mb-2';
                desc.textContent = material.dscMaterial || 'Sin descripci√≥n';

                const badges = document.createElement('div');
                const tipoBadge = document.createElement('span');
                tipoBadge.className = 'badge bg-primary me-1';
                tipoBadge.textContent = material.nmbTipo || 'Tipo';
                const catBadge = document.createElement('span');
                catBadge.className = 'badge bg-secondary';
                catBadge.textContent = material.nmbCategoria || 'Categor√≠a';

                badges.appendChild(tipoBadge);
                badges.appendChild(catBadge);

                content.appendChild(title);
                content.appendChild(desc);
                content.appendChild(badges);

                const actionBadge = document.createElement('span');
                actionBadge.className = 'badge bg-primary rounded-pill align-self-start';
                actionBadge.textContent = 'Seleccionar';

                item.appendChild(img);
                item.appendChild(content);
                item.appendChild(actionBadge);

                resultadosDiv.appendChild(item);
            });

            mostrarEstadoBusquedaMov('ready');

            // Manejadores de clic para seleccionar material
            document.querySelectorAll('.resultado-material-item').forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();

                    const materialId = this.dataset.materialId;
                    const materialNombre = this.dataset.nombre;
                    const materialTipo = this.dataset.tipo;
                    const materialCategoria = this.dataset.categoria;
                    const materialDescripcion = this.dataset.descripcion;

                    console.log('üì¶ Material seleccionado:', materialId, '-', materialNombre);

                    // Llenar campos del formulario de entrada
                    const inputEntrada = document.getElementById('entradaMaterialSeleccionado');
                    const idEntrada = document.getElementById('entradaMaterialId');
                    const tipoEntrada = document.getElementById('entradaMaterialTipo');
                    const categoriaEntrada = document.getElementById('entradaMaterialCategoria');
                    const descripcionEntrada = document.getElementById('entradaMaterialDescripcion');

                    if (inputEntrada) inputEntrada.value = materialNombre;
                    if (idEntrada) idEntrada.value = materialId;
                    if (tipoEntrada) tipoEntrada.value = materialTipo;
                    if (categoriaEntrada) categoriaEntrada.value = materialCategoria;
                    if (descripcionEntrada) descripcionEntrada.value = materialDescripcion;

                    // Llenar campos del formulario de salida
                    const inputSalida = document.getElementById('salidaMaterialSeleccionado');
                    const idSalida = document.getElementById('salidaMaterialId');
                    const tipoSalida = document.getElementById('salidaMaterialTipo');
                    const categoriaSalida = document.getElementById('salidaMaterialCategoria');
                    const descripcionSalida = document.getElementById('salidaMaterialDescripcion');

                    if (inputSalida) inputSalida.value = materialNombre;
                    if (idSalida) idSalida.value = materialId;
                    if (tipoSalida) tipoSalida.value = materialTipo;
                    if (categoriaSalida) categoriaSalida.value = materialCategoria;
                    if (descripcionSalida) descripcionSalida.value = materialDescripcion;

                    // Mostrar ambos formularios (entrada y salida)
                    const formEntradaContainer = document.getElementById('formEntradaContainer');
                    const formSalidaContainer = document.getElementById('formSalidaContainer');
                    if (formEntradaContainer) formEntradaContainer.style.display = 'block';
                    if (formSalidaContainer) formSalidaContainer.style.display = 'block';

                    // Ocultar secci√≥n de b√∫squeda de material
                    const seccionBusquedaMaterial = document.getElementById('seccionBusquedaMaterial');
                    if (seccionBusquedaMaterial) seccionBusquedaMaterial.style.display = 'none';

                    // Expandir ambas secciones del acorde√≥n
                    const collapseEntradas = document.getElementById('collapseEntradas');
                    const collapseSalidas = document.getElementById('collapseSalidas');
                    if (collapseEntradas) {
                        collapseEntradas.classList.add('show');
                        collapseEntradas.setAttribute('aria-expanded', 'true');
                        const buttonEntradas = document.querySelector('[data-bs-target="#collapseEntradas"]');
                        if (buttonEntradas) buttonEntradas.classList.remove('collapsed');
                    }
                    if (collapseSalidas) {
                        collapseSalidas.classList.add('show');
                        collapseSalidas.setAttribute('aria-expanded', 'true');
                        const buttonSalidas = document.querySelector('[data-bs-target="#collapseSalidas"]');
                        if (buttonSalidas) buttonSalidas.classList.remove('collapsed');
                    }

                    // Mostrar mensaje de √©xito mejorado
                    const respuestaDiv = document.createElement('div');
                    respuestaDiv.className = 'alert alert-success alert-dismissible fade show';
                    respuestaDiv.innerHTML = `
                        <div class="d-flex align-items-center">
                            <i class="bi bi-check-circle me-2" style="font-size: 1.2rem;"></i>
                            <div>
                                <strong>¬°Material agregado!</strong>
                                <div class="small">El material "<strong>${materialNombre}</strong>" ha sido cargado. Ahora puedes registrar una <strong>entrada</strong> o una <strong>salida</strong> de este material.</div>
                            </div>
                        </div>
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button>
                    `;

                    const formEntrada = document.getElementById('formEntrada');
                    if (formEntrada && formEntrada.parentNode) {
                        formEntrada.parentNode.insertBefore(respuestaDiv, formEntrada);
                    }

                    // Cerrar modal
                    const modalInstance = bootstrap.Modal.getInstance(modalBusqueda);
                    if (modalInstance) {
                        modalInstance.hide();
                    }

                    console.log('‚úì Material cargado en ambos formularios');
                });
            });
        }

        // Funci√≥n para buscar materiales
        function buscarMateriales() {
            const texto = inputBusqueda?.value || '';
            const categoria = document.querySelector('input[name="radioCategoriaMov"]:checked')?.value || '';
            const tipo = document.querySelector('input[name="radioTipoMov"]:checked')?.value || '';

            console.log('üîç Buscando con:', { texto, categoria, tipo });

            mostrarEstadoBusquedaMov('loading');
            actualizarResumenFiltros(texto, categoria, tipo);

            // Llamar al endpoint del controller
            const url = `/punto-eca/catalogo/inventario/materiales/buscar?` +
                        `puntoId=${puntoEcaId}&texto=${encodeURIComponent(texto)}&categoria=${encodeURIComponent(categoria)}&tipo=${encodeURIComponent(tipo)}`;

            fetch(url)
                .then(response => {
                    if (!response.ok) throw new Error('Error en la b√∫squeda');
                    return response.json();
                })
                .then(data => {
                    console.log('‚úì Resultados recibidos:', data);
                    renderResultadosBusqueda(data);
                })
                .catch(error => {
                    console.error('‚úó Error:', error);
                    mostrarEstadoBusquedaMov('error');
                });
        }

        // Event listeners
        if (btnBuscar) {
            btnBuscar.addEventListener('click', function() {
                console.log('‚úì Bot√≥n Buscar clickeado');
                buscarMateriales();
                const modal = new bootstrap.Modal(modalBusqueda);
                modal.show();
            });
        }

        if (btnLimpiar) {
            btnLimpiar.addEventListener('click', function() {
                console.log('‚úì Bot√≥n Limpiar clickeado');
                if (inputBusqueda) inputBusqueda.value = '';
                document.querySelectorAll('input[name="radioCategoriaMov"]').forEach(r => r.checked = r.id.includes('none'));
                document.querySelectorAll('input[name="radioTipoMov"]').forEach(r => r.checked = r.id.includes('none'));
                if (resultadosDiv) resultadosDiv.innerHTML = '';
                mostrarEstadoBusquedaMov('idle');
            });
        }

        // Mostrar estado inicial
        mostrarEstadoBusquedaMov('idle');
        console.log('‚úì Script de movimientos inicializado');

        // Funci√≥n para cambiar el material seleccionado
        window.cambiarMaterial = function() {
            console.log('üîÑ Cambiando material...');

            // Limpiar campos del formulario de entrada
            const inputEntrada = document.getElementById('entradaMaterialSeleccionado');
            const idEntrada = document.getElementById('entradaMaterialId');
            const tipoEntrada = document.getElementById('entradaMaterialTipo');
            const categoriaEntrada = document.getElementById('entradaMaterialCategoria');
            const descripcionEntrada = document.getElementById('entradaMaterialDescripcion');

            if (inputEntrada) inputEntrada.value = '';
            if (idEntrada) idEntrada.value = '';
            if (tipoEntrada) tipoEntrada.value = '';
            if (categoriaEntrada) categoriaEntrada.value = '';
            if (descripcionEntrada) descripcionEntrada.value = '';

            // Limpiar campos del formulario de salida
            const inputSalida = document.getElementById('salidaMaterialSeleccionado');
            const idSalida = document.getElementById('salidaMaterialId');
            const tipoSalida = document.getElementById('salidaMaterialTipo');
            const categoriaSalida = document.getElementById('salidaMaterialCategoria');
            const descripcionSalida = document.getElementById('salidaMaterialDescripcion');

            if (inputSalida) inputSalida.value = '';
            if (idSalida) idSalida.value = '';
            if (tipoSalida) tipoSalida.value = '';
            if (categoriaSalida) categoriaSalida.value = '';
            if (descripcionSalida) descripcionSalida.value = '';

            // Limpiar alertas de √©xito anterior
            const alertas = document.querySelectorAll('.alert-success');
            alertas.forEach(alerta => alerta.remove());

            // Ocultar formularios de entrada y salida
            const formEntradaContainer = document.getElementById('formEntradaContainer');
            const formSalidaContainer = document.getElementById('formSalidaContainer');
            if (formEntradaContainer) formEntradaContainer.style.display = 'none';
            if (formSalidaContainer) formSalidaContainer.style.display = 'none';

            // Contraer secciones del acorde√≥n
            const collapseEntradas = document.getElementById('collapseEntradas');
            const collapseSalidas = document.getElementById('collapseSalidas');
            if (collapseEntradas) {
                collapseEntradas.classList.remove('show');
                collapseEntradas.setAttribute('aria-expanded', 'false');
                const buttonEntradas = document.querySelector('[data-bs-target="#collapseEntradas"]');
                if (buttonEntradas) buttonEntradas.classList.add('collapsed');
            }
            if (collapseSalidas) {
                collapseSalidas.classList.remove('show');
                collapseSalidas.setAttribute('aria-expanded', 'false');
                const buttonSalidas = document.querySelector('[data-bs-target="#collapseSalidas"]');
                if (buttonSalidas) buttonSalidas.classList.add('collapsed');
            }

            // Mostrar secci√≥n de b√∫squeda nuevamente
            const seccionBusquedaMaterial = document.getElementById('seccionBusquedaMaterial');
            if (seccionBusquedaMaterial) seccionBusquedaMaterial.style.display = 'block';

            // Limpiar b√∫squeda anterior
            if (inputBusqueda) inputBusqueda.value = '';
            document.querySelectorAll('input[name="radioCategoriaMov"]').forEach(r => r.checked = r.id.includes('none'));
            document.querySelectorAll('input[name="radioTipoMov"]').forEach(r => r.checked = r.id.includes('none'));
            const resultadosDiv = document.getElementById('resultadosBusquedaMov');
            if (resultadosDiv) resultadosDiv.innerHTML = '';
            mostrarEstadoBusquedaMov('idle');

            console.log('‚úì Material cambiado, secci√≥n de b√∫squeda mostrada nuevamente');
        };
    })();
    </script>

    <!-- SCRIPT PARA CARGAR DATOS INICIALES DE ENTRADAS Y SALIDAS -->
    <script th:inline="javascript">
    (function() {
        console.log('üìå Inicializando carga de datos de movimientos...');

        // Datos de entradas (compras) - Inyectados desde Thymeleaf
        const entradasData = /*[[${entradasIniciales.content}]]*/ [];

        // Datos de salidas (ventas) - Inyectados desde Thymeleaf
        const salidasData = /*[[${salidasIniciales.content}]]*/ [];

        console.log('üìä Entradas cargadas:', entradasData.length, entradasData);
        console.log('üìä Salidas cargadas:', salidasData.length, salidasData);

        // Renderizar entradas
        function renderizarEntradas() {
            const tbody = document.getElementById('tablasEntradasBody');
            if (!tbody) {
                console.warn('‚ö†Ô∏è No se encontr√≥ tbody tablasEntradasBody');
                return;
            }

            if (!entradasData || entradasData.length === 0) {
                tbody.innerHTML = '<tr class="text-muted text-center"><td colspan="5" class="py-3"><small>Sin registros</small></td></tr>';
                document.getElementById('badgeEntradasCount').textContent = '0 registros';
                return;
            }

            tbody.innerHTML = entradasData.map(entrada => {
                const fecha = entrada.fechaCompra ? new Date(entrada.fechaCompra).toLocaleDateString('es-CO') : '-';
                const cantidad = parseFloat(entrada.cantidad || 0);
                const precio = parseFloat(entrada.precioCompra || 0);
                return `
                    <tr>
                        <td class="small">${fecha}</td>
                        <td class="small">${entrada.nombreMaterial || '-'}</td>
                        <td class="text-end small">${cantidad.toLocaleString('es-CO', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                        <td class="text-end small">$${precio.toLocaleString('es-CO', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                        <td class="small">${entrada.observaciones || '-'}</td>
                    </tr>
                `;
            }).join('');

            document.getElementById('badgeEntradasCount').textContent = entradasData.length + ' registros';
            console.log('‚úÖ Tabla de entradas renderizada');
        }

        // Renderizar salidas
        function renderizarSalidas() {
            const tbody = document.getElementById('tablasSalidasBody');
            if (!tbody) {
                console.warn('‚ö†Ô∏è No se encontr√≥ tbody tablasSalidasBody');
                return;
            }

            if (!salidasData || salidasData.length === 0) {
                tbody.innerHTML = '<tr class="text-muted text-center"><td colspan="5" class="py-3"><small>Sin registros</small></td></tr>';
                document.getElementById('badgeSalidasCount').textContent = '0 registros';
                return;
            }

            tbody.innerHTML = salidasData.map(salida => {
                const fecha = salida.fechaVenta ? new Date(salida.fechaVenta).toLocaleDateString('es-CO') : '-';
                const cantidad = parseFloat(salida.cantidad || 0);
                const precio = parseFloat(salida.precioVenta || 0);
                return `
                    <tr>
                        <td class="small">${fecha}</td>
                        <td class="small">${salida.nombreMaterial || '-'}</td>
                        <td class="text-end small">${cantidad.toLocaleString('es-CO', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                        <td class="text-end small">$${precio.toLocaleString('es-CO', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                        <td class="small">${salida.nombreCentroAcopio || '-'}</td>
                    </tr>
                `;
            }).join('');

            document.getElementById('badgeSalidasCount').textContent = salidasData.length + ' registros';
            console.log('‚úÖ Tabla de salidas renderizada');
        }

        // Inicializar cuando el DOM est√© listo
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                console.log('‚úÖ DOM cargado, renderizando...');
                renderizarEntradas();
                renderizarSalidas();
            });
        } else {
            console.log('‚úÖ DOM ya cargado, renderizando...');
            renderizarEntradas();
            renderizarSalidas();
        }
    })();
    </script>
</section>
