<!-- Fragment: Movimientos -->
<section th:fragment="movimientos" class="py-4"
         th:data-gestor="${gestor}"
         th:data-usuario-id="${usuario.usuarioId}"
         th:data-punto-eca-id="${puntoEcaId}">
    <!-- Título principal -->
    <div class="mb-4">
        <h2 class="h4 fw-bold text-dark mb-1">
            <i class="bi bi-arrow-left-right me-2"></i>Gestión de Movimientos de Inventario
        </h2>
        <p class="text-muted small mb-0">Registra y consulta entradas y salidas de materiales en el centro de acopio</p>
    </div>
    <!-- ═════════════════════════════════════════════════════════════ -->
    <!-- SECCIÓN 1: BARRA DE BÚSQUEDA Y SELECCIÓN DE MATERIAL -->
    <!-- ═════════════════════════════════════════════════════════════ -->
    <div class="card shadow-sm mb-4" id="seccionBusquedaMaterial">
        <div class="card-header bg-primary-subtle border-0 px-4 py-3">
            <h6 class="mb-0 fw-bold text-primary">
                <i class="bi bi-search me-2"></i>Seleccionar Material para Registrar Movimiento
            </h6>
        </div>
        <div class="card-body">
            <!-- Barra de búsqueda con Select2 -->
            <div class="row g-3 mb-4">
                <div class="col-12">
                    <label class="form-label fw-semibold text-muted mb-1" for="buscarMaterialMovimientos">Buscar Material</label>
                    <select id="buscarMaterialMovimientos" class="form-control js-example-tags form-control-lg border-2 border-primary"
                            style="width: 100%;" aria-label="Buscar material">
                        <option></option>
                    </select>
                </div>
            </div>
            <!-- Filtros: Categoría, Tipo y Botones en una fila -->
            <div class="row g-3 align-items-end mb-3">
                <div class="col-md-4">
                    <label class="form-label fw-semibold text-muted mb-1" for="selectCategoriaMov">Categoría</label>
                    <select id="selectCategoriaMov" class="form-select border-2 border-primary js-select2-categoria-mov" style="width: 100%;">
                        <option value="">-- Ninguno --</option>
                        <th:block th:if="${not #lists.isEmpty(categoriaMateriales)}">
                            <option th:each="cat : ${categoriaMateriales}"
                                    th:value="${cat.nmbCategoria}"
                                    th:text="${cat.nmbCategoria}">
                                Categoría
                            </option>
                        </th:block>
                    </select>
                </div>

                <div class="col-md-4">
                    <label class="form-label fw-semibold text-muted mb-1" for="selectTipoMov">Tipo</label>
                    <select id="selectTipoMov" class="form-select border-2 border-primary js-select2-tipo-mov" style="width: 100%;">
                        <option value="">-- Ninguno --</option>
                        <th:block th:if="${not #lists.isEmpty(tiposMateriales)}">
                            <option th:each="tipo : ${tiposMateriales}"
                                    th:value="${tipo.nmbCategoria}"
                                    th:text="${tipo.nmbCategoria}">
                                Tipo
                            </option>
                        </th:block>
                    </select>
                </div>

                <div class="col-md-4">
                    <div class="d-flex gap-2">
                        <!-- Botón Buscar eliminado: la búsqueda se hace automáticamente con Select2 y filtros -->
                        <button id="btnLimpiarBusquedaMov" class="btn btn-outline-secondary flex-grow-1 fw-semibold" type="button">
                            <i class="bi bi-eraser me-1"></i>Limpiar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- MODAL: RESULTADOS DE BÚSQUEDA -->
    <div class="modal fade" id="buscarMaterialMovimientosModal" tabindex="-1" aria-labelledby="buscarMaterialMovimientosLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="buscarMaterialMovimientosLabel">
                        <i class="bi bi-search me-2"></i>Selecciona un Material
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info mb-3">
                        <strong>Filtros aplicados:</strong>
                        <div class="mt-2">
                            <span class="badge bg-info-subtle text-info">Texto: <strong id="resumenMaterialTexto">Sin filtro</strong></span>
                            <span class="badge bg-info-subtle text-info ms-2">Categoría: <strong id="resumenMaterialCategoria">Sin filtro</strong></span>
                            <span class="badge bg-info-subtle text-info ms-2">Tipo: <strong id="resumenMaterialTipo">Sin filtro</strong></span>
                        </div>
                    </div>
                    <div id="estadoBusquedaMov" class="text-center text-muted py-4 mb-3">
                        <i class="bi bi-search display-6 d-block mb-2"></i>
                        <p class="mb-0">Buscando materiales...</p>
                    </div>
                    <div id="resultadosBusquedaMov" class="list-group">
                        <!-- Los resultados se renderizarán aquí -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- ═════════════════════════════════════════════════════════════ -->
    <!-- ACORDEÓN PRINCIPAL -->
    <!-- ═════════════════════════════════════════════════════════════ -->
    <div class="accordion accordion-flush shadow-sm" id="movimientosAccordion">
        <!-- ITEM 1: ENTRADAS DE MATERIAL -->
        <div class="accordion-item border-start border-5 border-success">
            <h2 class="accordion-header" id="headingEntradas">
                <button class="accordion-button fw-bold collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseEntradas">
                    <span class="bg-success p-2 rounded-circle me-3" style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">
                        <i class="bi bi-arrow-down text-white"></i>
                    </span>
                    <span>
                        <span class="fw-bold text-dark d-block">Entradas de Material</span>
                        <small class="text-muted fw-normal">Registra la entrada de materiales reciclables al inventario</small>
                    </span>
                </button>
            </h2>
            <div id="collapseEntradas" class="accordion-collapse collapse" data-bs-parent="#movimientosAccordion">
                <div class="accordion-body p-4 bg-light">
                    <!-- Formulario de entrada -->
                    <div class="card shadow-sm mb-4">
                        <div class="card-header bg-success-subtle border-0 px-4 py-3">
                            <h6 class="mb-0 fw-bold text-success">Registrar Nueva Entrada</h6>
                        </div>
                        <div class="card-body" id="formEntradaContainer" style="display: none;">
                            <form id="formEntrada" class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label fw-semibold small">Material <span class="text-danger">*</span></label>
                                    <input id="entradaMaterialSeleccionado" type="text" class="form-control form-control-sm" readonly required>
                                    <input id="entradaMaterialId" type="hidden">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-semibold small">Tipo</label>
                                    <input id="entradaMaterialTipo" type="text" class="form-control form-control-sm bg-light" readonly>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-semibold small">Categoría</label>
                                    <input id="entradaMaterialCategoria" type="text" class="form-control form-control-sm bg-light" readonly>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-semibold small">Descripción</label>
                                    <input id="entradaMaterialDescripcion" type="text" class="form-control form-control-sm bg-light" readonly>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-semibold small">Unidad de Medida</label>
                                    <input id="entradaMaterialUnidad" type="text" class="form-control form-control-sm bg-light" readonly>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-semibold small">Stock Actual</label>
                                    <input id="entradaStockActual" type="number" step="0.01" class="form-control form-control-sm bg-light" readonly>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-semibold small">Capacidad Máxima</label>
                                    <input id="entradaCapacidadMaxima" type="number" step="0.01" class="form-control form-control-sm bg-light" readonly>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-semibold small">Cantidad a Agregar (kg) <span class="text-danger">*</span></label>
                                    <input id="entradaCantidad" name="cantidad" type="number" step="0.01" min="0" class="form-control form-control-sm border-primary border-2" placeholder="0.00" required>
                                    <small class="text-muted d-block mt-1">Stock después: <strong id="entradaStockResultante">-</strong></small>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-semibold small">Fecha <span class="text-danger">*</span></label>
                                    <input id="entradaFecha" type="datetime-local" class="form-control form-control-sm border-primary border-2" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-semibold small">Precio de Compra Unitario (COP) <span class="text-danger">*</span></label>
                                    <input id="entradaPrecioCompra" type="number" step="0.01" min="0" class="form-control form-control-sm border-primary border-2" placeholder="0.00" required>
                                </div>
                                <div class="col-12">
                                    <label class="form-label fw-semibold small">Observaciones</label>
                                    <textarea id="entradaObservaciones" class="form-control form-control-sm border-primary border-2" rows="2" placeholder="Notas adicionales..."></textarea>
                                </div>
                                <div class="col-12">
                                    <button type="submit" class="btn btn-success btn-sm fw-semibold">
                                        <i class="bi bi-check-circle me-2"></i>Guardar Entrada
                                    </button>
                                    <button type="button" class="btn btn-outline-primary btn-sm fw-semibold" onclick="cambiarMaterial()">
                                        <i class="bi bi-arrow-counterclockwise me-2"></i>Cambiar Material
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                    <!-- Filtros -->
                    <div class="card shadow-sm mb-4">
                        <div class="card-header bg-light border-0 px-4 py-3">
                            <h6 class="mb-0 fw-bold text-dark">
                                <i class="bi bi-funnel me-2"></i>Filtros de Búsqueda
                            </h6>
                        </div>
                        <div class="card-body">
                            <form class="row g-3" id="filtrosFormEntradas">
                                <div class="col-md-3">
                                    <label class="form-label fw-semibold small">Material</label>
                                    <input type="text" class="form-control form-control-sm" placeholder="Buscar material...">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label fw-semibold small">Desde</label>
                                    <input type="date" class="form-control form-control-sm">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label fw-semibold small">Hasta</label>
                                    <input type="date" class="form-control form-control-sm">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label fw-semibold small">&nbsp;</label>
                                    <div class="d-flex gap-2">
                                        <button type="submit" class="btn btn-primary btn-sm fw-semibold flex-grow-1">
                                            <i class="bi bi-search me-1"></i>Filtrar
                                        </button>
                                        <button type="reset" class="btn btn-outline-secondary btn-sm fw-semibold">
                                            <i class="bi bi-arrow-counterclockwise"></i>
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                    <!-- Tabla de entradas -->
                    <div class="card shadow-sm">
                        <div class="card-header bg-light border-0 px-4 py-3 d-flex justify-content-between align-items-center">
                            <h6 class="mb-0 fw-bold text-dark">Historial de Entradas</h6>
                            <span class="badge bg-success rounded-pill" id="badgeEntradasCount">0 registros</span>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-sm table-hover align-middle mb-0">
                                    <thead class="table-light">
                                    <tr>
                                        <th scope="col" class="fw-bold small">Fecha</th>
                                        <th scope="col" class="fw-bold small">Material</th>
                                        <th scope="col" class="fw-bold small text-end">Cantidad (kg)</th>
                                        <th scope="col" class="fw-bold small text-end">Precio Unit.</th>
                                        <th scope="col" class="fw-bold small">Observaciones</th>
                                    </tr>
                                    </thead>
                                    <tbody class="border-top" id="tablasEntradasBody">
                                    <tr class="text-muted text-center">
                                        <td colspan="5" class="py-3"><small>Sin registros</small></td>
                                    </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="card-footer bg-light border-top px-4 py-3">
                            <nav aria-label="Paginación entradas">
                                <ul class="pagination pagination-sm mb-0 justify-content-center" id="paginacionEntradas">
                                    <li class="page-item disabled"><a class="page-link" href="#">Anterior</a></li>
                                    <li class="page-item active"><a class="page-link" href="#">1</a></li>
                                    <li class="page-item"><a class="page-link" href="#">Siguiente</a></li>
                                </ul>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- ITEM 2: SALIDAS DE MATERIAL -->
        <div class="accordion-item border-start border-5 border-danger">
            <h2 class="accordion-header" id="headingSalidas">
                <button class="accordion-button fw-bold collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSalidas">
                    <span class="bg-danger p-2 rounded-circle me-3" style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">
                        <i class="bi bi-arrow-up text-white"></i>
                    </span>
                    <span>
                        <span class="fw-bold text-dark d-block">Salidas de Material</span>
                        <small class="text-muted fw-normal">Registra la salida de materiales reciclables del inventario</small>
                    </span>
                </button>
            </h2>
            <div id="collapseSalidas" class="accordion-collapse collapse" data-bs-parent="#movimientosAccordion">
                <div class="accordion-body p-4 bg-light">
                    <!-- Formulario de salida -->
                    <div class="card shadow-sm mb-4">
                        <div class="card-header bg-danger-subtle border-0 px-4 py-3">
                            <h6 class="mb-0 fw-bold text-danger">Registrar Nueva Salida</h6>
                        </div>
                        <div class="card-body" id="formSalidaContainer" style="display: none;">
                            <form id="formSalida" class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label fw-semibold small">Material <span class="text-danger">*</span></label>
                                    <input id="salidaMaterialSeleccionado" type="text" class="form-control form-control-sm" readonly required>
                                    <input id="salidaMaterialId" type="hidden">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-semibold small">Tipo</label>
                                    <input id="salidaMaterialTipo" type="text" class="form-control form-control-sm bg-light" readonly>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-semibold small">Categoría</label>
                                    <input id="salidaMaterialCategoria" type="text" class="form-control form-control-sm bg-light" readonly>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-semibold small">Descripción</label>
                                    <input id="salidaMaterialDescripcion" type="text" class="form-control form-control-sm bg-light" readonly>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-semibold small">Unidad de Medida</label>
                                    <input id="salidaMaterialUnidad" type="text" class="form-control form-control-sm bg-light" readonly>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-semibold small">Stock Actual (NO EDITABLE)</label>
                                    <input id="salidaStockActual" type="number" step="0.01" class="form-control form-control-sm bg-secondary bg-opacity-10" readonly>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-semibold small">Capacidad Máxima</label>
                                    <input id="salidaCapacidadMaxima" type="number" step="0.01" class="form-control form-control-sm bg-light" readonly>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-semibold small">Cantidad a Descontar (kg) <span class="text-danger">*</span></label>
                                    <input id="salidaCantidad" name="cantidad" type="number" step="0.01" min="0" class="form-control form-control-sm border-danger border-2" placeholder="0.00" required>
                                    <small class="text-muted d-block mt-1">Stock restante: <strong id="salidaStockRestante" class="text-danger">-</strong></small>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-semibold small">Fecha <span class="text-danger">*</span></label>
                                    <input id="salidaFecha" type="datetime-local" class="form-control form-control-sm border-danger border-2" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-semibold small">Precio de Venta Unitario (COP) <span class="text-danger">*</span></label>
                                    <input id="salidaPrecioVenta" type="number" step="0.01" min="0" class="form-control form-control-sm border-danger border-2" placeholder="0.00" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-semibold small">Centro de Acopio</label>
                                    <select id="salidaCentroAcopio" class="form-select form-select-sm border-danger border-2" required>
                                        <option value="">Selecciona un centro...</option>
                                        <th:block th:if="${not #lists.isEmpty(centrosAcopio)}">
                                            <option th:each="centro : ${centrosAcopio}"
                                                    th:value="${centro.cntAcpId}"
                                                    th:text="${centro.nombreCntAcp}">
                                                Centro de Acopio
                                            </option>
                                        </th:block>
                                        <th:block th:if="${#lists.isEmpty(centrosAcopio)}">
                                            <option disabled>No hay centros disponibles</option>
                                        </th:block>
                                    </select>
                                </div>
                                <div class="col-12">
                                    <label class="form-label fw-semibold small">Observaciones</label>
                                    <textarea id="salidaObservaciones" class="form-control form-control-sm border-danger border-2" rows="2" placeholder="Notas adicionales..."></textarea>
                                </div>
                                <div class="col-12">
                                    <button type="submit" class="btn btn-danger btn-sm fw-semibold">
                                        <i class="bi bi-check-circle me-2"></i>Guardar Salida
                                    </button>
                                    <button type="button" class="btn btn-outline-primary btn-sm fw-semibold" onclick="cambiarMaterial()">
                                        <i class="bi bi-arrow-counterclockwise me-2"></i>Cambiar Material
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                    <!-- Filtros -->
                    <div class="card shadow-sm mb-4">
                        <div class="card-header bg-light border-0 px-4 py-3">
                            <h6 class="mb-0 fw-bold text-dark">
                                <i class="bi bi-funnel me-2"></i>Filtros de Búsqueda
                            </h6>
                        </div>
                        <div class="card-body">
                            <form class="row g-3" id="filtrosFormSalidas">
                                <div class="col-md-3">
                                    <label class="form-label fw-semibold small">Material</label>
                                    <input type="text" class="form-control form-control-sm" placeholder="Buscar material...">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label fw-semibold small">Desde</label>
                                    <input type="date" class="form-control form-control-sm">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label fw-semibold small">Hasta</label>
                                    <input type="date" class="form-control form-control-sm">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label fw-semibold small">&nbsp;</label>
                                    <div class="d-flex gap-2">
                                        <button type="submit" class="btn btn-primary btn-sm fw-semibold flex-grow-1">
                                            <i class="bi bi-search me-1"></i>Filtrar
                                        </button>
                                        <button type="reset" class="btn btn-outline-secondary btn-sm fw-semibold">
                                            <i class="bi bi-arrow-counterclockwise"></i>
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                    <!-- Tabla de salidas -->
                    <div class="card shadow-sm">
                        <div class="card-header bg-light border-0 px-4 py-3 d-flex justify-content-between align-items-center">
                            <h6 class="mb-0 fw-bold text-dark">Historial de Salidas</h6>
                            <span class="badge bg-danger rounded-pill" id="badgeSalidasCount">0 registros</span>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-sm table-hover align-middle mb-0">
                                    <thead class="table-light">
                                    <tr>
                                        <th scope="col" class="fw-bold small">Fecha</th>
                                        <th scope="col" class="fw-bold small">Material</th>
                                        <th scope="col" class="fw-bold small text-end">Cantidad (kg)</th>
                                        <th scope="col" class="fw-bold small text-end">Precio Unit.</th>
                                        <th scope="col" class="fw-bold small">Centro Acopio</th>
                                    </tr>
                                    </thead>
                                    <tbody class="border-top" id="tablasSalidasBody">
                                    <tr class="text-muted text-center">
                                        <td colspan="5" class="py-3"><small>Sin registros</small></td>
                                    </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="card-footer bg-light border-top px-4 py-3">
                            <nav aria-label="Paginación salidas">
                                <ul class="pagination pagination-sm mb-0 justify-content-center" id="paginacionSalidas">
                                    <li class="page-item disabled"><a class="page-link" href="#">Anterior</a></li>
                                    <li class="page-item active"><a class="page-link" href="#">1</a></li>
                                    <li class="page-item"><a class="page-link" href="#">Siguiente</a></li>
                                </ul>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- ITEM 3: HISTORIAL GENERAL -->
        <div class="accordion-item border-start border-5 border-secondary">
            <h2 class="accordion-header" id="headingHistorial">
                <button class="accordion-button fw-bold collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseHistorial">
                    <span class="bg-secondary p-2 rounded-circle me-3" style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">
                        <i class="bi bi-search text-white"></i>
                    </span>
                    <span>
                        <span class="fw-bold text-dark d-block">Historial General de Movimientos</span>
                        <small class="text-muted fw-normal">Busca y filtra todos los movimientos registrados</small>
                    </span>
                </button>
            </h2>
            <div id="collapseHistorial" class="accordion-collapse collapse" data-bs-parent="#movimientosAccordion">
                <div class="accordion-body p-4 bg-light">
                    <!-- Filtros -->
                    <div class="card shadow-sm mb-4">
                        <div class="card-header bg-light border-0 px-4 py-3">
                            <h6 class="mb-0 fw-bold text-dark">
                                <i class="bi bi-funnel me-2"></i>Filtros de Búsqueda
                            </h6>
                        </div>
                        <div class="card-body">
                            <form class="row g-3" id="filtrosFormHistorial">
                                <div class="col-md-3">
                                    <label class="form-label fw-semibold small">Material</label>
                                    <input type="text" class="form-control form-control-sm" placeholder="Buscar material...">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label fw-semibold small">Tipo de Movimiento</label>
                                    <select class="form-select form-select-sm">
                                        <option value="">Todos</option>
                                        <option value="entrada">Entradas</option>
                                        <option value="salida">Salidas</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label fw-semibold small">Desde</label>
                                    <input type="date" class="form-control form-control-sm">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label fw-semibold small">Hasta</label>
                                    <input type="date" class="form-control form-control-sm">
                                </div>
                                <div class="col-12">
                                    <button type="submit" class="btn btn-primary btn-sm fw-semibold">
                                        <i class="bi bi-search me-2"></i>Buscar
                                    </button>
                                    <button type="reset" class="btn btn-outline-secondary btn-sm fw-semibold">
                                        <i class="bi bi-arrow-counterclockwise me-2"></i>Limpiar
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                    <!-- Tabla general -->
                    <div class="card shadow-sm">
                        <div class="card-header bg-light border-0 px-4 py-3 d-flex justify-content-between align-items-center">
                            <h6 class="mb-0 fw-bold text-dark">Todos los Movimientos</h6>
                            <span class="badge bg-secondary rounded-pill" id="badgeHistorialCount">0 registros</span>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-sm table-hover align-middle mb-0">
                                    <thead class="table-light">
                                    <tr>
                                        <th scope="col" class="fw-bold small">Fecha</th>
                                        <th scope="col" class="fw-bold small">Tipo</th>
                                        <th scope="col" class="fw-bold small">Material</th>
                                        <th scope="col" class="fw-bold small text-end">Cantidad (kg)</th>
                                        <th scope="col" class="fw-bold small text-end">Precio Unit.</th>
                                        <th scope="col" class="fw-bold small">Detalles</th>
                                    </tr>
                                    </thead>
                                    <tbody class="border-top" id="tablasHistorialBody">
                                    <tr class="text-muted text-center">
                                        <td colspan="6" class="py-4">
                                            <i class="bi bi-inbox"></i>
                                            <p class="mb-0 mt-2">Sin movimientos registrados</p>
                                        </td>
                                    </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="card-footer bg-light border-top px-4 py-3">
                            <nav aria-label="Paginación historial">
                                <ul class="pagination pagination-sm mb-0 justify-content-center" id="paginacionHistorial">
                                    <li class="page-item disabled"><a class="page-link" href="#">Anterior</a></li>
                                    <li class="page-item active"><a class="page-link" href="#">1</a></li>
                                    <li class="page-item"><a class="page-link" href="#">Siguiente</a></li>
                                </ul>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- FIN DEL ACORDEÓN -->

    <!-- SELECT2 ASSETS (jQuery + Select2 CSS/JS con tema Bootstrap4) -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/@ttskch/select2-bootstrap4-theme@1.5.2/dist/select2-bootstrap4.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <!-- SCRIPT INLINE PARA BÚSQUEDA Y SELECCIÓN DE MATERIALES -->
    <script>
        (function() {
            console.log('Script inline de movimientos ejecutándose...');

            // Esperar a que jQuery y Select2 estén listos
            function inicializarSelect2() {
                if (typeof $ === 'undefined' || typeof $.fn.select2 === 'undefined') {
                    console.warn('Select2 o jQuery no disponibles, reintentando...');
                    setTimeout(inicializarSelect2, 100);
                    return;
                }

                console.log('jQuery y Select2 disponibles');

                const puntoEcaSection = document.querySelector('section[data-usuario-id]');
                const usuarioId = puntoEcaSection?.dataset.usuarioId;
                const puntoEcaId = puntoEcaSection?.dataset.puntoEcaId;
                const gestor = puntoEcaSection?.dataset.gestor;

                const inputBusqueda = document.getElementById('buscarMaterialMovimientos');
                const btnLimpiar = document.getElementById('btnLimpiarBusquedaMov');
                const modalBusqueda = document.getElementById('buscarMaterialMovimientosModal');
                const resultadosDiv = document.getElementById('resultadosBusquedaMov');
                const estadoDiv = document.getElementById('estadoBusquedaMov');

                console.log('✓ Variables inicializadas - Usuario:', usuarioId, 'PuntoECA:', puntoEcaId, 'Gestor:', gestor);

                // ========================================================
                // INICIALIZAR SELECT2 EN BUSCAR MATERIAL (AJAX)
                // ========================================================
                var $buscarMaterial = $(inputBusqueda);
                if ($buscarMaterial.length) {
                    console.log('Encontrado #buscarMaterialMovimientos');

                    // Obtener endpoint y puntoId
                    var endpoint = '/punto-eca/catalogo/materiales/buscar';
                    var puntoId = puntoEcaId; // Ya está disponible en el data attribute

                    console.log('Endpoint:', endpoint);
                    console.log('PuntoId:', puntoId);

                    $buscarMaterial.select2({
                        theme: 'bootstrap4',
                        width: '100%',
                        placeholder: 'Nombre, código, categoría...',
                        minimumInputLength: 0,
                        allowClear: true,
                        ajax: {
                            url: endpoint,
                            dataType: 'json',
                            delay: 300,
                            data: function(params) {
                                var searchTerm = params.term || '';

                                // Obtener categoría y tipo desde los Select2
                                var categoria = $('#selectCategoriaMov').val() || '';
                                var tipo = $('#selectTipoMov').val() || '';

                                console.log('Buscando:', searchTerm || 'SIN FILTRO - TRAER TODOS');
                                console.log('Categoria:', categoria || 'Sin filtro');
                                console.log('Tipo:', tipo || 'Sin filtro');

                                // Construir objeto de datos para enviar
                                var requestData = {
                                    texto: searchTerm,      // Puede estar vacío
                                    puntoId: puntoId
                                };

                                // Solo agregar categoria si está seleccionada
                                if (categoria) {
                                    requestData.categoria = categoria;
                                }

                                // Solo agregar tipo si está seleccionado
                                if (tipo) {
                                    requestData.tipo = tipo;
                                }

                                console.log('Enviando al backend:', requestData);

                                return requestData;
                            },
                            processResults: function(data, params) {
                                console.log('Respuesta AJAX recibida:', data);

                                // Si la respuesta es un error, mostrar el mensaje
                                if (data.error) {
                                    console.error('Error del backend:', data.mensaje);
                                    return { results: [] };
                                }

                                if (!Array.isArray(data)) {
                                    console.warn('La respuesta no es un array, conviriendo...');
                                    data = [];
                                }

                                console.log('Total de resultados:', data.length);

                                var results = data.map(function(m) {
                                    console.log('Procesando material:', m.nmbMaterial);
                                    return {
                                        id: m.materialId || m.id || '',
                                        text: m.nmbMaterial || m.nombre || 'Material sin nombre',
                                        // Guardar atributos extra en el elemento para acceso en templateResult
                                        element: $('<option>')
                                            .attr('data-imagen', m.imagenUrl || '/imagenes/materiales.png')
                                            .attr('data-tipo', m.nmbTipo || '')
                                            .attr('data-categoria', m.nmbCategoria || '')[0],
                                        data: m
                                    };
                                });

                                return { results: results };
                            },
                            error: function(xhr, status, error) {
                                console.error('Error AJAX:', error);
                                console.error('Status:', status);
                                console.error('Response:', xhr.responseText);
                            },
                            cache: false  // Desabilitar cache para debugging
                        },
                        templateResult: function(data) {
                            if (data.loading) return data.text;
                            if (!data.id) return data.text;

                            // Obtener datos del elemento
                            var imagenUrl = data.element?.getAttribute('data-imagen') || '/imagenes/materiales.png';
                            var nmbTipo = data.element?.getAttribute('data-tipo') || '';
                            var nmbCategoria = data.element?.getAttribute('data-categoria') || '';

                            // Construir elemento HTML con imagen
                            var $state = $(
                                '<span class="select2-state"><img alt="imagen material" class="img-material-select2" style="width: 24px; height: 24px; margin-right: 8px; border-radius: 4px; object-fit: cover;" /> ' +
                                '<span class="state-text"></span>' +
                                '<small class="state-meta" style="margin-left: 4px; color: #999; font-size: 0.85em;"></small></span>'
                            );

                            // Usar .text() para evitar inyecciones
                            $state.find(".state-text").text(data.text || 'Material sin nombre');
                            $state.find("img").attr("src", imagenUrl);

                            // Agregar badges de tipo y categoría si están disponibles
                            if (nmbTipo || nmbCategoria) {
                                var metaText = [];
                                if (nmbTipo) metaText.push(nmbTipo);
                                if (nmbCategoria) metaText.push(nmbCategoria);
                                $state.find(".state-meta").text('(' + metaText.join(' • ') + ')');
                            }

                            return $state;
                        },
                        templateSelection: function(data) {
                            if (!data.id) return data.text;
                            return data.text;
                        }
                    });

                    // Evento al abrir dropdown - Disparar búsqueda automática
                    $buscarMaterial.on('select2:opening', function() {
                        console.log('Abriendo dropdown de materiales');

                        // Esperar a que Select2 renderice el campo de búsqueda
                        setTimeout(function() {
                            var searchInput = $('.select2-search__field');
                            if (searchInput && searchInput.length > 0) {
                                console.log('Campo de búsqueda encontrado');
                                console.log('Disparando búsqueda automática...');
                                searchInput.trigger('input');
                            } else {
                                console.warn('Campo de búsqueda no encontrado');
                            }
                        }, 100);
                    });

                    // Cuando se selecciona un material desde Select2, cargar directamente en formularios
                    $buscarMaterial.on('select2:select', function(e) {
                        try {
                            var data = e.params.data || {};
                            var dto = data.data || data;
                            console.log('select2:select ->', dto);

                            // Si el dto contiene materialId y nmbMaterial, usar esos campos
                            var materialId = dto.materialId || dto.id || data.id || '';
                            var materialNombre = dto.nmbMaterial || dto.text || data.text || '';
                            var materialTipo = dto.nmbTipo || dto.nmbTipo || (dto.nmbTipo) || '';
                            var materialCategoria = dto.nmbCategoria || dto.nmbCategoria || '';
                            var materialDescripcion = dto.dscMaterial || dto.descripcion || '';
                            var unidad = dto.unidadMedida || dto.unidad || '';
                            var stockActual = parseFloat(dto.stockActual || 0) || 0;
                            var capacidadMax = parseFloat(dto.capacidadMaxima || 0) || 0;
                            var precioCompra = parseFloat(dto.precioCompra || 0) || 0;
                            var precioVenta = parseFloat(dto.precioVenta || 0) || 0;

                            // Llenar campos ENTRADA
                            var inputEntrada = document.getElementById('entradaMaterialSeleccionado');
                            var idEntrada = document.getElementById('entradaMaterialId');
                            var tipoEntrada = document.getElementById('entradaMaterialTipo');
                            var categoriaEntrada = document.getElementById('entradaMaterialCategoria');
                            var descripcionEntrada = document.getElementById('entradaMaterialDescripcion');
                            var unidadEntrada = document.getElementById('entradaMaterialUnidad');
                            var stockActualEntrada = document.getElementById('entradaStockActual');
                            var capacidadMaxEntrada = document.getElementById('entradaCapacidadMaxima');
                            var precioCompraEntrada = document.getElementById('entradaPrecioCompra');

                            if (inputEntrada) inputEntrada.value = materialNombre;
                            if (idEntrada) idEntrada.value = materialId;
                            if (tipoEntrada) tipoEntrada.value = materialTipo;
                            if (categoriaEntrada) categoriaEntrada.value = materialCategoria;
                            if (descripcionEntrada) descripcionEntrada.value = materialDescripcion;
                            if (unidadEntrada) unidadEntrada.value = unidad;
                            if (stockActualEntrada) stockActualEntrada.value = stockActual.toFixed(2);
                            if (capacidadMaxEntrada) capacidadMaxEntrada.value = capacidadMax.toFixed(2);
                            if (precioCompraEntrada) precioCompraEntrada.value = precioCompra.toFixed(2);

                            // Llenar campos SALIDA
                            var inputSalida = document.getElementById('salidaMaterialSeleccionado');
                            var idSalida = document.getElementById('salidaMaterialId');
                            var tipoSalida = document.getElementById('salidaMaterialTipo');
                            var categoriaSalida = document.getElementById('salidaMaterialCategoria');
                            var descripcionSalida = document.getElementById('salidaMaterialDescripcion');
                            var unidadSalida = document.getElementById('salidaMaterialUnidad');
                            var stockActualSalida = document.getElementById('salidaStockActual');
                            var capacidadMaxSalida = document.getElementById('salidaCapacidadMaxima');
                            var precioVentaSalida = document.getElementById('salidaPrecioVenta');

                            if (inputSalida) inputSalida.value = materialNombre;
                            if (idSalida) idSalida.value = materialId;
                            if (tipoSalida) tipoSalida.value = materialTipo;
                            if (categoriaSalida) categoriaSalida.value = materialCategoria;
                            if (descripcionSalida) descripcionSalida.value = materialDescripcion;
                            if (unidadSalida) unidadSalida.value = unidad;
                            if (stockActualSalida) stockActualSalida.value = stockActual.toFixed(2);
                            if (capacidadMaxSalida) capacidadMaxSalida.value = capacidadMax.toFixed(2);
                            if (precioVentaSalida) precioVentaSalida.value = precioVenta.toFixed(2);

                            // Mostrar formularios y ocultar sección de búsqueda
                            var formEntradaContainer = document.getElementById('formEntradaContainer');
                            var formSalidaContainer = document.getElementById('formSalidaContainer');
                            if (formEntradaContainer) formEntradaContainer.style.display = 'block';
                            if (formSalidaContainer) formSalidaContainer.style.display = 'block';
                            var seccionBusquedaMaterial = document.getElementById('seccionBusquedaMaterial');
                            if (seccionBusquedaMaterial) seccionBusquedaMaterial.style.display = 'none';

                            // Expandir acordeones correctamente (actualizar aria y clases en botones)
                            var collapseEntradas = document.getElementById('collapseEntradas');
                            var collapseSalidas = document.getElementById('collapseSalidas');
                            if (collapseEntradas) {
                                collapseEntradas.classList.add('show');
                                collapseEntradas.setAttribute('aria-expanded', 'true');
                                var buttonEntradas = document.querySelector('[data-bs-target="#collapseEntradas"]');
                                if (buttonEntradas) buttonEntradas.classList.remove('collapsed');
                            }
                            if (collapseSalidas) {
                                collapseSalidas.classList.add('show');
                                collapseSalidas.setAttribute('aria-expanded', 'true');
                                var buttonSalidas = document.querySelector('[data-bs-target="#collapseSalidas"]');
                                if (buttonSalidas) buttonSalidas.classList.remove('collapsed');
                            }

                            // Disparar eventos input/change en los campos para notificar a cualquier listener
                            function triggerEvents(el) {
                                if (!el) return;
                                try { el.dispatchEvent(new Event('input', { bubbles: true })); } catch(e){}
                                try { el.dispatchEvent(new Event('change', { bubbles: true })); } catch(e){}
                            }
                            triggerEvents(document.getElementById('entradaMaterialSeleccionado'));
                            triggerEvents(document.getElementById('entradaMaterialId'));
                            triggerEvents(document.getElementById('salidaMaterialSeleccionado'));
                            triggerEvents(document.getElementById('salidaMaterialId'));

                            // Hacer scroll suave al formulario para que el usuario lo vea
                            if (formEntradaContainer && typeof formEntradaContainer.scrollIntoView === 'function') {
                                formEntradaContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            }

                        } catch (err) {
                            console.error('Error al procesar selección Select2:', err);
                        }
                    });

                    console.log('Select2 inicializado en #buscarMaterialMovimientos');
                }

                // ========================================================
                // INICIALIZAR SELECT2 EN CATEGORÍA
                // ========================================================
                var $selectCategoria = $('#selectCategoriaMov');
                if ($selectCategoria.length) {
                    console.log('Encontrado #selectCategoriaMov');

                    $selectCategoria.select2({
                        theme: 'bootstrap4',
                        width: '100%',
                        allowClear: true,
                        placeholder: 'Selecciona una categoría...',
                        minimumInputLength: 0
                    });

                    // Al cambiar categoría, disparar búsqueda automática
                    $selectCategoria.on('select2:select', function(e) {
                        var categoria = e.params.data.id;
                        console.log('Categoria seleccionada:', categoria);

                        // Disparar búsqueda automática con la categoría
                        console.log('Disparando búsqueda con filtros:', {
                            texto: '',
                            categoria: categoria,
                            tipo: $('#selectTipoMov').val() || ''
                        });
                        buscarMateriales();
                    });

                    // Al limpiar categoría
                    $selectCategoria.on('select2:unselect', function(e) {
                        console.log('Categoria limpiada');
                    });

                    console.log('Select2 inicializado en #selectCategoriaMov');
                }

                // ========================================================
                // INICIALIZAR SELECT2 EN TIPO
                // ========================================================
                var $selectTipo = $('#selectTipoMov');
                if ($selectTipo.length) {
                    console.log('Encontrado #selectTipoMov');

                    $selectTipo.select2({
                        theme: 'bootstrap4',
                        width: '100%',
                        allowClear: true,
                        placeholder: 'Selecciona un tipo...',
                        minimumInputLength: 0
                    });

                    // Al cambiar tipo, disparar búsqueda automática
                    $selectTipo.on('select2:select', function(e) {
                        var tipo = e.params.data.id;
                        console.log('Tipo seleccionado:', tipo);

                        // Disparar búsqueda automática con el tipo
                        console.log('Disparando búsqueda con filtros:', {
                            texto: '',
                            categoria: $('#selectCategoriaMov').val() || '',
                            tipo: tipo
                        });
                        buscarMateriales();
                    });

                    // Al limpiar tipo
                    $selectTipo.on('select2:unselect', function(e) {
                        console.log('Tipo limpiado');
                    });

                    console.log('Select2 inicializado en #selectTipoMov');
                }

                // Función para buscar materiales
                function buscarMateriales() {
                    const texto = $buscarMaterial?.val() || '';
                    const categoria = $('#selectCategoriaMov').val() || '';
                    const tipo = $('#selectTipoMov').val() || '';

                    console.log('Buscando con:', { texto, categoria, tipo });

                    // Obtener modal
                    var modalBuscarMaterial = document.getElementById('buscarMaterialMovimientosModal');
                    if (!modalBuscarMaterial) {
                        console.error('❌ Modal de búsqueda no encontrado');
                        return;
                    }

                    // Mostrar estado loading
                    var estadoBusquedaEl = document.getElementById('estadoBusquedaMov');
                    if (estadoBusquedaEl) {
                        estadoBusquedaEl.innerHTML = '<div class="d-flex flex-column align-items-center"><div class="spinner-border text-primary mb-3" role="status"></div><p class="mb-0">Buscando materiales...</p></div>';
                    }

                    // Limpiar resultados
                    var listaResultadosEl = document.getElementById('resultadosBusquedaMov');
                    if (listaResultadosEl) {
                        listaResultadosEl.innerHTML = '';
                    }

                    // Abrir modal
                    var modal = new bootstrap.Modal(modalBuscarMaterial);
                    modal.show();

                    // Construir URL con parámetros como en section-materiales.html
                    var endpoint = '/punto-eca/catalogo/materiales/buscar';
                    var params = new URLSearchParams();

                    if (texto) params.append('texto', texto);
                    if (categoria) params.append('categoria', categoria);
                    if (tipo) params.append('tipo', tipo);
                    if (puntoEcaId) params.append('puntoId', puntoEcaId);

                    var url = endpoint + (params.toString() ? ('?' + params.toString()) : '');
                    console.log('Buscando en:', url);

                    fetch(url, { method: 'GET', headers: { 'Accept': 'application/json' } })
                        .then(res => res.json().then(data => ({ status: res.status, ok: res.ok, data: data })))
                        .then(({ status, ok, data }) => {
                            console.log('Respuesta recibida:', data);

                            if (!ok) {
                                var mensajeError = data?.mensaje || data?.message || 'Error desconocido';
                                console.error('❌ Error:', mensajeError);
                                if (estadoBusquedaEl) {
                                    estadoBusquedaEl.innerHTML = '<div class="alert alert-warning mb-0" role="alert"><i class="bi bi-exclamation-triangle me-2"></i>' + mensajeError + '</div>';
                                }
                                return;
                            }

                            if (!Array.isArray(data)) data = [];

                            console.log('Total de resultados:', data.length);

                            // Renderizar resultados en el modal
                            renderResultadosBusquedaMov(data);
                        })
                        .catch(error => {
                            console.error('❌ Error en búsqueda:', error);
                            if (estadoBusquedaEl) {
                                estadoBusquedaEl.innerHTML = '<div class="alert alert-danger mb-0" role="alert"><i class="bi bi-exclamation-octagon me-2"></i>Error de conexión</div>';
                            }
                        });
                }

                // Función para renderizar resultados en el modal
                function renderResultadosBusquedaMov(materiales) {
                    console.log('Renderizando', materiales.length, 'resultados');

                    var listaResultadosEl = document.getElementById('resultadosBusquedaMov');
                    var estadoBusquedaEl = document.getElementById('estadoBusquedaMov');

                    if (!listaResultadosEl) return;

                    listaResultadosEl.innerHTML = '';

                    if (!materiales || materiales.length === 0) {
                        listaResultadosEl.innerHTML = '<div class="list-group-item text-muted text-center py-4">Sin resultados disponibles</div>';
                        if (estadoBusquedaEl) {
                            estadoBusquedaEl.innerHTML = '<i class="bi bi-search display-6 d-block mb-2"></i><p class="mb-0">No se encontraron materiales con estos filtros</p>';
                        }
                        return;
                    }

                    materiales.forEach(material => {
                        var item = document.createElement('button');
                        item.type = 'button';
                        item.className = 'list-group-item list-group-item-action resultado-material-item d-flex align-items-start gap-3';
                        item.dataset.materialId = material.materialId || '';
                        item.dataset.nombre = material.nmbMaterial || '';
                        item.dataset.descripcion = material.dscMaterial || '';
                        item.dataset.tipo = material.nmbTipo || '';
                        item.dataset.categoria = material.nmbCategoria || '';
                        item.dataset.unidad = material.unidadMedida || '';
                        item.dataset.stockActual = material.stockActual || '0';
                        item.dataset.capacidadMaxima = material.capacidadMaxima || '0';
                        item.dataset.precioCompra = material.precioCompra || '0';
                        item.dataset.precioVenta = material.precioVenta || '0';

                        var img = document.createElement('img');
                        img.src = material.imagenUrl || '/imagenes/materiales.png';
                        img.alt = material.nmbMaterial || 'Material';
                        img.className = 'rounded';
                        img.style.width = '64px';
                        img.style.height = '64px';
                        img.style.objectFit = 'cover';
                        img.style.flexShrink = '0';

                        var content = document.createElement('div');
                        content.className = 'flex-grow-1 text-start';

                        var title = document.createElement('div');
                        title.className = 'fw-semibold';
                        title.textContent = material.nmbMaterial || 'Material sin nombre';

                        var desc = document.createElement('small');
                        desc.className = 'text-muted d-block mb-2';
                        desc.textContent = material.dscMaterial || 'Sin descripción';

                        var badges = document.createElement('div');
                        var tipoBadge = document.createElement('span');
                        tipoBadge.className = 'badge bg-primary me-1';
                        tipoBadge.textContent = material.nmbTipo || 'Tipo';
                        var catBadge = document.createElement('span');
                        catBadge.className = 'badge bg-secondary';
                        catBadge.textContent = material.nmbCategoria || 'Categoría';

                        badges.appendChild(tipoBadge);
                        badges.appendChild(catBadge);

                        content.appendChild(title);
                        content.appendChild(desc);
                        content.appendChild(badges);

                        var actionBadge = document.createElement('span');
                        actionBadge.className = 'badge bg-primary rounded-pill align-self-start';
                        actionBadge.textContent = 'Seleccionar';

                        item.appendChild(img);
                        item.appendChild(content);
                        item.appendChild(actionBadge);

                        listaResultadosEl.appendChild(item);
                    });

                    if (estadoBusquedaEl) {
                        estadoBusquedaEl.style.display = 'none';
                    }

                    // Agregar event listeners para seleccionar material
                    document.querySelectorAll('.resultado-material-item').forEach(item => {
                        item.addEventListener('click', function(e) {
                            e.preventDefault();

                            const materialId = this.dataset.materialId;
                            const materialNombre = this.dataset.nombre;
                            const materialTipo = this.dataset.tipo;
                            const materialCategoria = this.dataset.categoria;
                            const materialDescripcion = this.dataset.descripcion;

                            console.log('Material seleccionado:', materialId, '-', materialNombre);

                            // Obtener datos del material
                            const unidad = this.dataset.unidad || 'N/A';
                            const stockActual = parseFloat(this.dataset.stockActual) || 0;
                            const capacidadMax = parseFloat(this.dataset.capacidadMaxima) || 0;
                            const precioCompra = parseFloat(this.dataset.precioCompra) || 0;
                            const precioVenta = parseFloat(this.dataset.precioVenta) || 0;

                            // Llenar campos del formulario de ENTRADA
                            const inputEntrada = document.getElementById('entradaMaterialSeleccionado');
                            const idEntrada = document.getElementById('entradaMaterialId');
                            const tipoEntrada = document.getElementById('entradaMaterialTipo');
                            const categoriaEntrada = document.getElementById('entradaMaterialCategoria');
                            const descripcionEntrada = document.getElementById('entradaMaterialDescripcion');
                            const unidadEntrada = document.getElementById('entradaMaterialUnidad');
                            const stockActualEntrada = document.getElementById('entradaStockActual');
                            const capacidadMaxEntrada = document.getElementById('entradaCapacidadMaxima');
                            const precioCompraEntrada = document.getElementById('entradaPrecioCompra');

                            if (inputEntrada) inputEntrada.value = materialNombre;
                            if (idEntrada) idEntrada.value = materialId;
                            if (tipoEntrada) tipoEntrada.value = materialTipo;
                            if (categoriaEntrada) categoriaEntrada.value = materialCategoria;
                            if (descripcionEntrada) descripcionEntrada.value = materialDescripcion;
                            if (unidadEntrada) unidadEntrada.value = unidad;
                            if (stockActualEntrada) stockActualEntrada.value = stockActual.toFixed(2);
                            if (capacidadMaxEntrada) capacidadMaxEntrada.value = capacidadMax.toFixed(2);
                            if (precioCompraEntrada) precioCompraEntrada.value = precioCompra.toFixed(2);

                            // Llenar campos del formulario de SALIDA
                            const inputSalida = document.getElementById('salidaMaterialSeleccionado');
                            const idSalida = document.getElementById('salidaMaterialId');
                            const tipoSalida = document.getElementById('salidaMaterialTipo');
                            const categoriaSalida = document.getElementById('salidaMaterialCategoria');
                            const descripcionSalida = document.getElementById('salidaMaterialDescripcion');
                            const unidadSalida = document.getElementById('salidaMaterialUnidad');
                            const stockActualSalida = document.getElementById('salidaStockActual');
                            const capacidadMaxSalida = document.getElementById('salidaCapacidadMaxima');
                            const precioVentaSalida = document.getElementById('salidaPrecioVenta');

                            if (inputSalida) inputSalida.value = materialNombre;
                            if (idSalida) idSalida.value = materialId;
                            if (tipoSalida) tipoSalida.value = materialTipo;
                            if (categoriaSalida) categoriaSalida.value = materialCategoria;
                            if (descripcionSalida) descripcionSalida.value = materialDescripcion;
                            if (unidadSalida) unidadSalida.value = unidad;
                            if (stockActualSalida) stockActualSalida.value = stockActual.toFixed(2);
                            if (capacidadMaxSalida) capacidadMaxSalida.value = capacidadMax.toFixed(2);
                            if (precioVentaSalida) precioVentaSalida.value = precioVenta.toFixed(2);

                            // Cerrar modal
                            const modalInstance = bootstrap.Modal.getInstance(document.getElementById('buscarMaterialMovimientosModal'));
                            if (modalInstance) {
                                modalInstance.hide();
                            }

                            // Mostrar formularios y ocultar sección de búsqueda
                            var formEntradaContainer = document.getElementById('formEntradaContainer');
                            var formSalidaContainer = document.getElementById('formSalidaContainer');
                            if (formEntradaContainer) formEntradaContainer.style.display = 'block';
                            if (formSalidaContainer) formSalidaContainer.style.display = 'block';
                            var seccionBusquedaMaterial = document.getElementById('seccionBusquedaMaterial');
                            if (seccionBusquedaMaterial) seccionBusquedaMaterial.style.display = 'none';

                            // Expandir acordeones correctamente (actualizar aria y clases en botones)
                            var collapseEntradas = document.getElementById('collapseEntradas');
                            var collapseSalidas = document.getElementById('collapseSalidas');
                            if (collapseEntradas) {
                                collapseEntradas.classList.add('show');
                                collapseEntradas.setAttribute('aria-expanded', 'true');
                                var buttonEntradas = document.querySelector('[data-bs-target="#collapseEntradas"]');
                                if (buttonEntradas) buttonEntradas.classList.remove('collapsed');
                            }
                            if (collapseSalidas) {
                                collapseSalidas.classList.add('show');
                                collapseSalidas.setAttribute('aria-expanded', 'true');
                                var buttonSalidas = document.querySelector('[data-bs-target="#collapseSalidas"]');
                                if (buttonSalidas) buttonSalidas.classList.remove('collapsed');
                            }

                            // Disparar eventos input/change en los campos para notificar a cualquier listener
                            function triggerEvents(el) {
                                if (!el) return;
                                try { el.dispatchEvent(new Event('input', { bubbles: true })); } catch(e){}
                                try { el.dispatchEvent(new Event('change', { bubbles: true })); } catch(e){}
                            }
                            triggerEvents(document.getElementById('entradaMaterialSeleccionado'));
                            triggerEvents(document.getElementById('entradaMaterialId'));
                            triggerEvents(document.getElementById('salidaMaterialSeleccionado'));
                            triggerEvents(document.getElementById('salidaMaterialId'));

                            // Hacer scroll suave al formulario para que el usuario lo vea
                            if (formEntradaContainer && typeof formEntradaContainer.scrollIntoView === 'function') {
                                formEntradaContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            }

                        });
                    });
                }

                // ========================================================
                // CARGA INICIAL DE DATOS EN TABLAS (ENTRADAS Y SALIDAS)
                // ========================================================
                // Esta sección se ejecuta una vez que el DOM está completamente cargado
                function cargarDatosIniciales() {
                    console.log('Cargando datos iniciales en tablas...');

                    // Datos de entradas (compras) - Inyectados desde Thymeleaf
                    const entradasData = /*[[${entradasIniciales.content}]]*/ [];

                    // Datos de salidas (ventas) - Inyectados desde Thymeleaf
                    const salidasData = /*[[${salidasIniciales.content}]]*/ [];

                    console.log('Entradas cargadas:', entradasData.length, entradasData);
                    console.log('Salidas cargadas:', salidasData.length, salidasData);

                    // Renderizar entradas
                    function renderizarEntradas() {
                        const tbody = document.getElementById('tablasEntradasBody');
                        if (!tbody) {
                            console.warn('No se encontró tbody tablasEntradasBody');
                            return;
                        }

                        if (!entradasData || entradasData.length === 0) {
                            tbody.innerHTML = '<tr class="text-muted text-center"><td colspan="5" class="py-3"><small>Sin registros</small></td></tr>';
                            document.getElementById('badgeEntradasCount').textContent = '0 registros';
                            return;
                        }

                        tbody.innerHTML = entradasData.map(entrada => {
                            const fecha = entrada.fechaCompra ? new Date(entrada.fechaCompra).toLocaleDateString('es-CO') : '-';
                            const cantidad = parseFloat(entrada.cantidad || 0);
                            const precio = parseFloat(entrada.precioCompra || 0);
                            return `
                    <tr>
                        <td class="small">${fecha}</td>
                        <td class="small">${entrada.nombreMaterial || '-'}</td>
                        <td class="text-end small">${cantidad.toLocaleString('es-CO', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                        <td class="text-end small">$${precio.toLocaleString('es-CO', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                        <td class="small">${entrada.observaciones || '-'}</td>
                    </tr>
                `;
                        }).join('');

                        document.getElementById('badgeEntradasCount').textContent = entradasData.length + ' registros';
                        console.log('✅ Tabla de entradas renderizada');
                    }

                    // Renderizar salidas
                    function renderizarSalidas() {
                        const tbody = document.getElementById('tablasSalidasBody');
                        if (!tbody) {
                            console.warn('No se encontró tbody tablasSalidasBody');
                            return;
                        }

                        if (!salidasData || salidasData.length === 0) {
                            tbody.innerHTML = '<tr class="text-muted text-center"><td colspan="5" class="py-3"><small>Sin registros</small></td></tr>';
                            document.getElementById('badgeSalidasCount').textContent = '0 registros';
                            return;
                        }

                        tbody.innerHTML = salidasData.map(salida => {
                            const fecha = salida.fechaVenta ? new Date(salida.fechaVenta).toLocaleDateString('es-CO') : '-';
                            const cantidad = parseFloat(salida.cantidad || 0);
                            const precio = parseFloat(salida.precioVenta || 0);
                            return `
                    <tr>
                        <td class="small">${fecha}</td>
                        <td class="small">${salida.nombreMaterial || '-'}</td>
                        <td class="text-end small">${cantidad.toLocaleString('es-CO', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                        <td class="text-end small">$${precio.toLocaleString('es-CO', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                        <td class="small">${salida.nombreCentroAcopio || '-'}</td>
                    </tr>
                `;
                        }).join('');

                        document.getElementById('badgeSalidasCount').textContent = salidasData.length + ' registros';
                        console.log('✅ Tabla de salidas renderizada');
                    }

                    // Inicializar cuando el DOM esté listo
                    if (document.readyState === 'loading') {
                        document.addEventListener('DOMContentLoaded', function() {
                            console.log('✅ DOM cargado, renderizando...');
                            renderizarEntradas();
                            renderizarSalidas();
                        });
                    } else {
                        console.log('✅ DOM ya cargado, renderizando...');
                        renderizarEntradas();
                        renderizarSalidas();
                    }
                }

                // Intentar cargar datos iniciales
                cargarDatosIniciales();

                // Mostrar estado inicial
                mostrarEstadoBusquedaMov('idle');
                console.log('Script de movimientos inicializado con Select2');
            } // Cierra inicializarSelect2

            // Intentar inicializar al cargar el DOM
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', inicializarSelect2);
            } else {
                inicializarSelect2();
            }
        })();

        // Función global para cambiar el material seleccionado
        window.cambiarMaterial = function() {
            console.log('🔄 Cambiando material...');

            // Limpiar campos del formulario de entrada
            const inputEntrada = document.getElementById('entradaMaterialSeleccionado');
            const idEntrada = document.getElementById('entradaMaterialId');
            const tipoEntrada = document.getElementById('entradaMaterialTipo');
            const categoriaEntrada = document.getElementById('entradaMaterialCategoria');
            const descripcionEntrada = document.getElementById('entradaMaterialDescripcion');

            if (inputEntrada) inputEntrada.value = '';
            if (idEntrada) idEntrada.value = '';
            if (tipoEntrada) tipoEntrada.value = '';
            if (categoriaEntrada) categoriaEntrada.value = '';
            if (descripcionEntrada) descripcionEntrada.value = '';

            // Limpiar campos del formulario de salida
            const inputSalida = document.getElementById('salidaMaterialSeleccionado');
            const idSalida = document.getElementById('salidaMaterialId');
            const tipoSalida = document.getElementById('salidaMaterialTipo');
            const categoriaSalida = document.getElementById('salidaMaterialCategoria');
            const descripcionSalida = document.getElementById('salidaMaterialDescripcion');

            if (inputSalida) inputSalida.value = '';
            if (idSalida) idSalida.value = '';
            if (tipoSalida) tipoSalida.value = '';
            if (categoriaSalida) categoriaSalida.value = '';
            if (descripcionSalida) descripcionSalida.value = '';

            // Limpiar alertas de éxito anterior
            const alertas = document.querySelectorAll('.alert-success');
            alertas.forEach(alerta => alerta.remove());

            // Ocultar formularios de entrada y salida
            const formEntradaContainer = document.getElementById('formEntradaContainer');
            const formSalidaContainer = document.getElementById('formSalidaContainer');
            if (formEntradaContainer) formEntradaContainer.style.display = 'none';
            if (formSalidaContainer) formSalidaContainer.style.display = 'none';

            // Contraer secciones del acordeón
            const collapseEntradas = document.getElementById('collapseEntradas');
            const collapseSalidas = document.getElementById('collapseSalidas');
            if (collapseEntradas) {
                collapseEntradas.classList.remove('show');
                collapseEntradas.setAttribute('aria-expanded', 'false');
                const buttonEntradas = document.querySelector('[data-bs-target="#collapseEntradas"]');
                if (buttonEntradas) buttonEntradas.classList.add('collapsed');
            }
            if (collapseSalidas) {
                collapseSalidas.classList.remove('show');
                collapseSalidas.setAttribute('aria-expanded', 'false');
                const buttonSalidas = document.querySelector('[data-bs-target="#collapseSalidas"]');
                if (buttonSalidas) buttonSalidas.classList.add('collapsed');
            }

            // Mostrar sección de búsqueda nuevamente
            const seccionBusquedaMaterial = document.getElementById('seccionBusquedaMaterial');
            if (seccionBusquedaMaterial) seccionBusquedaMaterial.style.display = 'block';

            // Limpiar búsqueda anterior
            const inputBusqueda = document.getElementById('buscarMaterialMovimientos');
            if (inputBusqueda) {
                $(inputBusqueda).val(null).trigger('change');
            }
            $('#selectCategoriaMov').val('').trigger('change');
            $('#selectTipoMov').val('').trigger('change');

            const resultadosDiv = document.getElementById('resultadosBusquedaMov');
            if (resultadosDiv) resultadosDiv.innerHTML = '';

            console.log('✓ Material cambiado, sección de búsqueda mostrada nuevamente');
        };
    </script>

    <!-- SCRIPT PARA CARGAR DATOS INICIALES DE ENTRADAS Y SALIDAS -->
    <script th:inline="javascript">
        (function() {
            console.log('Inicializando carga de datos de movimientos...');

            // Datos de entradas (compras) - Inyectados desde Thymeleaf
            const entradasData = /*[[${entradasIniciales.content}]]*/ [];

            // Datos de salidas (ventas) - Inyectados desde Thymeleaf
            const salidasData = /*[[${salidasIniciales.content}]]*/ [];

            console.log('Entradas cargadas:', entradasData.length, entradasData);
            console.log('Salidas cargadas:', salidasData.length, salidasData);

            // Renderizar entradas
            function renderizarEntradas() {
                const tbody = document.getElementById('tablasEntradasBody');
                if (!tbody) {
                    console.warn('No se encontró tbody tablasEntradasBody');
                    return;
                }

                if (!entradasData || entradasData.length === 0) {
                    tbody.innerHTML = '<tr class="text-muted text-center"><td colspan="5" class="py-3"><small>Sin registros</small></td></tr>';
                    document.getElementById('badgeEntradasCount').textContent = '0 registros';
                    return;
                }

                tbody.innerHTML = entradasData.map(entrada => {
                    const fecha = entrada.fechaCompra ? new Date(entrada.fechaCompra).toLocaleDateString('es-CO') : '-';
                    const cantidad = parseFloat(entrada.cantidad || 0);
                    const precio = parseFloat(entrada.precioCompra || 0);
                    return `
                    <tr>
                        <td class="small">${fecha}</td>
                        <td class="small">${entrada.nombreMaterial || '-'}</td>
                        <td class="text-end small">${cantidad.toLocaleString('es-CO', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                        <td class="text-end small">$${precio.toLocaleString('es-CO', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                        <td class="small">${entrada.observaciones || '-'}</td>
                    </tr>
                `;
                }).join('');

                document.getElementById('badgeEntradasCount').textContent = entradasData.length + ' registros';
                console.log('✅ Tabla de entradas renderizada');
            }

            // Renderizar salidas
            function renderizarSalidas() {
                const tbody = document.getElementById('tablasSalidasBody');
                if (!tbody) {
                    console.warn('No se encontró tbody tablasSalidasBody');
                    return;
                }

                if (!salidasData || salidasData.length === 0) {
                    tbody.innerHTML = '<tr class="text-muted text-center"><td colspan="5" class="py-3"><small>Sin registros</small></td></tr>';
                    document.getElementById('badgeSalidasCount').textContent = '0 registros';
                    return;
                }

                tbody.innerHTML = salidasData.map(salida => {
                    const fecha = salida.fechaVenta ? new Date(salida.fechaVenta).toLocaleDateString('es-CO') : '-';
                    const cantidad = parseFloat(salida.cantidad || 0);
                    const precio = parseFloat(salida.precioVenta || 0);
                    return `
                    <tr>
                        <td class="small">${fecha}</td>
                        <td class="small">${salida.nombreMaterial || '-'}</td>
                        <td class="text-end small">${cantidad.toLocaleString('es-CO', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                        <td class="text-end small">$${precio.toLocaleString('es-CO', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                        <td class="small">${salida.nombreCentroAcopio || '-'}</td>
                    </tr>
                `;
                }).join('');

                document.getElementById('badgeSalidasCount').textContent = salidasData.length + ' registros';
                console.log('✅ Tabla de salidas renderizada');
            }

            // Inicializar cuando el DOM esté completamente cargado
            document.addEventListener('DOMContentLoaded', function() {
                console.log('✅ DOM cargado, renderizando...');
                renderizarEntradas();
                renderizarSalidas();
            });
        })();
    </script>
</section>
