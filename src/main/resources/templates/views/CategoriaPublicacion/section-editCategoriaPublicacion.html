<!-- Editar Categoría de Publicación -->
<section th:fragment="edit" class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <!-- Header -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-body bg-primary text-white p-3">
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb mb-0">
                            <li class="breadcrumb-item">
                                <a th:href="@{/categoria-publicacion/index}" class="text-white">Inicio</a>
                            </li>
                            <li class="breadcrumb-item">
                                <a th:href="@{/categoria-publicacion/list}" class="text-white">Listado</a>
                            </li>
                            <li class="breadcrumb-item active text-white" aria-current="page">Editar Categoría</li>
                        </ol>
                    </nav>
                    <h3 class="mb-0 mt-2"><i class="bi bi-pencil-square me-2"></i>Editar Categoría</h3>
                </div>
            </div>

            <!-- Formulario de edición -->
            <div class="row">
                <div class="col-lg-8">
                    <div class="card border-0 shadow-sm">
                        <div class="card-body">
                            <form th:action="@{/categoria-publicacion/update/{id}(id=${categoria.id})}" method="POST" th:object="${categoriaRequestDTO}"
                                  class="needs-validation" novalidate>
                                <input type="hidden" name="_method" value="PUT">

                                <!-- Nombre -->
                                <div class="mb-4">
                                    <label for="nombre" class="form-label fw-bold">
                                        <i class="bi bi-card-heading me-1 text-primary"></i>Nombre de la categoría *
                                    </label>
                                    <input type="text" class="form-control form-control-lg"
                                           id="nombre" name="nombre"
                                           th:field="*{nombre}"
                                           th:value="${categoria.nombre}"
                                           required
                                           minlength="2"
                                           maxlength="100">
                                    <div class="form-text text-muted">
                                        El nombre debe tener entre 2 y 100 caracteres.
                                    </div>
                                    <div class="invalid-feedback">
                                        Por favor ingresa un nombre válido.
                                    </div>
                                </div>

                                <!-- Descripción -->
                                <div class="mb-4">
                                    <label for="descripcion" class="form-label fw-bold">
                                        <i class="bi bi-text-paragraph me-1 text-primary"></i>Descripción *
                                    </label>
                                    <textarea class="form-control" id="descripcion" name="descripcion"
                                              th:field="*{descripcion}"
                                              th:text="${categoria.descripcion}"
                                              rows="4"
                                              maxlength="500"
                                              required></textarea>
                                    <div class="form-text text-muted d-flex justify-content-between">
                                        <span>Máximo 500 caracteres</span>
                                        <span id="contadorDescripcion">500 caracteres restantes</span>
                                    </div>
                                    <div class="invalid-feedback">
                                        Por favor ingresa una descripción válida.
                                    </div>
                                </div>

                                <!-- Icono y Color -->
                                <div class="row mb-4">
                                    <div class="col-md-6">
                                        <label for="icono" class="form-label fw-bold">
                                            <i class="bi bi-emoji-smile me-1 text-primary"></i>Icono (opcional)
                                        </label>
                                        <div class="input-group">
                                            <span class="input-group-text">
                                                <i class="bi bi-emoji-smile"></i>
                                            </span>
                                            <input type="text" class="form-control" id="icono" name="icono"
                                                   th:field="*{icono}"
                                                   th:value="${categoria.icono}"
                                                   maxlength="50">
                                        </div>
                                        <div class="form-text text-muted">
                                            Nombre de clase Bootstrap Icons (máx. 50 caracteres).
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="color" class="form-label fw-bold">
                                            <i class="bi bi-palette me-1 text-primary"></i>Color (opcional)
                                        </label>
                                        <div class="input-group">
                                            <input type="color" class="form-control form-control-color" id="colorPicker"
                                                   th:attr="value=${categoria.color != null ? categoria.color : '#28a745'}"
                                                   title="Elige un color">
                                            <input type="text" class="form-control" id="color" name="color"
                                                   th:field="*{color}"
                                                   th:value="${categoria.color}"
                                                   maxlength="20">
                                        </div>
                                        <div class="form-text text-muted">
                                            Código hexadecimal o nombre CSS (máx. 20 caracteres).
                                        </div>
                                    </div>
                                </div>

                                <!-- Estado y Orden -->
                                <div class="row mb-4">
                                    <div class="col-md-6">
                                        <label for="estadoCategoria" class="form-label fw-bold">
                                            <i class="bi bi-toggle-on me-1 text-primary"></i>Estado *
                                        </label>
                                        <select class="form-select" id="estadoCategoria" name="estadoCategoria"
                                                th:field="*{estadoCategoria}"
                                                th:value="${categoria.estadoCategoria}"
                                                required>
                                            <option value="">Selecciona un estado...</option>
                                            <option th:each="estado : ${T(org.sena.inforecicla.model.enums.EstadoPublicacion).values()}"
                                                    th:value="${estado}"
                                                    th:selected="${categoria.estadoCategoria == estado}"
                                                    th:text="${estado.name()}">
                                            </option>
                                        </select>
                                        <div class="invalid-feedback">
                                            Por favor selecciona un estado.
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="orden" class="form-label fw-bold">
                                            <i class="bi bi-sort-numeric-down me-1 text-primary"></i>Orden (opcional)
                                        </label>
                                        <input type="number" class="form-control" id="orden" name="orden"
                                               th:field="*{orden}"
                                               th:value="${categoria.orden}"
                                               min="0"
                                               max="999">
                                        <div class="form-text text-muted">
                                            Número para ordenar las categorías (0-999).
                                        </div>
                                    </div>
                                </div>

                                <!-- Información adicional -->
                                <div class="card bg-light border-0 mb-4">
                                    <div class="card-body">
                                        <h6 class="fw-bold mb-3"><i class="bi bi-info-circle me-2"></i>Información del registro</h6>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <small class="text-muted">Creado el:</small>
                                                <p class="mb-0 fw-semibold" th:text="${#dates.format(categoria.createdAt, 'dd/MM/yyyy HH:mm')}">--</p>
                                            </div>
                                            <div class="col-md-6">
                                                <small class="text-muted">Última actualización:</small>
                                                <p class="mb-0 fw-semibold" th:text="${#dates.format(categoria.updatedAt, 'dd/MM/yyyy HH:mm')}">--</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Botones de acción -->
                                <div class="d-flex gap-3 mt-5 pt-3 border-top">
                                    <button type="submit" class="btn btn-primary btn-lg px-4">
                                        <i class="bi bi-check-circle me-2"></i>Guardar Cambios
                                    </button>
                                    <a th:href="@{/categoria-publicacion/show/{id}(id=${categoria.id})}" class="btn btn-outline-info btn-lg px-4">
                                        <i class="bi bi-eye me-2"></i>Ver Detalles
                                    </a>
                                    <a th:href="@{/categoria-publicacion/list}" class="btn btn-outline-secondary btn-lg px-4">
                                        <i class="bi bi-x-circle me-2"></i>Cancelar
                                    </a>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Vista previa y acciones -->
                <div class="col-lg-4">
                    <!-- Vista previa -->
                    <div class="card border-0 shadow-sm mb-4">
                        <div class="card-header bg-light">
                            <h5 class="mb-0"><i class="bi bi-eye me-2"></i>Vista previa</h5>
                        </div>
                        <div class="card-body">
                            <div class="text-center mb-4">
                                <div id="previewIcono" class="d-inline-block p-4 rounded-circle mb-3"
                                     th:style="'background-color: ' + (${categoria.color != null} ? ${categoria.color} : '#28a745')">
                                    <i id="previewIconoIcon"
                                       th:class="'bi ' + (${categoria.icono != null} ? ${categoria.icono} : 'bi-tag') + ' text-white fs-1'"></i>
                                </div>
                                <h4 id="previewNombre" th:text="${categoria.nombre}">Nombre</h4>
                                <div class="mb-3">
                                    <span id="previewEstado" class="badge me-2"
                                          th:class="${categoria.estadoCategoria == 'ACTIVO'} ? 'bg-success' : 'bg-danger'"
                                          th:text="${categoria.estadoCategoria}">ESTADO</span>
                                    <span id="previewOrden" class="badge bg-secondary"
                                          th:text="'Orden: ' + (${categoria.orden != null} ? ${categoria.orden} : '0')">Orden: 0</span>
                                </div>
                            </div>

                            <div class="mb-4">
                                <h6 class="fw-bold text-muted mb-2">Descripción</h6>
                                <p id="previewDescripcion" th:text="${categoria.descripcion}" class="mb-0 text-muted">Descripción</p>
                            </div>
                        </div>
                    </div>

                    <!-- Acciones rápidas -->
                    <div class="card border-0 shadow-sm">
                        <div class="card-header bg-light">
                            <h5 class="mb-0"><i class="bi bi-lightning-charge me-2"></i>Acciones rápidas</h5>
                        </div>
                        <div class="card-body">
                            <div class="d-grid gap-2">
                                <a th:href="@{/categoria-publicacion/show/{id}(id=${categoria.id})}"
                                   class="btn btn-outline-info">
                                    <i class="bi bi-eye me-2"></i>Ver detalles completos
                                </a>
                                <button type="button" class="btn btn-outline-warning" id="btnDuplicarCategoria">
                                    <i class="bi bi-copy me-2"></i>Duplicar categoría
                                </button>
                                <button type="button" class="btn btn-outline-danger"
                                        data-bs-toggle="modal"
                                        data-bs-target="#modalEliminarCategoria">
                                    <i class="bi bi-trash me-2"></i>Eliminar categoría
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Modal: Confirmar eliminación -->
<div class="modal fade" id="modalEliminarCategoria" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title"><i class="bi bi-exclamation-triangle me-2"></i>Confirmar eliminación</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>¿Estás seguro de que deseas eliminar esta categoría?</p>
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-circle me-2"></i>
                    <strong>Advertencia:</strong> Esta acción no se puede deshacer.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                <form th:action="@{/categoria-publicacion/delete/{id}(id=${categoria.id})}" method="POST">
                    <input type="hidden" name="_method" value="DELETE">
                    <button type="submit" class="btn btn-danger">
                        <i class="bi bi-trash me-1"></i>Eliminar
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // ===== PREVIEW EN TIEMPO REAL =====
        const nombreInput = document.getElementById('nombre');
        const descripcionInput = document.getElementById('descripcion');
        const iconoInput = document.getElementById('icono');
        const colorInput = document.getElementById('color');
        const colorPicker = document.getElementById('colorPicker');
        const estadoSelect = document.getElementById('estadoCategoria');
        const ordenInput = document.getElementById('orden');

        const previewNombre = document.getElementById('previewNombre');
        const previewDescripcion = document.getElementById('previewDescripcion');
        const previewIcono = document.getElementById('previewIcono');
        const previewIconoIcon = document.getElementById('previewIconoIcon');
        const previewEstado = document.getElementById('previewEstado');
        const previewOrden = document.getElementById('previewOrden');

        // Contador de caracteres para descripción
        const contadorDescripcion = document.getElementById('contadorDescripcion');

        function actualizarPreview() {
            // Nombre
            if (nombreInput.value.trim()) {
                previewNombre.textContent = nombreInput.value;
            }

            // Descripción
            if (descripcionInput.value.trim()) {
                previewDescripcion.textContent = descripcionInput.value;
                // Actualizar contador
                const caracteresRestantes = 500 - descripcionInput.value.length;
                contadorDescripcion.textContent = `${caracteresRestantes} caracteres restantes`;
                contadorDescripcion.className = caracteresRestantes < 0 ? 'text-danger' : 'text-muted';
            }

            // Icono
            if (iconoInput.value.trim()) {
                previewIconoIcon.className = `${iconoInput.value} text-white fs-1`;
            }

            // Color
            let color = colorInput.value.trim();
            if (!color && colorPicker.value) {
                color = colorPicker.value;
            }
            if (color) {
                previewIcono.style.backgroundColor = color;
            }

            // Estado
            if (estadoSelect.value) {
                previewEstado.textContent = estadoSelect.value.toUpperCase();
                if (estadoSelect.value === 'ACTIVO') {
                    previewEstado.className = 'badge bg-success me-2';
                } else if (estadoSelect.value === 'INACTIVO') {
                    previewEstado.className = 'badge bg-danger me-2';
                }
            }

            // Orden
            if (ordenInput.value) {
                previewOrden.textContent = `Orden: ${ordenInput.value}`;
            }
        }

        // Event listeners para actualizar preview
        [nombreInput, descripcionInput, iconoInput, colorInput, estadoSelect, ordenInput].forEach(input => {
            if (input) {
                input.addEventListener('input', actualizarPreview);
                input.addEventListener('change', actualizarPreview);
            }
        });

        if (colorPicker) {
            colorPicker.addEventListener('input', function() {
                colorInput.value = colorPicker.value;
                actualizarPreview();
            });
        }

        // Sincronizar color picker con input de texto
        colorInput.addEventListener('input', function() {
            if (colorInput.value.match(/^#[0-9A-F]{6}$/i)) {
                colorPicker.value = colorInput.value;
            }
        });

        // ===== DUPLICAR CATEGORÍA =====
        const btnDuplicar = document.getElementById('btnDuplicarCategoria');
        if (btnDuplicar) {
            btnDuplicar.addEventListener('click', function() {
                if (confirm('¿Deseas duplicar esta categoría? Se creará una nueva con la misma información.')) {
                    // Aquí iría la lógica para duplicar
                    window.location.href = `/categoria-publicacion/duplicate/${categoriaId}`;
                }
            });
        }

        // ===== VALIDACIÓN DE FORMULARIO =====
        const form = document.querySelector('form.needs-validation');
        if (form) {
            form.addEventListener('submit', function(event) {
                if (!form.checkValidity()) {
                    event.preventDefault();
                    event.stopPropagation();
                }
                form.classList.add('was-validated');
            });
        }

        // Inicializar contador de caracteres
        if (descripcionInput) {
            const caracteresRestantes = 500 - descripcionInput.value.length;
            contadorDescripcion.textContent = `${caracteresRestantes} caracteres restantes`;
            contadorDescripcion.className = caracteresRestantes < 0 ? 'text-danger' : 'text-muted';
        }
    });
</script>